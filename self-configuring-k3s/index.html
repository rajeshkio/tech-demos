<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Configuring Infrastructure Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .feature-flags {
            margin-bottom: 20px;
        }
        
        .feature-flags h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .feature-toggle:hover {
            border-color: #cbd5e0;
        }
        
        .feature-toggle.active {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .feature-info .name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .feature-info .desc {
            font-size: 12px;
            color: #718096;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats {
            margin-left: auto;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .usage-stats {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 13px;
            color: #4a5568;
        }
        
        .usage-stats .highlight {
            font-weight: 600;
            color: #2d3748;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 500px;
        }
        
        .steps-panel {
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .terminal-panel {
            background: #1a202c;
            padding: 25px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            max-height: 500px; /* Fixed height to match steps panel */
        }
        
        .terminal-header {
            margin-bottom: 15px;
            color: #a0aec0;
            flex-shrink: 0; /* Don't shrink the header */
        }
        
        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            /* Custom scrollbar styling */
        }
        
        .terminal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .terminal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step.running {
            border-color: #667eea;
            background: #edf2f7;
            animation: pulse 2s infinite;
        }
        
        .step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 14px;
            color: #666;
        }
        
        .terminal-line {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        
        .text-green { color: #68d391; }
        .text-blue { color: #63b3ed; }
        .text-yellow { color: #f6e05e; }
        .text-cyan { color: #76e4f7; }
        .text-gray { color: #a0aec0; }
        
        .progress {
            padding: 20px;
            background: #f7fafc;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #48bb78 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Self-Configuring Infrastructure Demo</h1>
            <p>Experience runtime discovery and automatic dependency resolution!</p>
        </div>
        
        <div class="controls">
            <div class="feature-flags">
                <h3>üéõÔ∏è Feature Flags (Choose Your Adventure)</h3>
                <div class="feature-grid">
                    <div id="feature-loadbalancer" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚öñÔ∏è Load Balancer</div>
                            <div class="desc">HAProxy with dynamic backends</div>
                        </div>
                    </div>
                    <div id="feature-k3s" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚ò∏Ô∏è K3s Cluster</div>
                            <div class="desc">HA Kubernetes cluster</div>
                        </div>
                    </div>
                    <div id="feature-harvester" class="feature-toggle">
                        <input type="checkbox">
                        <div class="feature-info">
                            <div class="name">üåæ Harvester HCI</div>
                            <div class="desc">iPXE network boot (45+ min)</div>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #718096; margin: 0;">
                    üí° Toggle features to see different deployment scenarios. Infrastructure adapts automatically!
                </p>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="control-buttons">
                    <button id="deployBtn" class="btn btn-primary">‚ñ∂Ô∏è Deploy Infrastructure</button>
                    <button id="resetBtn" class="btn btn-secondary">üîÑ Reset</button>
                </div>
                
                <div class="stats">
                    <span>üñ•Ô∏è <span id="vmCount">4 VMs</span></span>
                    <span>üíª <span id="actionCount">6 Actions</span></span>
                    <span>üöÄ <span id="deployCount">0 Deployments</span></span>
                    <span>‚ö° <span id="timer">0s</span></span>
                    <span id="status">Ready</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="steps-panel">
                <h3>Deployment Steps</h3>
                <div id="stepsList">
                    <!-- Steps will be populated here -->
                </div>
            </div>
            
            <div class="terminal-panel">
                <div class="terminal-header">
                    üñ•Ô∏è pulumi-deployment-terminal
                </div>
                <div class="terminal-content" id="terminal">
                    <div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>
                </div>
            </div>
        </div>
        
        <div class="progress">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Progress</span>
                <span id="progressText">0 of 6 steps</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="usage-stats">
            <span id="connectionStatus">üîÑ Connecting to global stats...</span> ‚Ä¢
            <span class="highlight" id="totalDeployments">0</span> total deployments 
            ‚Ä¢ <span class="highlight" id="sessionsToday">0</span> sessions today 
            ‚Ä¢ Last deployment: <span class="highlight" id="lastDeployment">Never</span>
        </div>
    </div>

    <script>
        // Demo state
        let isRunning = false;
        let currentStep = 0;
        let startTime = 0;
        let timer = null;
        let sessionDeployments = 0;
        
        // Global stats tracking via secure Netlify function
        let usageStats = {
            totalDeployments: 0,
            deploymentsToday: 0,
            lastDeployment: null
        };
        
        // Feature flags
        let features = {
            loadbalancer: true,
            k3s: true,
            harvester: false
        };
        
        // Auto-detect Netlify function endpoint
        const isNetlify = window.location.hostname.includes('netlify.app');
        const API_BASE = isNetlify 
            ? `${window.location.origin}/.netlify/functions`
            : 'https://your-site.netlify.app/.netlify/functions';
        
        const allSteps = [
            {
                id: 'env-setup',
                title: "üõ†Ô∏è Environment Setup",
                desc: "Setting up Pulumi and Proxmox connection",
                output: [
                    "Setting environment variables...",
                    "PROXMOX_VE_ENDPOINT=https://192.168.90.102:8006/",
                    "SSH_PUBLIC_KEY loaded from ~/.ssh/id_ed25519.pub",
                    "Initializing Pulumi stack...",
                    "‚úÖ Environment ready for deployment!"
                ],
                requires: []
            },
            {
                id: 'config-validation',
                title: "üìã Configuration Validation", 
                desc: "Validating templates and building dependency map",
                output: [
                    "Loading Pulumi.dev.yaml configuration...",
                    "Validating VM templates...",
                    "Checking feature flags...",
                    "  ‚úÖ loadbalancer: enabled",
                    "  ‚úÖ k3s: enabled", 
                    "  ‚ö™ harvester: disabled",
                    "Building global dependency map...",
                    "‚úÖ Configuration valid, proceeding!"
                ],
                requires: []
            },
            {
                id: 'vm-creation',
                title: "üñ•Ô∏è VM Creation & Role Grouping",
                desc: "Creating VMs and organizing by infrastructure role",
                output: [
                    "Creating VMs from templates...",
                    "Creating VM: loadbalancer-0 (192.168.90.190)",
                    "  Template: ubuntu-22.04-template",
                    "  Role: loadbalancer",
                    "Creating VM: k3s-server-0 (192.168.90.187)",
                    "Creating VM: k3s-server-1 (192.168.90.188)",
                    "Creating VM: k3s-server-2 (192.168.90.189)",
                    "  Template: sle-micro-template", 
                    "  Role: k3s-server",
                    "üîÑ Organizing VMs by role...",
                    "‚úÖ All VMs created and grouped!"
                ],
                requires: []
            },
            {
                id: 'dependency-resolution',
                title: "üîó Global Dependency Resolution",
                desc: "Building runtime discovery map for service coordination",
                output: [
                    "üîç Building global dependency map...",
                    "Scanning role groups for discoverable resources...",
                    "üìä Global Dependencies Available:",
                    "  loadbalancer-ips: [\"192.168.90.190\"]",
                    "  k3s-server-ips: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üéØ Action Execution Plan:",
                    "  1. install-haproxy (depends on: k3s-server-ips)",
                    "  2. install-k3s-server (depends on: loadbalancer)",
                    "‚úÖ Dependencies resolved - ready for execution!"
                ],
                requires: []
            },
            {
                id: 'loadbalancer-setup',
                title: "‚öñÔ∏è HAProxy Load Balancer",
                desc: "Installing HAProxy with dynamic backend discovery",
                output: [
                    "üéØ Executing action: install-haproxy",
                    "üîç Runtime Discovery: Finding k3s-server IPs...",
                    "  Discovered: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üì¶ Installing HAProxy on 192.168.90.190...",
                    "sudo apt update && sudo apt install -y haproxy",
                    "üîß Generating dynamic HAProxy configuration:",
                    "backend k3s-servers",
                    "    server k3s-server-1 192.168.90.187:6443 check",
                    "    server k3s-server-2 192.168.90.188:6443 check", 
                    "    server k3s-server-3 192.168.90.189:6443 check",
                    "sudo systemctl enable --now haproxy",
                    "‚úÖ HAProxy running and ready for K3s traffic!"
                ],
                requires: ['loadbalancer']
            },
            {
                id: 'k3s-cluster',
                title: "‚ò∏Ô∏è K3s High-Availability Cluster",
                desc: "Deploying K3s servers with automatic cluster formation",
                output: [
                    "üéØ Executing action: install-k3s-server",
                    "üîç Runtime Discovery: Finding loadbalancer IP...",
                    "  Discovered LB: 192.168.90.190",
                    "üöÄ Installing K3s on server 1: 192.168.90.187",
                    "curl -sfL https://get.k3s.io | sudo sh -s - server \\",
                    "  --cluster-init \\",
                    "  --tls-san=192.168.90.190",
                    "‚è≥ Waiting for cluster initialization...",
                    "üöÄ Installing K3s on server 2: 192.168.90.188",
                    "üöÄ Installing K3s on server 3: 192.168.90.189",
                    "  Joining cluster through load balancer: 192.168.90.190",
                    "‚úÖ 3-node HA K3s cluster formed automatically!"
                ],
                requires: ['k3s']
            },
            {
                id: 'kubeconfig-extraction',
                title: "üìã Kubeconfig & Verification",
                desc: "Extracting kubeconfig and verifying cluster health",
                output: [
                    "üéØ Executing action: get-kubeconfig",
                    "üîç Runtime Discovery: Finding first k3s server...",
                    "  Discovered: 192.168.90.187",
                    "üìã Extracting kubeconfig from k3s-server-0...",
                    "scp root@192.168.90.187:/etc/rancher/k3s/k3s.yaml ./kubeconfig",
                    "üîç Verifying cluster through load balancer...",
                    "kubectl --kubeconfig=kubeconfig get nodes",
                    "NAME           STATUS   ROLES                  AGE",
                    "k3s-server-0   Ready    control-plane,master   2m",
                    "k3s-server-1   Ready    control-plane,master   1m", 
                    "k3s-server-2   Ready    control-plane,master   1m",
                    "‚úÖ All nodes healthy, cluster ready for workloads!"
                ],
                requires: ['k3s']
            },
            {
                id: 'harvester-deploy',
                title: "üåæ Harvester HCI Platform",
                desc: "Deploying Harvester with iPXE network boot (45+ min)",
                output: [
                    "üéØ Executing action: install-harvester-hci",
                    "‚ö†Ô∏è  WARNING: This is a 45+ minute operation!",
                    "üîç Runtime Discovery: Finding available nodes...",
                    "  Discovered nodes: 3 available for Harvester",
                    "üì° Setting up iPXE network boot infrastructure...",
                    "Configuring DHCP server with iPXE boot options...",
                    "Preparing Harvester ISO for network deployment...",
                    "üöÄ Initiating network boot sequence:",
                    "  Node 1 (192.168.90.200): iPXE boot started",
                    "  Node 2 (192.168.90.201): iPXE boot started",
                    "  Node 3 (192.168.90.202): iPXE boot started",
                    "‚è≥ Installing Harvester OS (this will take 45+ minutes)...",
                    "üìä Progress: Installing base system...",
                    "üìä Progress: Configuring storage pools...",
                    "üìä Progress: Setting up Harvester management cluster...",
                    "‚úÖ Harvester HCI platform deployed successfully!",
                    "üåê Management UI: https://192.168.90.200:8443",
                    "‚ò∏Ô∏è Embedded K8s cluster ready for VM workloads"
                ],
                requires: ['harvester']
            }
        ];
        
        // Secure API functions
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global stats loaded securely via Netlify function');
                return true;
            } catch (error) {
                console.log('üì± Secure API unavailable, using localStorage fallback');
                loadLocalStats();
                return false;
            }
        }
        
        async function incrementStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global deployment count updated securely!');
                return true;
            } catch (error) {
                console.log('üì± Secure API failed, using local increment');
                incrementLocalStats();
                return false;
            }
        }
        
        function loadLocalStats() {
            const stored = localStorage.getItem('demoUsageStats');
            if (stored) {
                usageStats = JSON.parse(stored);
                if (usageStats.lastDeployment) {
                    usageStats.lastDeployment = new Date(usageStats.lastDeployment);
                }
            } else {
                usageStats = {
                    totalDeployments: 0,
                    deploymentsToday: 0,
                    lastDeployment: null
                };
            }
            updateUsageDisplay();
        }
        
        function incrementLocalStats() {
            usageStats.totalDeployments++;
            usageStats.deploymentsToday++;
            usageStats.lastDeployment = new Date();
            localStorage.setItem('demoUsageStats', JSON.stringify(usageStats));
            updateUsageDisplay();
        }
        
        function updateUsageDisplay() {
            document.getElementById('totalDeployments').textContent = usageStats.totalDeployments.toLocaleString();
            document.getElementById('sessionsToday').textContent = usageStats.deploymentsToday;
            
            // Update connection status
            const connectionStatus = document.getElementById('connectionStatus');
            if (API_BASE.includes('netlify')) {
                connectionStatus.innerHTML = 'üîí <strong>Secure Global Stats</strong>';
                connectionStatus.style.color = '#48bb78';
            } else {
                connectionStatus.innerHTML = 'üì± <strong>Local Mode</strong>';
                connectionStatus.style.color = '#f6e05e';
            }
            
            if (usageStats.lastDeployment) {
                const lastTime = usageStats.lastDeployment;
                const now = new Date();
                const diffMinutes = Math.floor((now - lastTime) / 60000);
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Just now';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes}m ago`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)}h ago`;
                } else {
                    timeText = lastTime.toLocaleDateString();
                }
                
                document.getElementById('lastDeployment').textContent = timeText;
            } else {
                document.getElementById('lastDeployment').textContent = 'Never';
            }
            
            document.getElementById('deployCount').textContent = sessionDeployments + ' Session';
        }
        
        function getActiveSteps() {
            return allSteps.filter(step => {
                if (step.requires.length === 0) return true;
                return step.requires.some(req => features[req]);
            });
        }
        
        function updateStats() {
            const activeSteps = getActiveSteps();
            let vmCount = 0;
            
            if (features.loadbalancer) vmCount += 1;
            if (features.k3s) vmCount += 3;
            if (features.harvester) vmCount += 3;
            
            document.getElementById('vmCount').textContent = vmCount + ' VMs';
            document.getElementById('actionCount').textContent = activeSteps.length + ' Actions';
        }
        
        function setupFeatureToggles() {
            ['loadbalancer', 'k3s', 'harvester'].forEach(feature => {
                const toggle = document.getElementById(`feature-${feature}`);
                const checkbox = toggle.querySelector('input');
                
                toggle.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    features[feature] = checkbox.checked;
                    toggle.classList.toggle('active', checkbox.checked);
                    
                    if (!isRunning) {
                        updateStats();
                        renderSteps();
                        updateProgress();
                    }
                });
            });
        }
        
        function updateTimer() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed + 's';
            }
        }
        
        function addTerminalLine(text, className = 'text-gray') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            terminal.appendChild(line);
            
            // Auto-scroll to bottom, but smoothly
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function updateProgress() {
            const activeSteps = getActiveSteps();
            const total = activeSteps.length;
            const completed = currentStep;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} steps`;
        }
        
        function renderSteps() {
            const activeSteps = getActiveSteps();
            const stepsList = document.getElementById('stepsList');
            
            stepsList.innerHTML = activeSteps.map((step, index) => {
                let className = '';
                let icon = '‚è≥';
                
                if (index < currentStep) {
                    className = 'completed';
                    icon = '‚úÖ';
                } else if (index === currentStep && isRunning) {
                    className = 'running';
                    icon = 'üîÑ';
                }
                
                return `
                    <div class="step ${className}">
                        <div class="step-title">${icon} ${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function runStep(stepIndex) {
            const activeSteps = getActiveSteps();
            const step = activeSteps[stepIndex];
            
            addTerminalLine(`üéØ Step ${stepIndex + 1}/${activeSteps.length}: ${step.title}`, 'text-yellow');
            addTerminalLine('', 'text-gray');
            
            for (const line of step.output) {
                await new Promise(resolve => setTimeout(resolve, step.id === 'harvester-deploy' ? 200 : 300));
                
                const className = line.includes('‚úÖ') ? 'text-green' :
                                line.includes('‚ö†Ô∏è') || line.includes('WARNING') ? 'text-yellow' :
                                line.includes('üîç') || line.includes('üìä') || line.includes('üéØ') ? 'text-blue' :
                                line.includes('üöÄ') || line.includes('curl') ? 'text-cyan' :
                                'text-gray';
                                
                addTerminalLine(line, className);
            }
            
            addTerminalLine('', 'text-gray');
        }
        
        async function deploy() {
            if (isRunning) return;
            
            console.log('Starting deployment...');
            
            // Increment global deployment count securely
            sessionDeployments++;
            await incrementStats();
            
            isRunning = true;
            currentStep = 0;
            startTime = Date.now();
            
            const activeSteps = getActiveSteps();
            
            // Update UI
            document.getElementById('deployBtn').textContent = '‚è≥ Deploying...';
            document.getElementById('deployBtn').disabled = true;
            document.getElementById('status').textContent = 'Running...';
            
            // Clear terminal
            document.getElementById('terminal').innerHTML = '';
            
            // Start timer
            timer = setInterval(updateTimer, 1000);
            
            addTerminalLine('üöÄ Starting infrastructure deployment...', 'text-cyan');
            addTerminalLine(`üîí Global deployment #${usageStats.totalDeployments} via secure API`, 'text-blue');
            addTerminalLine('üåç Stats synced globally with zero config exposure!', 'text-cyan');
            addTerminalLine('Components will discover each other automatically!', 'text-cyan');
            addTerminalLine('', 'text-gray');
            
            try {
                for (let i = 0; i < activeSteps.length; i++) {
                    currentStep = i;
                    renderSteps();
                    updateProgress();
                    
                    await runStep(i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                currentStep = activeSteps.length;
                renderSteps();
                updateProgress();
                
                addTerminalLine('üéâ Infrastructure deployment completed successfully!', 'text-green');
                addTerminalLine('All components are operational and auto-configured.', 'text-green');
                addTerminalLine('Runtime discovery worked perfectly - zero manual coordination!', 'text-green');
                addTerminalLine('üîí Global stats updated securely via Netlify function.', 'text-green');
                
                document.getElementById('status').textContent = 'Complete';
                
            } catch (error) {
                console.error('Deployment error:', error);
                addTerminalLine('‚ùå Deployment failed: ' + error.message, 'text-yellow');
                document.getElementById('status').textContent = 'Failed';
            } finally {
                isRunning = false;
                clearInterval(timer);
                document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
                document.getElementById('deployBtn').disabled = false;
            }
        }
        
        function reset() {
            console.log('Resetting demo...');
            
            if (timer) clearInterval(timer);
            
            isRunning = false;
            currentStep = 0;
            startTime = 0;
            
            document.getElementById('timer').textContent = '0s';
            document.getElementById('status').textContent = 'Ready';
            document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
            document.getElementById('deployBtn').disabled = false;
            
            document.getElementById('terminal').innerHTML = 
                '<div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>';
                
            renderSteps();
            updateProgress();
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Secure infrastructure demo initialized');
            
            // Load global stats securely via Netlify function
            await fetchStats();
            
            setupFeatureToggles();
            document.getElementById('deployBtn').addEventListener('click', deploy);
            document.getElementById('resetBtn').addEventListener('click', reset);
            
            updateStats();
            renderSteps();
            updateProgress();
            
            // Periodic stats refresh for real-time updates
            setInterval(async () => {
                if (!isRunning) {
                    await fetchStats();
                }
            }, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Configuring Infrastructure Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .feature-flags {
            margin-bottom: 20px;
        }
        
        .feature-flags h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .feature-toggle:hover {
            border-color: #cbd5e0;
        }
        
        .feature-toggle.active {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .feature-info .name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .feature-info .desc {
            font-size: 12px;
            color: #718096;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats {
            margin-left: auto;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .usage-stats {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 13px;
            color: #4a5568;
        }
        
        .usage-stats .highlight {
            font-weight: 600;
            color: #2d3748;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 500px;
        }
        
        .steps-panel {
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .terminal-panel {
            background: #1a202c;
            padding: 25px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            max-height: 500px; /* Fixed height to match steps panel */
        }
        
        .terminal-header {
            margin-bottom: 15px;
            color: #a0aec0;
            flex-shrink: 0; /* Don't shrink the header */
        }
        
        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            /* Custom scrollbar styling */
        }
        
        .terminal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .terminal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step.running {
            border-color: #667eea;
            background: #edf2f7;
            animation: pulse 2s infinite;
        }
        
        .step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 14px;
            color: #666;
        }
        
        .terminal-line {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        
        .text-green { color: #68d391; }
        .text-blue { color: #63b3ed; }
        .text-yellow { color: #f6e05e; }
        .text-cyan { color: #76e4f7; }
        .text-gray { color: #a0aec0; }
        
        .progress {
            padding: 20px;
            background: #f7fafc;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #48bb78 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Self-Configuring Infrastructure Demo</h1>
            <p>Experience runtime discovery and automatic dependency resolution!</p>
        </div>
        
        <div class="controls">
            <div class="feature-flags">
                <h3>üéõÔ∏è Feature Flags (Choose Your Adventure)</h3>
                <div class="feature-grid">
                    <div id="feature-loadbalancer" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚öñÔ∏è Load Balancer</div>
                            <div class="desc">HAProxy with dynamic backends</div>
                        </div>
                    </div>
                    <div id="feature-k3s" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚ò∏Ô∏è K3s Cluster</div>
                            <div class="desc">HA Kubernetes cluster</div>
                        </div>
                    </div>
                    <div id="feature-harvester" class="feature-toggle">
                        <input type="checkbox">
                        <div class="feature-info">
                            <div class="name">üåæ Harvester HCI</div>
                            <div class="desc">iPXE network boot (45+ min)</div>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #718096; margin: 0;">
                    üí° Toggle features to see different deployment scenarios. Infrastructure adapts automatically!
                </p>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="control-buttons">
                    <button id="deployBtn" class="btn btn-primary">‚ñ∂Ô∏è Deploy Infrastructure</button>
                    <button id="resetBtn" class="btn btn-secondary">üîÑ Reset</button>
                </div>
                
                <div class="stats">
                    <span>üñ•Ô∏è <span id="vmCount">4 VMs</span></span>
                    <span>üíª <span id="actionCount">6 Actions</span></span>
                    <span>üöÄ <span id="deployCount">0 Deployments</span></span>
                    <span>‚ö° <span id="timer">0s</span></span>
                    <span id="status">Ready</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="steps-panel">
                <h3>Deployment Steps</h3>
                <div id="stepsList">
                    <!-- Steps will be populated here -->
                </div>
            </div>
            
            <div class="terminal-panel">
                <div class="terminal-header">
                    üñ•Ô∏è pulumi-deployment-terminal
                </div>
                <div class="terminal-content" id="terminal">
                    <div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>
                </div>
            </div>
        </div>
        
        <div class="progress">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Progress</span>
                <span id="progressText">0 of 6 steps</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="usage-stats">
            <span id="connectionStatus">üîÑ Connecting to global stats...</span> ‚Ä¢
            <span class="highlight" id="totalDeployments">0</span> total deployments 
            ‚Ä¢ <span class="highlight" id="sessionsToday">0</span> sessions today 
            ‚Ä¢ Last deployment: <span class="highlight" id="lastDeployment">Never</span>
        </div>
    </div>

    <script>
        // Demo state
        let isRunning = false;
        let currentStep = 0;
        let startTime = 0;
        let timer = null;
        let sessionDeployments = 0;
        
        // Global stats tracking via secure Netlify function
        let usageStats = {
            totalDeployments: 0,
            deploymentsToday: 0,
            lastDeployment: null
        };
        
        // Feature flags
        let features = {
            loadbalancer: true,
            k3s: true,
            harvester: false
        };
        
        // Auto-detect Netlify function endpoint
        const isNetlify = window.location.hostname.includes('netlify.app');
        const API_BASE = isNetlify 
            ? `${window.location.origin}/.netlify/functions`
            : 'https://your-site.netlify.app/.netlify/functions';
        
        const allSteps = [
            {
                id: 'env-setup',
                title: "üõ†Ô∏è Environment Setup",
                desc: "Setting up Pulumi and Proxmox connection",
                output: [
                    "Setting environment variables...",
                    "PROXMOX_VE_ENDPOINT=https://192.168.90.102:8006/",
                    "SSH_PUBLIC_KEY loaded from ~/.ssh/id_ed25519.pub",
                    "Initializing Pulumi stack...",
                    "‚úÖ Environment ready for deployment!"
                ],
                requires: []
            },
            {
                id: 'config-validation',
                title: "üìã Configuration Validation", 
                desc: "Validating templates and building dependency map",
                output: [
                    "Loading Pulumi.dev.yaml configuration...",
                    "Validating VM templates...",
                    "Checking feature flags...",
                    "  ‚úÖ loadbalancer: enabled",
                    "  ‚úÖ k3s: enabled", 
                    "  ‚ö™ harvester: disabled",
                    "Building global dependency map...",
                    "‚úÖ Configuration valid, proceeding!"
                ],
                requires: []
            },
            {
                id: 'vm-creation',
                title: "üñ•Ô∏è VM Creation & Role Grouping",
                desc: "Creating VMs and organizing by infrastructure role",
                output: [
                    "Creating VMs from templates...",
                    "Creating VM: loadbalancer-0 (192.168.90.190)",
                    "  Template: ubuntu-22.04-template",
                    "  Role: loadbalancer",
                    "Creating VM: k3s-server-0 (192.168.90.187)",
                    "Creating VM: k3s-server-1 (192.168.90.188)",
                    "Creating VM: k3s-server-2 (192.168.90.189)",
                    "  Template: sle-micro-template", 
                    "  Role: k3s-server",
                    "üîÑ Organizing VMs by role...",
                    "‚úÖ All VMs created and grouped!"
                ],
                requires: []
            },
            {
                id: 'dependency-resolution',
                title: "üîó Global Dependency Resolution",
                desc: "Building runtime discovery map for service coordination",
                output: [
                    "üîç Building global dependency map...",
                    "Scanning role groups for discoverable resources...",
                    "üìä Global Dependencies Available:",
                    "  loadbalancer-ips: [\"192.168.90.190\"]",
                    "  k3s-server-ips: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üéØ Action Execution Plan:",
                    "  1. install-haproxy (depends on: k3s-server-ips)",
                    "  2. install-k3s-server (depends on: loadbalancer)",
                    "‚úÖ Dependencies resolved - ready for execution!"
                ],
                requires: []
            },
            {
                id: 'loadbalancer-setup',
                title: "‚öñÔ∏è HAProxy Load Balancer",
                desc: "Installing HAProxy with dynamic backend discovery",
                output: [
                    "üéØ Executing action: install-haproxy",
                    "üîç Runtime Discovery: Finding k3s-server IPs...",
                    "  Discovered: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üì¶ Installing HAProxy on 192.168.90.190...",
                    "sudo apt update && sudo apt install -y haproxy",
                    "üîß Generating dynamic HAProxy configuration:",
                    "backend k3s-servers",
                    "    server k3s-server-1 192.168.90.187:6443 check",
                    "    server k3s-server-2 192.168.90.188:6443 check", 
                    "    server k3s-server-3 192.168.90.189:6443 check",
                    "sudo systemctl enable --now haproxy",
                    "‚úÖ HAProxy running and ready for K3s traffic!"
                ],
                requires: ['loadbalancer']
            },
            {
                id: 'k3s-cluster',
                title: "‚ò∏Ô∏è K3s High-Availability Cluster",
                desc: "Deploying K3s servers with automatic cluster formation",
                output: [
                    "üéØ Executing action: install-k3s-server",
                    "üîç Runtime Discovery: Finding loadbalancer IP...",
                    "  Discovered LB: 192.168.90.190",
                    "üöÄ Installing K3s on server 1: 192.168.90.187",
                    "curl -sfL https://get.k3s.io | sudo sh -s - server \\",
                    "  --cluster-init \\",
                    "  --tls-san=192.168.90.190",
                    "‚è≥ Waiting for cluster initialization...",
                    "üöÄ Installing K3s on server 2: 192.168.90.188",
                    "üöÄ Installing K3s on server 3: 192.168.90.189",
                    "  Joining cluster through load balancer: 192.168.90.190",
                    "‚úÖ 3-node HA K3s cluster formed automatically!"
                ],
                requires: ['k3s']
            },
            {
                id: 'kubeconfig-extraction',
                title: "üìã Kubeconfig & Verification",
                desc: "Extracting kubeconfig and verifying cluster health",
                output: [
                    "üéØ Executing action: get-kubeconfig",
                    "üîç Runtime Discovery: Finding first k3s server...",
                    "  Discovered: 192.168.90.187",
                    "üìã Extracting kubeconfig from k3s-server-0...",
                    "scp root@192.168.90.187:/etc/rancher/k3s/k3s.yaml ./kubeconfig",
                    "üîç Verifying cluster through load balancer...",
                    "kubectl --kubeconfig=kubeconfig get nodes",
                    "NAME           STATUS   ROLES                  AGE",
                    "k3s-server-0   Ready    control-plane,master   2m",
                    "k3s-server-1   Ready    control-plane,master   1m", 
                    "k3s-server-2   Ready    control-plane,master   1m",
                    "‚úÖ All nodes healthy, cluster ready for workloads!"
                ],
                requires: ['k3s']
            },
            {
                id: 'harvester-deploy',
                title: "üåæ Harvester HCI Platform",
                desc: "Deploying Harvester with iPXE network boot (45+ min)",
                output: [
                    "üéØ Executing action: install-harvester-hci",
                    "‚ö†Ô∏è  WARNING: This is a 45+ minute operation!",
                    "üîç Runtime Discovery: Finding available nodes...",
                    "  Discovered nodes: 3 available for Harvester",
                    "üì° Setting up iPXE network boot infrastructure...",
                    "Configuring DHCP server with iPXE boot options...",
                    "Preparing Harvester ISO for network deployment...",
                    "üöÄ Initiating network boot sequence:",
                    "  Node 1 (192.168.90.200): iPXE boot started",
                    "  Node 2 (192.168.90.201): iPXE boot started",
                    "  Node 3 (192.168.90.202): iPXE boot started",
                    "‚è≥ Installing Harvester OS (this will take 45+ minutes)...",
                    "üìä Progress: Installing base system...",
                    "üìä Progress: Configuring storage pools...",
                    "üìä Progress: Setting up Harvester management cluster...",
                    "‚úÖ Harvester HCI platform deployed successfully!",
                    "üåê Management UI: https://192.168.90.200:8443",
                    "‚ò∏Ô∏è Embedded K8s cluster ready for VM workloads"
                ],
                requires: ['harvester']
            }
        ];
        
        // Secure API functions
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global stats loaded securely via Netlify function');
                return true;
            } catch (error) {
                console.log('üì± Secure API unavailable, using localStorage fallback');
                loadLocalStats();
                return false;
            }
        }
        
        async function incrementStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global deployment count updated securely!');
                return true;
            } catch (error) {
                console.log('üì± Secure API failed, using local increment');
                incrementLocalStats();
                return false;
            }
        }
        
        function loadLocalStats() {
            const stored = localStorage.getItem('demoUsageStats');
            if (stored) {
                usageStats = JSON.parse(stored);
                if (usageStats.lastDeployment) {
                    usageStats.lastDeployment = new Date(usageStats.lastDeployment);
                }
            } else {
                usageStats = {
                    totalDeployments: 0,
                    deploymentsToday: 0,
                    lastDeployment: null
                };
            }
            updateUsageDisplay();
        }
        
        function incrementLocalStats() {
            usageStats.totalDeployments++;
            usageStats.deploymentsToday++;
            usageStats.lastDeployment = new Date();
            localStorage.setItem('demoUsageStats', JSON.stringify(usageStats));
            updateUsageDisplay();
        }
        
        function updateUsageDisplay() {
            document.getElementById('totalDeployments').textContent = usageStats.totalDeployments.toLocaleString();
            document.getElementById('sessionsToday').textContent = usageStats.deploymentsToday;
            
            // Update connection status
            const connectionStatus = document.getElementById('connectionStatus');
            if (API_BASE.includes('netlify')) {
                connectionStatus.innerHTML = 'üîí <strong>Secure Global Stats</strong>';
                connectionStatus.style.color = '#48bb78';
            } else {
                connectionStatus.innerHTML = 'üì± <strong>Local Mode</strong>';
                connectionStatus.style.color = '#f6e05e';
            }
            
            if (usageStats.lastDeployment) {
                const lastTime = usageStats.lastDeployment;
                const now = new Date();
                const diffMinutes = Math.floor((now - lastTime) / 60000);
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Just now';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes}m ago`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)}h ago`;
                } else {
                    timeText = lastTime.toLocaleDateString();
                }
                
                document.getElementById('lastDeployment').textContent = timeText;
            } else {
                document.getElementById('lastDeployment').textContent = 'Never';
            }
            
            document.getElementById('deployCount').textContent = sessionDeployments + ' Session';
        }
        
        function getActiveSteps() {
            return allSteps.filter(step => {
                if (step.requires.length === 0) return true;
                return step.requires.some(req => features[req]);
            });
        }
        
        function updateStats() {
            const activeSteps = getActiveSteps();
            let vmCount = 0;
            
            if (features.loadbalancer) vmCount += 1;
            if (features.k3s) vmCount += 3;
            if (features.harvester) vmCount += 3;
            
            document.getElementById('vmCount').textContent = vmCount + ' VMs';
            document.getElementById('actionCount').textContent = activeSteps.length + ' Actions';
        }
        
        function setupFeatureToggles() {
            ['loadbalancer', 'k3s', 'harvester'].forEach(feature => {
                const toggle = document.getElementById(`feature-${feature}`);
                const checkbox = toggle.querySelector('input');
                
                toggle.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    features[feature] = checkbox.checked;
                    toggle.classList.toggle('active', checkbox.checked);
                    
                    if (!isRunning) {
                        updateStats();
                        renderSteps();
                        updateProgress();
                    }
                });
            });
        }
        
        function updateTimer() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed + 's';
            }
        }
        
        function addTerminalLine(text, className = 'text-gray') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            terminal.appendChild(line);
            
            // Auto-scroll to bottom, but smoothly
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function updateProgress() {
            const activeSteps = getActiveSteps();
            const total = activeSteps.length;
            const completed = currentStep;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} steps`;
        }
        
        function renderSteps() {
            const activeSteps = getActiveSteps();
            const stepsList = document.getElementById('stepsList');
            
            stepsList.innerHTML = activeSteps.map((step, index) => {
                let className = '';
                let icon = '‚è≥';
                
                if (index < currentStep) {
                    className = 'completed';
                    icon = '‚úÖ';
                } else if (index === currentStep && isRunning) {
                    className = 'running';
                    icon = 'üîÑ';
                }
                
                return `
                    <div class="step ${className}">
                        <div class="step-title">${icon} ${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function runStep(stepIndex) {
            const activeSteps = getActiveSteps();
            const step = activeSteps[stepIndex];
            
            addTerminalLine(`üéØ Step ${stepIndex + 1}/${activeSteps.length}: ${step.title}`, 'text-yellow');
            addTerminalLine('', 'text-gray');
            
            for (const line of step.output) {
                await new Promise(resolve => setTimeout(resolve, step.id === 'harvester-deploy' ? 200 : 300));
                
                const className = line.includes('‚úÖ') ? 'text-green' :
                                line.includes('‚ö†Ô∏è') || line.includes('WARNING') ? 'text-yellow' :
                                line.includes('üîç') || line.includes('üìä') || line.includes('üéØ') ? 'text-blue' :
                                line.includes('üöÄ') || line.includes('curl') ? 'text-cyan' :
                                'text-gray';
                                
                addTerminalLine(line, className);
            }
            
            addTerminalLine('', 'text-gray');
        }
        
        async function deploy() {
            if (isRunning) return;
            
            console.log('Starting deployment...');
            
            // Increment global deployment count securely
            sessionDeployments++;
            await incrementStats();
            
            isRunning = true;
            currentStep = 0;
            startTime = Date.now();
            
            const activeSteps = getActiveSteps();
            
            // Update UI
            document.getElementById('deployBtn').textContent = '‚è≥ Deploying...';
            document.getElementById('deployBtn').disabled = true;
            document.getElementById('status').textContent = 'Running...';
            
            // Clear terminal
            document.getElementById('terminal').innerHTML = '';
            
            // Start timer
            timer = setInterval(updateTimer, 1000);
            
            addTerminalLine('üöÄ Starting infrastructure deployment...', 'text-cyan');
            addTerminalLine(`üîí Global deployment #${usageStats.totalDeployments} via secure API`, 'text-blue');
            addTerminalLine('üåç Stats synced globally with zero config exposure!', 'text-cyan');
            addTerminalLine('Components will discover each other automatically!', 'text-cyan');
            addTerminalLine('', 'text-gray');
            
            try {
                for (let i = 0; i < activeSteps.length; i++) {
                    currentStep = i;
                    renderSteps();
                    updateProgress();
                    
                    await runStep(i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                currentStep = activeSteps.length;
                renderSteps();
                updateProgress();
                
                addTerminalLine('üéâ Infrastructure deployment completed successfully!', 'text-green');
                addTerminalLine('All components are operational and auto-configured.', 'text-green');
                addTerminalLine('Runtime discovery worked perfectly - zero manual coordination!', 'text-green');
                addTerminalLine('üîí Global stats updated securely via Netlify function.', 'text-green');
                
                document.getElementById('status').textContent = 'Complete';
                
            } catch (error) {
                console.error('Deployment error:', error);
                addTerminalLine('‚ùå Deployment failed: ' + error.message, 'text-yellow');
                document.getElementById('status').textContent = 'Failed';
            } finally {
                isRunning = false;
                clearInterval(timer);
                document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
                document.getElementById('deployBtn').disabled = false;
            }
        }
        
        function reset() {
            console.log('Resetting demo...');
            
            if (timer) clearInterval(timer);
            
            isRunning = false;
            currentStep = 0;
            startTime = 0;
            
            document.getElementById('timer').textContent = '0s';
            document.getElementById('status').textContent = 'Ready';
            document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
            document.getElementById('deployBtn').disabled = false;
            
            document.getElementById('terminal').innerHTML = 
                '<div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>';
                
            renderSteps();
            updateProgress();
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Secure infrastructure demo initialized');
            
            // Load global stats securely via Netlify function
            await fetchStats();
            
            setupFeatureToggles();
            document.getElementById('deployBtn').addEventListener('click', deploy);
            document.getElementById('resetBtn').addEventListener('click', reset);
            
            updateStats();
            renderSteps();
            updateProgress();
            
            // Periodic stats refresh for real-time updates
            setInterval(async () => {
                if (!isRunning) {
                    await fetchStats();
                }
            }, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Configuring Infrastructure Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .feature-flags {
            margin-bottom: 20px;
        }
        
        .feature-flags h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .feature-toggle:hover {
            border-color: #cbd5e0;
        }
        
        .feature-toggle.active {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .feature-info .name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .feature-info .desc {
            font-size: 12px;
            color: #718096;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats {
            margin-left: auto;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .usage-stats {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 13px;
            color: #4a5568;
        }
        
        .usage-stats .highlight {
            font-weight: 600;
            color: #2d3748;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 500px;
        }
        
        .steps-panel {
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .terminal-panel {
            background: #1a202c;
            padding: 25px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            max-height: 500px; /* Fixed height to match steps panel */
        }
        
        .terminal-header {
            margin-bottom: 15px;
            color: #a0aec0;
            flex-shrink: 0; /* Don't shrink the header */
        }
        
        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            /* Custom scrollbar styling */
        }
        
        .terminal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .terminal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step.running {
            border-color: #667eea;
            background: #edf2f7;
            animation: pulse 2s infinite;
        }
        
        .step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 14px;
            color: #666;
        }
        
        .terminal-line {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        
        .text-green { color: #68d391; }
        .text-blue { color: #63b3ed; }
        .text-yellow { color: #f6e05e; }
        .text-cyan { color: #76e4f7; }
        .text-gray { color: #a0aec0; }
        
        .progress {
            padding: 20px;
            background: #f7fafc;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #48bb78 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Self-Configuring Infrastructure Demo</h1>
            <p>Experience runtime discovery and automatic dependency resolution!</p>
        </div>
        
        <div class="controls">
            <div class="feature-flags">
                <h3>üéõÔ∏è Feature Flags (Choose Your Adventure)</h3>
                <div class="feature-grid">
                    <div id="feature-loadbalancer" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚öñÔ∏è Load Balancer</div>
                            <div class="desc">HAProxy with dynamic backends</div>
                        </div>
                    </div>
                    <div id="feature-k3s" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚ò∏Ô∏è K3s Cluster</div>
                            <div class="desc">HA Kubernetes cluster</div>
                        </div>
                    </div>
                    <div id="feature-harvester" class="feature-toggle">
                        <input type="checkbox">
                        <div class="feature-info">
                            <div class="name">üåæ Harvester HCI</div>
                            <div class="desc">iPXE network boot (45+ min)</div>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #718096; margin: 0;">
                    üí° Toggle features to see different deployment scenarios. Infrastructure adapts automatically!
                </p>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="control-buttons">
                    <button id="deployBtn" class="btn btn-primary">‚ñ∂Ô∏è Deploy Infrastructure</button>
                    <button id="resetBtn" class="btn btn-secondary">üîÑ Reset</button>
                </div>
                
                <div class="stats">
                    <span>üñ•Ô∏è <span id="vmCount">4 VMs</span></span>
                    <span>üíª <span id="actionCount">6 Actions</span></span>
                    <span>üöÄ <span id="deployCount">0 Deployments</span></span>
                    <span>‚ö° <span id="timer">0s</span></span>
                    <span id="status">Ready</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="steps-panel">
                <h3>Deployment Steps</h3>
                <div id="stepsList">
                    <!-- Steps will be populated here -->
                </div>
            </div>
            
            <div class="terminal-panel">
                <div class="terminal-header">
                    üñ•Ô∏è pulumi-deployment-terminal
                </div>
                <div class="terminal-content" id="terminal">
                    <div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>
                </div>
            </div>
        </div>
        
        <div class="progress">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Progress</span>
                <span id="progressText">0 of 6 steps</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="usage-stats">
            <span id="connectionStatus">üîÑ Connecting to global stats...</span> ‚Ä¢
            <span class="highlight" id="totalDeployments">0</span> total deployments 
            ‚Ä¢ <span class="highlight" id="sessionsToday">0</span> sessions today 
            ‚Ä¢ Last deployment: <span class="highlight" id="lastDeployment">Never</span>
        </div>
    </div>

    <script>
        // Demo state
        let isRunning = false;
        let currentStep = 0;
        let startTime = 0;
        let timer = null;
        let sessionDeployments = 0;
        
        // Global stats tracking via secure Netlify function
        let usageStats = {
            totalDeployments: 0,
            deploymentsToday: 0,
            lastDeployment: null
        };
        
        // Feature flags
        let features = {
            loadbalancer: true,
            k3s: true,
            harvester: false
        };
        
        // Auto-detect Netlify function endpoint
        const isNetlify = window.location.hostname.includes('netlify.app');
        const API_BASE = isNetlify 
            ? `${window.location.origin}/.netlify/functions`
            : 'https://your-site.netlify.app/.netlify/functions';
        
        const allSteps = [
            {
                id: 'env-setup',
                title: "üõ†Ô∏è Environment Setup",
                desc: "Setting up Pulumi and Proxmox connection",
                output: [
                    "Setting environment variables...",
                    "PROXMOX_VE_ENDPOINT=https://192.168.90.102:8006/",
                    "SSH_PUBLIC_KEY loaded from ~/.ssh/id_ed25519.pub",
                    "Initializing Pulumi stack...",
                    "‚úÖ Environment ready for deployment!"
                ],
                requires: []
            },
            {
                id: 'config-validation',
                title: "üìã Configuration Validation", 
                desc: "Validating templates and building dependency map",
                output: [
                    "Loading Pulumi.dev.yaml configuration...",
                    "Validating VM templates...",
                    "Checking feature flags...",
                    "  ‚úÖ loadbalancer: enabled",
                    "  ‚úÖ k3s: enabled", 
                    "  ‚ö™ harvester: disabled",
                    "Building global dependency map...",
                    "‚úÖ Configuration valid, proceeding!"
                ],
                requires: []
            },
            {
                id: 'vm-creation',
                title: "üñ•Ô∏è VM Creation & Role Grouping",
                desc: "Creating VMs and organizing by infrastructure role",
                output: [
                    "Creating VMs from templates...",
                    "Creating VM: loadbalancer-0 (192.168.90.190)",
                    "  Template: ubuntu-22.04-template",
                    "  Role: loadbalancer",
                    "Creating VM: k3s-server-0 (192.168.90.187)",
                    "Creating VM: k3s-server-1 (192.168.90.188)",
                    "Creating VM: k3s-server-2 (192.168.90.189)",
                    "  Template: sle-micro-template", 
                    "  Role: k3s-server",
                    "üîÑ Organizing VMs by role...",
                    "‚úÖ All VMs created and grouped!"
                ],
                requires: []
            },
            {
                id: 'dependency-resolution',
                title: "üîó Global Dependency Resolution",
                desc: "Building runtime discovery map for service coordination",
                output: [
                    "üîç Building global dependency map...",
                    "Scanning role groups for discoverable resources...",
                    "üìä Global Dependencies Available:",
                    "  loadbalancer-ips: [\"192.168.90.190\"]",
                    "  k3s-server-ips: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üéØ Action Execution Plan:",
                    "  1. install-haproxy (depends on: k3s-server-ips)",
                    "  2. install-k3s-server (depends on: loadbalancer)",
                    "‚úÖ Dependencies resolved - ready for execution!"
                ],
                requires: []
            },
            {
                id: 'loadbalancer-setup',
                title: "‚öñÔ∏è HAProxy Load Balancer",
                desc: "Installing HAProxy with dynamic backend discovery",
                output: [
                    "üéØ Executing action: install-haproxy",
                    "üîç Runtime Discovery: Finding k3s-server IPs...",
                    "  Discovered: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üì¶ Installing HAProxy on 192.168.90.190...",
                    "sudo apt update && sudo apt install -y haproxy",
                    "üîß Generating dynamic HAProxy configuration:",
                    "backend k3s-servers",
                    "    server k3s-server-1 192.168.90.187:6443 check",
                    "    server k3s-server-2 192.168.90.188:6443 check", 
                    "    server k3s-server-3 192.168.90.189:6443 check",
                    "sudo systemctl enable --now haproxy",
                    "‚úÖ HAProxy running and ready for K3s traffic!"
                ],
                requires: ['loadbalancer']
            },
            {
                id: 'k3s-cluster',
                title: "‚ò∏Ô∏è K3s High-Availability Cluster",
                desc: "Deploying K3s servers with automatic cluster formation",
                output: [
                    "üéØ Executing action: install-k3s-server",
                    "üîç Runtime Discovery: Finding loadbalancer IP...",
                    "  Discovered LB: 192.168.90.190",
                    "üöÄ Installing K3s on server 1: 192.168.90.187",
                    "curl -sfL https://get.k3s.io | sudo sh -s - server \\",
                    "  --cluster-init \\",
                    "  --tls-san=192.168.90.190",
                    "‚è≥ Waiting for cluster initialization...",
                    "üöÄ Installing K3s on server 2: 192.168.90.188",
                    "üöÄ Installing K3s on server 3: 192.168.90.189",
                    "  Joining cluster through load balancer: 192.168.90.190",
                    "‚úÖ 3-node HA K3s cluster formed automatically!"
                ],
                requires: ['k3s']
            },
            {
                id: 'kubeconfig-extraction',
                title: "üìã Kubeconfig & Verification",
                desc: "Extracting kubeconfig and verifying cluster health",
                output: [
                    "üéØ Executing action: get-kubeconfig",
                    "üîç Runtime Discovery: Finding first k3s server...",
                    "  Discovered: 192.168.90.187",
                    "üìã Extracting kubeconfig from k3s-server-0...",
                    "scp root@192.168.90.187:/etc/rancher/k3s/k3s.yaml ./kubeconfig",
                    "üîç Verifying cluster through load balancer...",
                    "kubectl --kubeconfig=kubeconfig get nodes",
                    "NAME           STATUS   ROLES                  AGE",
                    "k3s-server-0   Ready    control-plane,master   2m",
                    "k3s-server-1   Ready    control-plane,master   1m", 
                    "k3s-server-2   Ready    control-plane,master   1m",
                    "‚úÖ All nodes healthy, cluster ready for workloads!"
                ],
                requires: ['k3s']
            },
            {
                id: 'harvester-deploy',
                title: "üåæ Harvester HCI Platform",
                desc: "Deploying Harvester with iPXE network boot (45+ min)",
                output: [
                    "üéØ Executing action: install-harvester-hci",
                    "‚ö†Ô∏è  WARNING: This is a 45+ minute operation!",
                    "üîç Runtime Discovery: Finding available nodes...",
                    "  Discovered nodes: 3 available for Harvester",
                    "üì° Setting up iPXE network boot infrastructure...",
                    "Configuring DHCP server with iPXE boot options...",
                    "Preparing Harvester ISO for network deployment...",
                    "üöÄ Initiating network boot sequence:",
                    "  Node 1 (192.168.90.200): iPXE boot started",
                    "  Node 2 (192.168.90.201): iPXE boot started",
                    "  Node 3 (192.168.90.202): iPXE boot started",
                    "‚è≥ Installing Harvester OS (this will take 45+ minutes)...",
                    "üìä Progress: Installing base system...",
                    "üìä Progress: Configuring storage pools...",
                    "üìä Progress: Setting up Harvester management cluster...",
                    "‚úÖ Harvester HCI platform deployed successfully!",
                    "üåê Management UI: https://192.168.90.200:8443",
                    "‚ò∏Ô∏è Embedded K8s cluster ready for VM workloads"
                ],
                requires: ['harvester']
            }
        ];
        
        // Secure API functions
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global stats loaded securely via Netlify function');
                return true;
            } catch (error) {
                console.log('üì± Secure API unavailable, using localStorage fallback');
                loadLocalStats();
                return false;
            }
        }
        
        async function incrementStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global deployment count updated securely!');
                return true;
            } catch (error) {
                console.log('üì± Secure API failed, using local increment');
                incrementLocalStats();
                return false;
            }
        }
        
        function loadLocalStats() {
            const stored = localStorage.getItem('demoUsageStats');
            if (stored) {
                usageStats = JSON.parse(stored);
                if (usageStats.lastDeployment) {
                    usageStats.lastDeployment = new Date(usageStats.lastDeployment);
                }
            } else {
                usageStats = {
                    totalDeployments: 0,
                    deploymentsToday: 0,
                    lastDeployment: null
                };
            }
            updateUsageDisplay();
        }
        
        function incrementLocalStats() {
            usageStats.totalDeployments++;
            usageStats.deploymentsToday++;
            usageStats.lastDeployment = new Date();
            localStorage.setItem('demoUsageStats', JSON.stringify(usageStats));
            updateUsageDisplay();
        }
        
        function updateUsageDisplay() {
            document.getElementById('totalDeployments').textContent = usageStats.totalDeployments.toLocaleString();
            document.getElementById('sessionsToday').textContent = usageStats.deploymentsToday;
            
            // Update connection status
            const connectionStatus = document.getElementById('connectionStatus');
            if (API_BASE.includes('netlify')) {
                connectionStatus.innerHTML = 'üîí <strong>Secure Global Stats</strong>';
                connectionStatus.style.color = '#48bb78';
            } else {
                connectionStatus.innerHTML = 'üì± <strong>Local Mode</strong>';
                connectionStatus.style.color = '#f6e05e';
            }
            
            if (usageStats.lastDeployment) {
                const lastTime = usageStats.lastDeployment;
                const now = new Date();
                const diffMinutes = Math.floor((now - lastTime) / 60000);
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Just now';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes}m ago`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)}h ago`;
                } else {
                    timeText = lastTime.toLocaleDateString();
                }
                
                document.getElementById('lastDeployment').textContent = timeText;
            } else {
                document.getElementById('lastDeployment').textContent = 'Never';
            }
            
            document.getElementById('deployCount').textContent = sessionDeployments + ' Session';
        }
        
        function getActiveSteps() {
            return allSteps.filter(step => {
                if (step.requires.length === 0) return true;
                return step.requires.some(req => features[req]);
            });
        }
        
        function updateStats() {
            const activeSteps = getActiveSteps();
            let vmCount = 0;
            
            if (features.loadbalancer) vmCount += 1;
            if (features.k3s) vmCount += 3;
            if (features.harvester) vmCount += 3;
            
            document.getElementById('vmCount').textContent = vmCount + ' VMs';
            document.getElementById('actionCount').textContent = activeSteps.length + ' Actions';
        }
        
        function setupFeatureToggles() {
            ['loadbalancer', 'k3s', 'harvester'].forEach(feature => {
                const toggle = document.getElementById(`feature-${feature}`);
                const checkbox = toggle.querySelector('input');
                
                toggle.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    features[feature] = checkbox.checked;
                    toggle.classList.toggle('active', checkbox.checked);
                    
                    if (!isRunning) {
                        updateStats();
                        renderSteps();
                        updateProgress();
                    }
                });
            });
        }
        
        function updateTimer() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed + 's';
            }
        }
        
        function addTerminalLine(text, className = 'text-gray') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            terminal.appendChild(line);
            
            // Auto-scroll to bottom, but smoothly
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function updateProgress() {
            const activeSteps = getActiveSteps();
            const total = activeSteps.length;
            const completed = currentStep;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} steps`;
        }
        
        function renderSteps() {
            const activeSteps = getActiveSteps();
            const stepsList = document.getElementById('stepsList');
            
            stepsList.innerHTML = activeSteps.map((step, index) => {
                let className = '';
                let icon = '‚è≥';
                
                if (index < currentStep) {
                    className = 'completed';
                    icon = '‚úÖ';
                } else if (index === currentStep && isRunning) {
                    className = 'running';
                    icon = 'üîÑ';
                }
                
                return `
                    <div class="step ${className}">
                        <div class="step-title">${icon} ${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function runStep(stepIndex) {
            const activeSteps = getActiveSteps();
            const step = activeSteps[stepIndex];
            
            addTerminalLine(`üéØ Step ${stepIndex + 1}/${activeSteps.length}: ${step.title}`, 'text-yellow');
            addTerminalLine('', 'text-gray');
            
            for (const line of step.output) {
                await new Promise(resolve => setTimeout(resolve, step.id === 'harvester-deploy' ? 200 : 300));
                
                const className = line.includes('‚úÖ') ? 'text-green' :
                                line.includes('‚ö†Ô∏è') || line.includes('WARNING') ? 'text-yellow' :
                                line.includes('üîç') || line.includes('üìä') || line.includes('üéØ') ? 'text-blue' :
                                line.includes('üöÄ') || line.includes('curl') ? 'text-cyan' :
                                'text-gray';
                                
                addTerminalLine(line, className);
            }
            
            addTerminalLine('', 'text-gray');
        }
        
        async function deploy() {
            if (isRunning) return;
            
            console.log('Starting deployment...');
            
            // Increment global deployment count securely
            sessionDeployments++;
            await incrementStats();
            
            isRunning = true;
            currentStep = 0;
            startTime = Date.now();
            
            const activeSteps = getActiveSteps();
            
            // Update UI
            document.getElementById('deployBtn').textContent = '‚è≥ Deploying...';
            document.getElementById('deployBtn').disabled = true;
            document.getElementById('status').textContent = 'Running...';
            
            // Clear terminal
            document.getElementById('terminal').innerHTML = '';
            
            // Start timer
            timer = setInterval(updateTimer, 1000);
            
            addTerminalLine('üöÄ Starting infrastructure deployment...', 'text-cyan');
            addTerminalLine(`üîí Global deployment #${usageStats.totalDeployments} via secure API`, 'text-blue');
            addTerminalLine('üåç Stats synced globally with zero config exposure!', 'text-cyan');
            addTerminalLine('Components will discover each other automatically!', 'text-cyan');
            addTerminalLine('', 'text-gray');
            
            try {
                for (let i = 0; i < activeSteps.length; i++) {
                    currentStep = i;
                    renderSteps();
                    updateProgress();
                    
                    await runStep(i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                currentStep = activeSteps.length;
                renderSteps();
                updateProgress();
                
                addTerminalLine('üéâ Infrastructure deployment completed successfully!', 'text-green');
                addTerminalLine('All components are operational and auto-configured.', 'text-green');
                addTerminalLine('Runtime discovery worked perfectly - zero manual coordination!', 'text-green');
                addTerminalLine('üîí Global stats updated securely via Netlify function.', 'text-green');
                
                document.getElementById('status').textContent = 'Complete';
                
            } catch (error) {
                console.error('Deployment error:', error);
                addTerminalLine('‚ùå Deployment failed: ' + error.message, 'text-yellow');
                document.getElementById('status').textContent = 'Failed';
            } finally {
                isRunning = false;
                clearInterval(timer);
                document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
                document.getElementById('deployBtn').disabled = false;
            }
        }
        
        function reset() {
            console.log('Resetting demo...');
            
            if (timer) clearInterval(timer);
            
            isRunning = false;
            currentStep = 0;
            startTime = 0;
            
            document.getElementById('timer').textContent = '0s';
            document.getElementById('status').textContent = 'Ready';
            document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
            document.getElementById('deployBtn').disabled = false;
            
            document.getElementById('terminal').innerHTML = 
                '<div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>';
                
            renderSteps();
            updateProgress();
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Secure infrastructure demo initialized');
            
            // Load global stats securely via Netlify function
            await fetchStats();
            
            setupFeatureToggles();
            document.getElementById('deployBtn').addEventListener('click', deploy);
            document.getElementById('resetBtn').addEventListener('click', reset);
            
            updateStats();
            renderSteps();
            updateProgress();
            
            // Periodic stats refresh for real-time updates
            setInterval(async () => {
                if (!isRunning) {
                    await fetchStats();
                }
            }, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Configuring Infrastructure Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .feature-flags {
            margin-bottom: 20px;
        }
        
        .feature-flags h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .feature-toggle:hover {
            border-color: #cbd5e0;
        }
        
        .feature-toggle.active {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .feature-info .name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .feature-info .desc {
            font-size: 12px;
            color: #718096;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats {
            margin-left: auto;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .usage-stats {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 13px;
            color: #4a5568;
        }
        
        .usage-stats .highlight {
            font-weight: 600;
            color: #2d3748;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 500px;
        }
        
        .steps-panel {
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .terminal-panel {
            background: #1a202c;
            padding: 25px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            max-height: 500px; /* Fixed height to match steps panel */
        }
        
        .terminal-header {
            margin-bottom: 15px;
            color: #a0aec0;
            flex-shrink: 0; /* Don't shrink the header */
        }
        
        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            /* Custom scrollbar styling */
        }
        
        .terminal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .terminal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step.running {
            border-color: #667eea;
            background: #edf2f7;
            animation: pulse 2s infinite;
        }
        
        .step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 14px;
            color: #666;
        }
        
        .terminal-line {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        
        .text-green { color: #68d391; }
        .text-blue { color: #63b3ed; }
        .text-yellow { color: #f6e05e; }
        .text-cyan { color: #76e4f7; }
        .text-gray { color: #a0aec0; }
        
        .progress {
            padding: 20px;
            background: #f7fafc;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #48bb78 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Self-Configuring Infrastructure Demo</h1>
            <p>Experience runtime discovery and automatic dependency resolution!</p>
        </div>
        
        <div class="controls">
            <div class="feature-flags">
                <h3>üéõÔ∏è Feature Flags (Choose Your Adventure)</h3>
                <div class="feature-grid">
                    <div id="feature-loadbalancer" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚öñÔ∏è Load Balancer</div>
                            <div class="desc">HAProxy with dynamic backends</div>
                        </div>
                    </div>
                    <div id="feature-k3s" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚ò∏Ô∏è K3s Cluster</div>
                            <div class="desc">HA Kubernetes cluster</div>
                        </div>
                    </div>
                    <div id="feature-harvester" class="feature-toggle">
                        <input type="checkbox">
                        <div class="feature-info">
                            <div class="name">üåæ Harvester HCI</div>
                            <div class="desc">iPXE network boot (45+ min)</div>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #718096; margin: 0;">
                    üí° Toggle features to see different deployment scenarios. Infrastructure adapts automatically!
                </p>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="control-buttons">
                    <button id="deployBtn" class="btn btn-primary">‚ñ∂Ô∏è Deploy Infrastructure</button>
                    <button id="resetBtn" class="btn btn-secondary">üîÑ Reset</button>
                </div>
                
                <div class="stats">
                    <span>üñ•Ô∏è <span id="vmCount">4 VMs</span></span>
                    <span>üíª <span id="actionCount">6 Actions</span></span>
                    <span>üöÄ <span id="deployCount">0 Deployments</span></span>
                    <span>‚ö° <span id="timer">0s</span></span>
                    <span id="status">Ready</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="steps-panel">
                <h3>Deployment Steps</h3>
                <div id="stepsList">
                    <!-- Steps will be populated here -->
                </div>
            </div>
            
            <div class="terminal-panel">
                <div class="terminal-header">
                    üñ•Ô∏è pulumi-deployment-terminal
                </div>
                <div class="terminal-content" id="terminal">
                    <div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>
                </div>
            </div>
        </div>
        
        <div class="progress">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Progress</span>
                <span id="progressText">0 of 6 steps</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="usage-stats">
            <span id="connectionStatus">üîÑ Connecting to global stats...</span> ‚Ä¢
            <span class="highlight" id="totalDeployments">0</span> total deployments 
            ‚Ä¢ <span class="highlight" id="sessionsToday">0</span> sessions today 
            ‚Ä¢ Last deployment: <span class="highlight" id="lastDeployment">Never</span>
        </div>
    </div>

    <script>
        // Demo state
        let isRunning = false;
        let currentStep = 0;
        let startTime = 0;
        let timer = null;
        let sessionDeployments = 0;
        
        // Global stats tracking via secure Netlify function
        let usageStats = {
            totalDeployments: 0,
            deploymentsToday: 0,
            lastDeployment: null
        };
        
        // Feature flags
        let features = {
            loadbalancer: true,
            k3s: true,
            harvester: false
        };
        
        // Auto-detect Netlify function endpoint
        const isNetlify = window.location.hostname.includes('netlify.app');
        const API_BASE = isNetlify 
            ? `${window.location.origin}/.netlify/functions`
            : 'https://your-site.netlify.app/.netlify/functions';
        
        const allSteps = [
            {
                id: 'env-setup',
                title: "üõ†Ô∏è Environment Setup",
                desc: "Setting up Pulumi and Proxmox connection",
                output: [
                    "Setting environment variables...",
                    "PROXMOX_VE_ENDPOINT=https://192.168.90.102:8006/",
                    "SSH_PUBLIC_KEY loaded from ~/.ssh/id_ed25519.pub",
                    "Initializing Pulumi stack...",
                    "‚úÖ Environment ready for deployment!"
                ],
                requires: []
            },
            {
                id: 'config-validation',
                title: "üìã Configuration Validation", 
                desc: "Validating templates and building dependency map",
                output: [
                    "Loading Pulumi.dev.yaml configuration...",
                    "Validating VM templates...",
                    "Checking feature flags...",
                    "  ‚úÖ loadbalancer: enabled",
                    "  ‚úÖ k3s: enabled", 
                    "  ‚ö™ harvester: disabled",
                    "Building global dependency map...",
                    "‚úÖ Configuration valid, proceeding!"
                ],
                requires: []
            },
            {
                id: 'vm-creation',
                title: "üñ•Ô∏è VM Creation & Role Grouping",
                desc: "Creating VMs and organizing by infrastructure role",
                output: [
                    "Creating VMs from templates...",
                    "Creating VM: loadbalancer-0 (192.168.90.190)",
                    "  Template: ubuntu-22.04-template",
                    "  Role: loadbalancer",
                    "Creating VM: k3s-server-0 (192.168.90.187)",
                    "Creating VM: k3s-server-1 (192.168.90.188)",
                    "Creating VM: k3s-server-2 (192.168.90.189)",
                    "  Template: sle-micro-template", 
                    "  Role: k3s-server",
                    "üîÑ Organizing VMs by role...",
                    "‚úÖ All VMs created and grouped!"
                ],
                requires: []
            },
            {
                id: 'dependency-resolution',
                title: "üîó Global Dependency Resolution",
                desc: "Building runtime discovery map for service coordination",
                output: [
                    "üîç Building global dependency map...",
                    "Scanning role groups for discoverable resources...",
                    "üìä Global Dependencies Available:",
                    "  loadbalancer-ips: [\"192.168.90.190\"]",
                    "  k3s-server-ips: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üéØ Action Execution Plan:",
                    "  1. install-haproxy (depends on: k3s-server-ips)",
                    "  2. install-k3s-server (depends on: loadbalancer)",
                    "‚úÖ Dependencies resolved - ready for execution!"
                ],
                requires: []
            },
            {
                id: 'loadbalancer-setup',
                title: "‚öñÔ∏è HAProxy Load Balancer",
                desc: "Installing HAProxy with dynamic backend discovery",
                output: [
                    "üéØ Executing action: install-haproxy",
                    "üîç Runtime Discovery: Finding k3s-server IPs...",
                    "  Discovered: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üì¶ Installing HAProxy on 192.168.90.190...",
                    "sudo apt update && sudo apt install -y haproxy",
                    "üîß Generating dynamic HAProxy configuration:",
                    "backend k3s-servers",
                    "    server k3s-server-1 192.168.90.187:6443 check",
                    "    server k3s-server-2 192.168.90.188:6443 check", 
                    "    server k3s-server-3 192.168.90.189:6443 check",
                    "sudo systemctl enable --now haproxy",
                    "‚úÖ HAProxy running and ready for K3s traffic!"
                ],
                requires: ['loadbalancer']
            },
            {
                id: 'k3s-cluster',
                title: "‚ò∏Ô∏è K3s High-Availability Cluster",
                desc: "Deploying K3s servers with automatic cluster formation",
                output: [
                    "üéØ Executing action: install-k3s-server",
                    "üîç Runtime Discovery: Finding loadbalancer IP...",
                    "  Discovered LB: 192.168.90.190",
                    "üöÄ Installing K3s on server 1: 192.168.90.187",
                    "curl -sfL https://get.k3s.io | sudo sh -s - server \\",
                    "  --cluster-init \\",
                    "  --tls-san=192.168.90.190",
                    "‚è≥ Waiting for cluster initialization...",
                    "üöÄ Installing K3s on server 2: 192.168.90.188",
                    "üöÄ Installing K3s on server 3: 192.168.90.189",
                    "  Joining cluster through load balancer: 192.168.90.190",
                    "‚úÖ 3-node HA K3s cluster formed automatically!"
                ],
                requires: ['k3s']
            },
            {
                id: 'kubeconfig-extraction',
                title: "üìã Kubeconfig & Verification",
                desc: "Extracting kubeconfig and verifying cluster health",
                output: [
                    "üéØ Executing action: get-kubeconfig",
                    "üîç Runtime Discovery: Finding first k3s server...",
                    "  Discovered: 192.168.90.187",
                    "üìã Extracting kubeconfig from k3s-server-0...",
                    "scp root@192.168.90.187:/etc/rancher/k3s/k3s.yaml ./kubeconfig",
                    "üîç Verifying cluster through load balancer...",
                    "kubectl --kubeconfig=kubeconfig get nodes",
                    "NAME           STATUS   ROLES                  AGE",
                    "k3s-server-0   Ready    control-plane,master   2m",
                    "k3s-server-1   Ready    control-plane,master   1m", 
                    "k3s-server-2   Ready    control-plane,master   1m",
                    "‚úÖ All nodes healthy, cluster ready for workloads!"
                ],
                requires: ['k3s']
            },
            {
                id: 'harvester-deploy',
                title: "üåæ Harvester HCI Platform",
                desc: "Deploying Harvester with iPXE network boot (45+ min)",
                output: [
                    "üéØ Executing action: install-harvester-hci",
                    "‚ö†Ô∏è  WARNING: This is a 45+ minute operation!",
                    "üîç Runtime Discovery: Finding available nodes...",
                    "  Discovered nodes: 3 available for Harvester",
                    "üì° Setting up iPXE network boot infrastructure...",
                    "Configuring DHCP server with iPXE boot options...",
                    "Preparing Harvester ISO for network deployment...",
                    "üöÄ Initiating network boot sequence:",
                    "  Node 1 (192.168.90.200): iPXE boot started",
                    "  Node 2 (192.168.90.201): iPXE boot started",
                    "  Node 3 (192.168.90.202): iPXE boot started",
                    "‚è≥ Installing Harvester OS (this will take 45+ minutes)...",
                    "üìä Progress: Installing base system...",
                    "üìä Progress: Configuring storage pools...",
                    "üìä Progress: Setting up Harvester management cluster...",
                    "‚úÖ Harvester HCI platform deployed successfully!",
                    "üåê Management UI: https://192.168.90.200:8443",
                    "‚ò∏Ô∏è Embedded K8s cluster ready for VM workloads"
                ],
                requires: ['harvester']
            }
        ];
        
        // Secure API functions
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global stats loaded securely via Netlify function');
                return true;
            } catch (error) {
                console.log('üì± Secure API unavailable, using localStorage fallback');
                loadLocalStats();
                return false;
            }
        }
        
        async function incrementStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global deployment count updated securely!');
                return true;
            } catch (error) {
                console.log('üì± Secure API failed, using local increment');
                incrementLocalStats();
                return false;
            }
        }
        
        function loadLocalStats() {
            const stored = localStorage.getItem('demoUsageStats');
            if (stored) {
                usageStats = JSON.parse(stored);
                if (usageStats.lastDeployment) {
                    usageStats.lastDeployment = new Date(usageStats.lastDeployment);
                }
            } else {
                usageStats = {
                    totalDeployments: 0,
                    deploymentsToday: 0,
                    lastDeployment: null
                };
            }
            updateUsageDisplay();
        }
        
        function incrementLocalStats() {
            usageStats.totalDeployments++;
            usageStats.deploymentsToday++;
            usageStats.lastDeployment = new Date();
            localStorage.setItem('demoUsageStats', JSON.stringify(usageStats));
            updateUsageDisplay();
        }
        
        function updateUsageDisplay() {
            document.getElementById('totalDeployments').textContent = usageStats.totalDeployments.toLocaleString();
            document.getElementById('sessionsToday').textContent = usageStats.deploymentsToday;
            
            // Update connection status
            const connectionStatus = document.getElementById('connectionStatus');
            if (API_BASE.includes('netlify')) {
                connectionStatus.innerHTML = 'üîí <strong>Secure Global Stats</strong>';
                connectionStatus.style.color = '#48bb78';
            } else {
                connectionStatus.innerHTML = 'üì± <strong>Local Mode</strong>';
                connectionStatus.style.color = '#f6e05e';
            }
            
            if (usageStats.lastDeployment) {
                const lastTime = usageStats.lastDeployment;
                const now = new Date();
                const diffMinutes = Math.floor((now - lastTime) / 60000);
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Just now';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes}m ago`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)}h ago`;
                } else {
                    timeText = lastTime.toLocaleDateString();
                }
                
                document.getElementById('lastDeployment').textContent = timeText;
            } else {
                document.getElementById('lastDeployment').textContent = 'Never';
            }
            
            document.getElementById('deployCount').textContent = sessionDeployments + ' Session';
        }
        
        function getActiveSteps() {
            return allSteps.filter(step => {
                if (step.requires.length === 0) return true;
                return step.requires.some(req => features[req]);
            });
        }
        
        function updateStats() {
            const activeSteps = getActiveSteps();
            let vmCount = 0;
            
            if (features.loadbalancer) vmCount += 1;
            if (features.k3s) vmCount += 3;
            if (features.harvester) vmCount += 3;
            
            document.getElementById('vmCount').textContent = vmCount + ' VMs';
            document.getElementById('actionCount').textContent = activeSteps.length + ' Actions';
        }
        
        function setupFeatureToggles() {
            ['loadbalancer', 'k3s', 'harvester'].forEach(feature => {
                const toggle = document.getElementById(`feature-${feature}`);
                const checkbox = toggle.querySelector('input');
                
                toggle.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    features[feature] = checkbox.checked;
                    toggle.classList.toggle('active', checkbox.checked);
                    
                    if (!isRunning) {
                        updateStats();
                        renderSteps();
                        updateProgress();
                    }
                });
            });
        }
        
        function updateTimer() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed + 's';
            }
        }
        
        function addTerminalLine(text, className = 'text-gray') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            terminal.appendChild(line);
            
            // Auto-scroll to bottom, but smoothly
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function updateProgress() {
            const activeSteps = getActiveSteps();
            const total = activeSteps.length;
            const completed = currentStep;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} steps`;
        }
        
        function renderSteps() {
            const activeSteps = getActiveSteps();
            const stepsList = document.getElementById('stepsList');
            
            stepsList.innerHTML = activeSteps.map((step, index) => {
                let className = '';
                let icon = '‚è≥';
                
                if (index < currentStep) {
                    className = 'completed';
                    icon = '‚úÖ';
                } else if (index === currentStep && isRunning) {
                    className = 'running';
                    icon = 'üîÑ';
                }
                
                return `
                    <div class="step ${className}">
                        <div class="step-title">${icon} ${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function runStep(stepIndex) {
            const activeSteps = getActiveSteps();
            const step = activeSteps[stepIndex];
            
            addTerminalLine(`üéØ Step ${stepIndex + 1}/${activeSteps.length}: ${step.title}`, 'text-yellow');
            addTerminalLine('', 'text-gray');
            
            for (const line of step.output) {
                await new Promise(resolve => setTimeout(resolve, step.id === 'harvester-deploy' ? 200 : 300));
                
                const className = line.includes('‚úÖ') ? 'text-green' :
                                line.includes('‚ö†Ô∏è') || line.includes('WARNING') ? 'text-yellow' :
                                line.includes('üîç') || line.includes('üìä') || line.includes('üéØ') ? 'text-blue' :
                                line.includes('üöÄ') || line.includes('curl') ? 'text-cyan' :
                                'text-gray';
                                
                addTerminalLine(line, className);
            }
            
            addTerminalLine('', 'text-gray');
        }
        
        async function deploy() {
            if (isRunning) return;
            
            console.log('Starting deployment...');
            
            // Increment global deployment count securely
            sessionDeployments++;
            await incrementStats();
            
            isRunning = true;
            currentStep = 0;
            startTime = Date.now();
            
            const activeSteps = getActiveSteps();
            
            // Update UI
            document.getElementById('deployBtn').textContent = '‚è≥ Deploying...';
            document.getElementById('deployBtn').disabled = true;
            document.getElementById('status').textContent = 'Running...';
            
            // Clear terminal
            document.getElementById('terminal').innerHTML = '';
            
            // Start timer
            timer = setInterval(updateTimer, 1000);
            
            addTerminalLine('üöÄ Starting infrastructure deployment...', 'text-cyan');
            addTerminalLine(`üîí Global deployment #${usageStats.totalDeployments} via secure API`, 'text-blue');
            addTerminalLine('üåç Stats synced globally with zero config exposure!', 'text-cyan');
            addTerminalLine('Components will discover each other automatically!', 'text-cyan');
            addTerminalLine('', 'text-gray');
            
            try {
                for (let i = 0; i < activeSteps.length; i++) {
                    currentStep = i;
                    renderSteps();
                    updateProgress();
                    
                    await runStep(i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                currentStep = activeSteps.length;
                renderSteps();
                updateProgress();
                
                addTerminalLine('üéâ Infrastructure deployment completed successfully!', 'text-green');
                addTerminalLine('All components are operational and auto-configured.', 'text-green');
                addTerminalLine('Runtime discovery worked perfectly - zero manual coordination!', 'text-green');
                addTerminalLine('üîí Global stats updated securely via Netlify function.', 'text-green');
                
                document.getElementById('status').textContent = 'Complete';
                
            } catch (error) {
                console.error('Deployment error:', error);
                addTerminalLine('‚ùå Deployment failed: ' + error.message, 'text-yellow');
                document.getElementById('status').textContent = 'Failed';
            } finally {
                isRunning = false;
                clearInterval(timer);
                document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
                document.getElementById('deployBtn').disabled = false;
            }
        }
        
        function reset() {
            console.log('Resetting demo...');
            
            if (timer) clearInterval(timer);
            
            isRunning = false;
            currentStep = 0;
            startTime = 0;
            
            document.getElementById('timer').textContent = '0s';
            document.getElementById('status').textContent = 'Ready';
            document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
            document.getElementById('deployBtn').disabled = false;
            
            document.getElementById('terminal').innerHTML = 
                '<div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>';
                
            renderSteps();
            updateProgress();
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Secure infrastructure demo initialized');
            
            // Load global stats securely via Netlify function
            await fetchStats();
            
            setupFeatureToggles();
            document.getElementById('deployBtn').addEventListener('click', deploy);
            document.getElementById('resetBtn').addEventListener('click', reset);
            
            updateStats();
            renderSteps();
            updateProgress();
            
            // Periodic stats refresh for real-time updates
            setInterval(async () => {
                if (!isRunning) {
                    await fetchStats();
                }
            }, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Configuring Infrastructure Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .feature-flags {
            margin-bottom: 20px;
        }
        
        .feature-flags h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .feature-toggle:hover {
            border-color: #cbd5e0;
        }
        
        .feature-toggle.active {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .feature-info .name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .feature-info .desc {
            font-size: 12px;
            color: #718096;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats {
            margin-left: auto;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .usage-stats {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 13px;
            color: #4a5568;
        }
        
        .usage-stats .highlight {
            font-weight: 600;
            color: #2d3748;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 500px;
        }
        
        .steps-panel {
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .terminal-panel {
            background: #1a202c;
            padding: 25px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            max-height: 500px; /* Fixed height to match steps panel */
        }
        
        .terminal-header {
            margin-bottom: 15px;
            color: #a0aec0;
            flex-shrink: 0; /* Don't shrink the header */
        }
        
        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            /* Custom scrollbar styling */
        }
        
        .terminal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .terminal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step.running {
            border-color: #667eea;
            background: #edf2f7;
            animation: pulse 2s infinite;
        }
        
        .step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 14px;
            color: #666;
        }
        
        .terminal-line {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        
        .text-green { color: #68d391; }
        .text-blue { color: #63b3ed; }
        .text-yellow { color: #f6e05e; }
        .text-cyan { color: #76e4f7; }
        .text-gray { color: #a0aec0; }
        
        .progress {
            padding: 20px;
            background: #f7fafc;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #48bb78 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Self-Configuring Infrastructure Demo</h1>
            <p>Experience runtime discovery and automatic dependency resolution!</p>
        </div>
        
        <div class="controls">
            <div class="feature-flags">
                <h3>üéõÔ∏è Feature Flags (Choose Your Adventure)</h3>
                <div class="feature-grid">
                    <div id="feature-loadbalancer" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚öñÔ∏è Load Balancer</div>
                            <div class="desc">HAProxy with dynamic backends</div>
                        </div>
                    </div>
                    <div id="feature-k3s" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚ò∏Ô∏è K3s Cluster</div>
                            <div class="desc">HA Kubernetes cluster</div>
                        </div>
                    </div>
                    <div id="feature-harvester" class="feature-toggle">
                        <input type="checkbox">
                        <div class="feature-info">
                            <div class="name">üåæ Harvester HCI</div>
                            <div class="desc">iPXE network boot (45+ min)</div>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #718096; margin: 0;">
                    üí° Toggle features to see different deployment scenarios. Infrastructure adapts automatically!
                </p>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="control-buttons">
                    <button id="deployBtn" class="btn btn-primary">‚ñ∂Ô∏è Deploy Infrastructure</button>
                    <button id="resetBtn" class="btn btn-secondary">üîÑ Reset</button>
                </div>
                
                <div class="stats">
                    <span>üñ•Ô∏è <span id="vmCount">4 VMs</span></span>
                    <span>üíª <span id="actionCount">6 Actions</span></span>
                    <span>üöÄ <span id="deployCount">0 Deployments</span></span>
                    <span>‚ö° <span id="timer">0s</span></span>
                    <span id="status">Ready</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="steps-panel">
                <h3>Deployment Steps</h3>
                <div id="stepsList">
                    <!-- Steps will be populated here -->
                </div>
            </div>
            
            <div class="terminal-panel">
                <div class="terminal-header">
                    üñ•Ô∏è pulumi-deployment-terminal
                </div>
                <div class="terminal-content" id="terminal">
                    <div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>
                </div>
            </div>
        </div>
        
        <div class="progress">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Progress</span>
                <span id="progressText">0 of 6 steps</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="usage-stats">
            <span id="connectionStatus">üîÑ Connecting to global stats...</span> ‚Ä¢
            <span class="highlight" id="totalDeployments">0</span> total deployments 
            ‚Ä¢ <span class="highlight" id="sessionsToday">0</span> sessions today 
            ‚Ä¢ Last deployment: <span class="highlight" id="lastDeployment">Never</span>
        </div>
    </div>

    <script>
        // Demo state
        let isRunning = false;
        let currentStep = 0;
        let startTime = 0;
        let timer = null;
        let sessionDeployments = 0;
        
        // Global stats tracking via secure Netlify function
        let usageStats = {
            totalDeployments: 0,
            deploymentsToday: 0,
            lastDeployment: null
        };
        
        // Feature flags
        let features = {
            loadbalancer: true,
            k3s: true,
            harvester: false
        };
        
        // Auto-detect Netlify function endpoint
        const isNetlify = window.location.hostname.includes('netlify.app');
        const API_BASE = isNetlify 
            ? `${window.location.origin}/.netlify/functions`
            : 'https://your-site.netlify.app/.netlify/functions';
        
        const allSteps = [
            {
                id: 'env-setup',
                title: "üõ†Ô∏è Environment Setup",
                desc: "Setting up Pulumi and Proxmox connection",
                output: [
                    "Setting environment variables...",
                    "PROXMOX_VE_ENDPOINT=https://192.168.90.102:8006/",
                    "SSH_PUBLIC_KEY loaded from ~/.ssh/id_ed25519.pub",
                    "Initializing Pulumi stack...",
                    "‚úÖ Environment ready for deployment!"
                ],
                requires: []
            },
            {
                id: 'config-validation',
                title: "üìã Configuration Validation", 
                desc: "Validating templates and building dependency map",
                output: [
                    "Loading Pulumi.dev.yaml configuration...",
                    "Validating VM templates...",
                    "Checking feature flags...",
                    "  ‚úÖ loadbalancer: enabled",
                    "  ‚úÖ k3s: enabled", 
                    "  ‚ö™ harvester: disabled",
                    "Building global dependency map...",
                    "‚úÖ Configuration valid, proceeding!"
                ],
                requires: []
            },
            {
                id: 'vm-creation',
                title: "üñ•Ô∏è VM Creation & Role Grouping",
                desc: "Creating VMs and organizing by infrastructure role",
                output: [
                    "Creating VMs from templates...",
                    "Creating VM: loadbalancer-0 (192.168.90.190)",
                    "  Template: ubuntu-22.04-template",
                    "  Role: loadbalancer",
                    "Creating VM: k3s-server-0 (192.168.90.187)",
                    "Creating VM: k3s-server-1 (192.168.90.188)",
                    "Creating VM: k3s-server-2 (192.168.90.189)",
                    "  Template: sle-micro-template", 
                    "  Role: k3s-server",
                    "üîÑ Organizing VMs by role...",
                    "‚úÖ All VMs created and grouped!"
                ],
                requires: []
            },
            {
                id: 'dependency-resolution',
                title: "üîó Global Dependency Resolution",
                desc: "Building runtime discovery map for service coordination",
                output: [
                    "üîç Building global dependency map...",
                    "Scanning role groups for discoverable resources...",
                    "üìä Global Dependencies Available:",
                    "  loadbalancer-ips: [\"192.168.90.190\"]",
                    "  k3s-server-ips: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üéØ Action Execution Plan:",
                    "  1. install-haproxy (depends on: k3s-server-ips)",
                    "  2. install-k3s-server (depends on: loadbalancer)",
                    "‚úÖ Dependencies resolved - ready for execution!"
                ],
                requires: []
            },
            {
                id: 'loadbalancer-setup',
                title: "‚öñÔ∏è HAProxy Load Balancer",
                desc: "Installing HAProxy with dynamic backend discovery",
                output: [
                    "üéØ Executing action: install-haproxy",
                    "üîç Runtime Discovery: Finding k3s-server IPs...",
                    "  Discovered: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üì¶ Installing HAProxy on 192.168.90.190...",
                    "sudo apt update && sudo apt install -y haproxy",
                    "üîß Generating dynamic HAProxy configuration:",
                    "backend k3s-servers",
                    "    server k3s-server-1 192.168.90.187:6443 check",
                    "    server k3s-server-2 192.168.90.188:6443 check", 
                    "    server k3s-server-3 192.168.90.189:6443 check",
                    "sudo systemctl enable --now haproxy",
                    "‚úÖ HAProxy running and ready for K3s traffic!"
                ],
                requires: ['loadbalancer']
            },
            {
                id: 'k3s-cluster',
                title: "‚ò∏Ô∏è K3s High-Availability Cluster",
                desc: "Deploying K3s servers with automatic cluster formation",
                output: [
                    "üéØ Executing action: install-k3s-server",
                    "üîç Runtime Discovery: Finding loadbalancer IP...",
                    "  Discovered LB: 192.168.90.190",
                    "üöÄ Installing K3s on server 1: 192.168.90.187",
                    "curl -sfL https://get.k3s.io | sudo sh -s - server \\",
                    "  --cluster-init \\",
                    "  --tls-san=192.168.90.190",
                    "‚è≥ Waiting for cluster initialization...",
                    "üöÄ Installing K3s on server 2: 192.168.90.188",
                    "üöÄ Installing K3s on server 3: 192.168.90.189",
                    "  Joining cluster through load balancer: 192.168.90.190",
                    "‚úÖ 3-node HA K3s cluster formed automatically!"
                ],
                requires: ['k3s']
            },
            {
                id: 'kubeconfig-extraction',
                title: "üìã Kubeconfig & Verification",
                desc: "Extracting kubeconfig and verifying cluster health",
                output: [
                    "üéØ Executing action: get-kubeconfig",
                    "üîç Runtime Discovery: Finding first k3s server...",
                    "  Discovered: 192.168.90.187",
                    "üìã Extracting kubeconfig from k3s-server-0...",
                    "scp root@192.168.90.187:/etc/rancher/k3s/k3s.yaml ./kubeconfig",
                    "üîç Verifying cluster through load balancer...",
                    "kubectl --kubeconfig=kubeconfig get nodes",
                    "NAME           STATUS   ROLES                  AGE",
                    "k3s-server-0   Ready    control-plane,master   2m",
                    "k3s-server-1   Ready    control-plane,master   1m", 
                    "k3s-server-2   Ready    control-plane,master   1m",
                    "‚úÖ All nodes healthy, cluster ready for workloads!"
                ],
                requires: ['k3s']
            },
            {
                id: 'harvester-deploy',
                title: "üåæ Harvester HCI Platform",
                desc: "Deploying Harvester with iPXE network boot (45+ min)",
                output: [
                    "üéØ Executing action: install-harvester-hci",
                    "‚ö†Ô∏è  WARNING: This is a 45+ minute operation!",
                    "üîç Runtime Discovery: Finding available nodes...",
                    "  Discovered nodes: 3 available for Harvester",
                    "üì° Setting up iPXE network boot infrastructure...",
                    "Configuring DHCP server with iPXE boot options...",
                    "Preparing Harvester ISO for network deployment...",
                    "üöÄ Initiating network boot sequence:",
                    "  Node 1 (192.168.90.200): iPXE boot started",
                    "  Node 2 (192.168.90.201): iPXE boot started",
                    "  Node 3 (192.168.90.202): iPXE boot started",
                    "‚è≥ Installing Harvester OS (this will take 45+ minutes)...",
                    "üìä Progress: Installing base system...",
                    "üìä Progress: Configuring storage pools...",
                    "üìä Progress: Setting up Harvester management cluster...",
                    "‚úÖ Harvester HCI platform deployed successfully!",
                    "üåê Management UI: https://192.168.90.200:8443",
                    "‚ò∏Ô∏è Embedded K8s cluster ready for VM workloads"
                ],
                requires: ['harvester']
            }
        ];
        
        // Secure API functions
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global stats loaded securely via Netlify function');
                return true;
            } catch (error) {
                console.log('üì± Secure API unavailable, using localStorage fallback');
                loadLocalStats();
                return false;
            }
        }
        
        async function incrementStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global deployment count updated securely!');
                return true;
            } catch (error) {
                console.log('üì± Secure API failed, using local increment');
                incrementLocalStats();
                return false;
            }
        }
        
        function loadLocalStats() {
            const stored = localStorage.getItem('demoUsageStats');
            if (stored) {
                usageStats = JSON.parse(stored);
                if (usageStats.lastDeployment) {
                    usageStats.lastDeployment = new Date(usageStats.lastDeployment);
                }
            } else {
                usageStats = {
                    totalDeployments: 0,
                    deploymentsToday: 0,
                    lastDeployment: null
                };
            }
            updateUsageDisplay();
        }
        
        function incrementLocalStats() {
            usageStats.totalDeployments++;
            usageStats.deploymentsToday++;
            usageStats.lastDeployment = new Date();
            localStorage.setItem('demoUsageStats', JSON.stringify(usageStats));
            updateUsageDisplay();
        }
        
        function updateUsageDisplay() {
            document.getElementById('totalDeployments').textContent = usageStats.totalDeployments.toLocaleString();
            document.getElementById('sessionsToday').textContent = usageStats.deploymentsToday;
            
            // Update connection status
            const connectionStatus = document.getElementById('connectionStatus');
            if (API_BASE.includes('netlify')) {
                connectionStatus.innerHTML = 'üîí <strong>Secure Global Stats</strong>';
                connectionStatus.style.color = '#48bb78';
            } else {
                connectionStatus.innerHTML = 'üì± <strong>Local Mode</strong>';
                connectionStatus.style.color = '#f6e05e';
            }
            
            if (usageStats.lastDeployment) {
                const lastTime = usageStats.lastDeployment;
                const now = new Date();
                const diffMinutes = Math.floor((now - lastTime) / 60000);
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Just now';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes}m ago`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)}h ago`;
                } else {
                    timeText = lastTime.toLocaleDateString();
                }
                
                document.getElementById('lastDeployment').textContent = timeText;
            } else {
                document.getElementById('lastDeployment').textContent = 'Never';
            }
            
            document.getElementById('deployCount').textContent = sessionDeployments + ' Session';
        }
        
        function getActiveSteps() {
            return allSteps.filter(step => {
                if (step.requires.length === 0) return true;
                return step.requires.some(req => features[req]);
            });
        }
        
        function updateStats() {
            const activeSteps = getActiveSteps();
            let vmCount = 0;
            
            if (features.loadbalancer) vmCount += 1;
            if (features.k3s) vmCount += 3;
            if (features.harvester) vmCount += 3;
            
            document.getElementById('vmCount').textContent = vmCount + ' VMs';
            document.getElementById('actionCount').textContent = activeSteps.length + ' Actions';
        }
        
        function setupFeatureToggles() {
            ['loadbalancer', 'k3s', 'harvester'].forEach(feature => {
                const toggle = document.getElementById(`feature-${feature}`);
                const checkbox = toggle.querySelector('input');
                
                toggle.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    features[feature] = checkbox.checked;
                    toggle.classList.toggle('active', checkbox.checked);
                    
                    if (!isRunning) {
                        updateStats();
                        renderSteps();
                        updateProgress();
                    }
                });
            });
        }
        
        function updateTimer() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed + 's';
            }
        }
        
        function addTerminalLine(text, className = 'text-gray') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            terminal.appendChild(line);
            
            // Auto-scroll to bottom, but smoothly
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function updateProgress() {
            const activeSteps = getActiveSteps();
            const total = activeSteps.length;
            const completed = currentStep;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} steps`;
        }
        
        function renderSteps() {
            const activeSteps = getActiveSteps();
            const stepsList = document.getElementById('stepsList');
            
            stepsList.innerHTML = activeSteps.map((step, index) => {
                let className = '';
                let icon = '‚è≥';
                
                if (index < currentStep) {
                    className = 'completed';
                    icon = '‚úÖ';
                } else if (index === currentStep && isRunning) {
                    className = 'running';
                    icon = 'üîÑ';
                }
                
                return `
                    <div class="step ${className}">
                        <div class="step-title">${icon} ${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function runStep(stepIndex) {
            const activeSteps = getActiveSteps();
            const step = activeSteps[stepIndex];
            
            addTerminalLine(`üéØ Step ${stepIndex + 1}/${activeSteps.length}: ${step.title}`, 'text-yellow');
            addTerminalLine('', 'text-gray');
            
            for (const line of step.output) {
                await new Promise(resolve => setTimeout(resolve, step.id === 'harvester-deploy' ? 200 : 300));
                
                const className = line.includes('‚úÖ') ? 'text-green' :
                                line.includes('‚ö†Ô∏è') || line.includes('WARNING') ? 'text-yellow' :
                                line.includes('üîç') || line.includes('üìä') || line.includes('üéØ') ? 'text-blue' :
                                line.includes('üöÄ') || line.includes('curl') ? 'text-cyan' :
                                'text-gray';
                                
                addTerminalLine(line, className);
            }
            
            addTerminalLine('', 'text-gray');
        }
        
        async function deploy() {
            if (isRunning) return;
            
            console.log('Starting deployment...');
            
            // Increment global deployment count securely
            sessionDeployments++;
            await incrementStats();
            
            isRunning = true;
            currentStep = 0;
            startTime = Date.now();
            
            const activeSteps = getActiveSteps();
            
            // Update UI
            document.getElementById('deployBtn').textContent = '‚è≥ Deploying...';
            document.getElementById('deployBtn').disabled = true;
            document.getElementById('status').textContent = 'Running...';
            
            // Clear terminal
            document.getElementById('terminal').innerHTML = '';
            
            // Start timer
            timer = setInterval(updateTimer, 1000);
            
            addTerminalLine('üöÄ Starting infrastructure deployment...', 'text-cyan');
            addTerminalLine(`üîí Global deployment #${usageStats.totalDeployments} via secure API`, 'text-blue');
            addTerminalLine('üåç Stats synced globally with zero config exposure!', 'text-cyan');
            addTerminalLine('Components will discover each other automatically!', 'text-cyan');
            addTerminalLine('', 'text-gray');
            
            try {
                for (let i = 0; i < activeSteps.length; i++) {
                    currentStep = i;
                    renderSteps();
                    updateProgress();
                    
                    await runStep(i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                currentStep = activeSteps.length;
                renderSteps();
                updateProgress();
                
                addTerminalLine('üéâ Infrastructure deployment completed successfully!', 'text-green');
                addTerminalLine('All components are operational and auto-configured.', 'text-green');
                addTerminalLine('Runtime discovery worked perfectly - zero manual coordination!', 'text-green');
                addTerminalLine('üîí Global stats updated securely via Netlify function.', 'text-green');
                
                document.getElementById('status').textContent = 'Complete';
                
            } catch (error) {
                console.error('Deployment error:', error);
                addTerminalLine('‚ùå Deployment failed: ' + error.message, 'text-yellow');
                document.getElementById('status').textContent = 'Failed';
            } finally {
                isRunning = false;
                clearInterval(timer);
                document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
                document.getElementById('deployBtn').disabled = false;
            }
        }
        
        function reset() {
            console.log('Resetting demo...');
            
            if (timer) clearInterval(timer);
            
            isRunning = false;
            currentStep = 0;
            startTime = 0;
            
            document.getElementById('timer').textContent = '0s';
            document.getElementById('status').textContent = 'Ready';
            document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
            document.getElementById('deployBtn').disabled = false;
            
            document.getElementById('terminal').innerHTML = 
                '<div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>';
                
            renderSteps();
            updateProgress();
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Secure infrastructure demo initialized');
            
            // Load global stats securely via Netlify function
            await fetchStats();
            
            setupFeatureToggles();
            document.getElementById('deployBtn').addEventListener('click', deploy);
            document.getElementById('resetBtn').addEventListener('click', reset);
            
            updateStats();
            renderSteps();
            updateProgress();
            
            // Periodic stats refresh for real-time updates
            setInterval(async () => {
                if (!isRunning) {
                    await fetchStats();
                }
            }, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Configuring Infrastructure Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .feature-flags {
            margin-bottom: 20px;
        }
        
        .feature-flags h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .feature-toggle:hover {
            border-color: #cbd5e0;
        }
        
        .feature-toggle.active {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .feature-info .name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .feature-info .desc {
            font-size: 12px;
            color: #718096;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats {
            margin-left: auto;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .usage-stats {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 13px;
            color: #4a5568;
        }
        
        .usage-stats .highlight {
            font-weight: 600;
            color: #2d3748;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 500px;
        }
        
        .steps-panel {
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .terminal-panel {
            background: #1a202c;
            padding: 25px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            max-height: 500px; /* Fixed height to match steps panel */
        }
        
        .terminal-header {
            margin-bottom: 15px;
            color: #a0aec0;
            flex-shrink: 0; /* Don't shrink the header */
        }
        
        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            /* Custom scrollbar styling */
        }
        
        .terminal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .terminal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step.running {
            border-color: #667eea;
            background: #edf2f7;
            animation: pulse 2s infinite;
        }
        
        .step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 14px;
            color: #666;
        }
        
        .terminal-line {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        
        .text-green { color: #68d391; }
        .text-blue { color: #63b3ed; }
        .text-yellow { color: #f6e05e; }
        .text-cyan { color: #76e4f7; }
        .text-gray { color: #a0aec0; }
        
        .progress {
            padding: 20px;
            background: #f7fafc;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #48bb78 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Self-Configuring Infrastructure Demo</h1>
            <p>Experience runtime discovery and automatic dependency resolution!</p>
        </div>
        
        <div class="controls">
            <div class="feature-flags">
                <h3>üéõÔ∏è Feature Flags (Choose Your Adventure)</h3>
                <div class="feature-grid">
                    <div id="feature-loadbalancer" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚öñÔ∏è Load Balancer</div>
                            <div class="desc">HAProxy with dynamic backends</div>
                        </div>
                    </div>
                    <div id="feature-k3s" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚ò∏Ô∏è K3s Cluster</div>
                            <div class="desc">HA Kubernetes cluster</div>
                        </div>
                    </div>
                    <div id="feature-harvester" class="feature-toggle">
                        <input type="checkbox">
                        <div class="feature-info">
                            <div class="name">üåæ Harvester HCI</div>
                            <div class="desc">iPXE network boot (45+ min)</div>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #718096; margin: 0;">
                    üí° Toggle features to see different deployment scenarios. Infrastructure adapts automatically!
                </p>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="control-buttons">
                    <button id="deployBtn" class="btn btn-primary">‚ñ∂Ô∏è Deploy Infrastructure</button>
                    <button id="resetBtn" class="btn btn-secondary">üîÑ Reset</button>
                </div>
                
                <div class="stats">
                    <span>üñ•Ô∏è <span id="vmCount">4 VMs</span></span>
                    <span>üíª <span id="actionCount">6 Actions</span></span>
                    <span>üöÄ <span id="deployCount">0 Deployments</span></span>
                    <span>‚ö° <span id="timer">0s</span></span>
                    <span id="status">Ready</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="steps-panel">
                <h3>Deployment Steps</h3>
                <div id="stepsList">
                    <!-- Steps will be populated here -->
                </div>
            </div>
            
            <div class="terminal-panel">
                <div class="terminal-header">
                    üñ•Ô∏è pulumi-deployment-terminal
                </div>
                <div class="terminal-content" id="terminal">
                    <div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>
                </div>
            </div>
        </div>
        
        <div class="progress">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Progress</span>
                <span id="progressText">0 of 6 steps</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="usage-stats">
            <span id="connectionStatus">üîÑ Connecting to global stats...</span> ‚Ä¢
            <span class="highlight" id="totalDeployments">0</span> total deployments 
            ‚Ä¢ <span class="highlight" id="sessionsToday">0</span> sessions today 
            ‚Ä¢ Last deployment: <span class="highlight" id="lastDeployment">Never</span>
        </div>
    </div>

    <script>
        // Demo state
        let isRunning = false;
        let currentStep = 0;
        let startTime = 0;
        let timer = null;
        let sessionDeployments = 0;
        
        // Global stats tracking via secure Netlify function
        let usageStats = {
            totalDeployments: 0,
            deploymentsToday: 0,
            lastDeployment: null
        };
        
        // Feature flags
        let features = {
            loadbalancer: true,
            k3s: true,
            harvester: false
        };
        
        // Auto-detect Netlify function endpoint
        const isNetlify = window.location.hostname.includes('netlify.app');
        const API_BASE = isNetlify 
            ? `${window.location.origin}/.netlify/functions`
            : 'https://your-site.netlify.app/.netlify/functions';
        
        const allSteps = [
            {
                id: 'env-setup',
                title: "üõ†Ô∏è Environment Setup",
                desc: "Setting up Pulumi and Proxmox connection",
                output: [
                    "Setting environment variables...",
                    "PROXMOX_VE_ENDPOINT=https://192.168.90.102:8006/",
                    "SSH_PUBLIC_KEY loaded from ~/.ssh/id_ed25519.pub",
                    "Initializing Pulumi stack...",
                    "‚úÖ Environment ready for deployment!"
                ],
                requires: []
            },
            {
                id: 'config-validation',
                title: "üìã Configuration Validation", 
                desc: "Validating templates and building dependency map",
                output: [
                    "Loading Pulumi.dev.yaml configuration...",
                    "Validating VM templates...",
                    "Checking feature flags...",
                    "  ‚úÖ loadbalancer: enabled",
                    "  ‚úÖ k3s: enabled", 
                    "  ‚ö™ harvester: disabled",
                    "Building global dependency map...",
                    "‚úÖ Configuration valid, proceeding!"
                ],
                requires: []
            },
            {
                id: 'vm-creation',
                title: "üñ•Ô∏è VM Creation & Role Grouping",
                desc: "Creating VMs and organizing by infrastructure role",
                output: [
                    "Creating VMs from templates...",
                    "Creating VM: loadbalancer-0 (192.168.90.190)",
                    "  Template: ubuntu-22.04-template",
                    "  Role: loadbalancer",
                    "Creating VM: k3s-server-0 (192.168.90.187)",
                    "Creating VM: k3s-server-1 (192.168.90.188)",
                    "Creating VM: k3s-server-2 (192.168.90.189)",
                    "  Template: sle-micro-template", 
                    "  Role: k3s-server",
                    "üîÑ Organizing VMs by role...",
                    "‚úÖ All VMs created and grouped!"
                ],
                requires: []
            },
            {
                id: 'dependency-resolution',
                title: "üîó Global Dependency Resolution",
                desc: "Building runtime discovery map for service coordination",
                output: [
                    "üîç Building global dependency map...",
                    "Scanning role groups for discoverable resources...",
                    "üìä Global Dependencies Available:",
                    "  loadbalancer-ips: [\"192.168.90.190\"]",
                    "  k3s-server-ips: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üéØ Action Execution Plan:",
                    "  1. install-haproxy (depends on: k3s-server-ips)",
                    "  2. install-k3s-server (depends on: loadbalancer)",
                    "‚úÖ Dependencies resolved - ready for execution!"
                ],
                requires: []
            },
            {
                id: 'loadbalancer-setup',
                title: "‚öñÔ∏è HAProxy Load Balancer",
                desc: "Installing HAProxy with dynamic backend discovery",
                output: [
                    "üéØ Executing action: install-haproxy",
                    "üîç Runtime Discovery: Finding k3s-server IPs...",
                    "  Discovered: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üì¶ Installing HAProxy on 192.168.90.190...",
                    "sudo apt update && sudo apt install -y haproxy",
                    "üîß Generating dynamic HAProxy configuration:",
                    "backend k3s-servers",
                    "    server k3s-server-1 192.168.90.187:6443 check",
                    "    server k3s-server-2 192.168.90.188:6443 check", 
                    "    server k3s-server-3 192.168.90.189:6443 check",
                    "sudo systemctl enable --now haproxy",
                    "‚úÖ HAProxy running and ready for K3s traffic!"
                ],
                requires: ['loadbalancer']
            },
            {
                id: 'k3s-cluster',
                title: "‚ò∏Ô∏è K3s High-Availability Cluster",
                desc: "Deploying K3s servers with automatic cluster formation",
                output: [
                    "üéØ Executing action: install-k3s-server",
                    "üîç Runtime Discovery: Finding loadbalancer IP...",
                    "  Discovered LB: 192.168.90.190",
                    "üöÄ Installing K3s on server 1: 192.168.90.187",
                    "curl -sfL https://get.k3s.io | sudo sh -s - server \\",
                    "  --cluster-init \\",
                    "  --tls-san=192.168.90.190",
                    "‚è≥ Waiting for cluster initialization...",
                    "üöÄ Installing K3s on server 2: 192.168.90.188",
                    "üöÄ Installing K3s on server 3: 192.168.90.189",
                    "  Joining cluster through load balancer: 192.168.90.190",
                    "‚úÖ 3-node HA K3s cluster formed automatically!"
                ],
                requires: ['k3s']
            },
            {
                id: 'kubeconfig-extraction',
                title: "üìã Kubeconfig & Verification",
                desc: "Extracting kubeconfig and verifying cluster health",
                output: [
                    "üéØ Executing action: get-kubeconfig",
                    "üîç Runtime Discovery: Finding first k3s server...",
                    "  Discovered: 192.168.90.187",
                    "üìã Extracting kubeconfig from k3s-server-0...",
                    "scp root@192.168.90.187:/etc/rancher/k3s/k3s.yaml ./kubeconfig",
                    "üîç Verifying cluster through load balancer...",
                    "kubectl --kubeconfig=kubeconfig get nodes",
                    "NAME           STATUS   ROLES                  AGE",
                    "k3s-server-0   Ready    control-plane,master   2m",
                    "k3s-server-1   Ready    control-plane,master   1m", 
                    "k3s-server-2   Ready    control-plane,master   1m",
                    "‚úÖ All nodes healthy, cluster ready for workloads!"
                ],
                requires: ['k3s']
            },
            {
                id: 'harvester-deploy',
                title: "üåæ Harvester HCI Platform",
                desc: "Deploying Harvester with iPXE network boot (45+ min)",
                output: [
                    "üéØ Executing action: install-harvester-hci",
                    "‚ö†Ô∏è  WARNING: This is a 45+ minute operation!",
                    "üîç Runtime Discovery: Finding available nodes...",
                    "  Discovered nodes: 3 available for Harvester",
                    "üì° Setting up iPXE network boot infrastructure...",
                    "Configuring DHCP server with iPXE boot options...",
                    "Preparing Harvester ISO for network deployment...",
                    "üöÄ Initiating network boot sequence:",
                    "  Node 1 (192.168.90.200): iPXE boot started",
                    "  Node 2 (192.168.90.201): iPXE boot started",
                    "  Node 3 (192.168.90.202): iPXE boot started",
                    "‚è≥ Installing Harvester OS (this will take 45+ minutes)...",
                    "üìä Progress: Installing base system...",
                    "üìä Progress: Configuring storage pools...",
                    "üìä Progress: Setting up Harvester management cluster...",
                    "‚úÖ Harvester HCI platform deployed successfully!",
                    "üåê Management UI: https://192.168.90.200:8443",
                    "‚ò∏Ô∏è Embedded K8s cluster ready for VM workloads"
                ],
                requires: ['harvester']
            }
        ];
        
        // Secure API functions
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global stats loaded securely via Netlify function');
                return true;
            } catch (error) {
                console.log('üì± Secure API unavailable, using localStorage fallback');
                loadLocalStats();
                return false;
            }
        }
        
        async function incrementStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global deployment count updated securely!');
                return true;
            } catch (error) {
                console.log('üì± Secure API failed, using local increment');
                incrementLocalStats();
                return false;
            }
        }
        
        function loadLocalStats() {
            const stored = localStorage.getItem('demoUsageStats');
            if (stored) {
                usageStats = JSON.parse(stored);
                if (usageStats.lastDeployment) {
                    usageStats.lastDeployment = new Date(usageStats.lastDeployment);
                }
            } else {
                usageStats = {
                    totalDeployments: 0,
                    deploymentsToday: 0,
                    lastDeployment: null
                };
            }
            updateUsageDisplay();
        }
        
        function incrementLocalStats() {
            usageStats.totalDeployments++;
            usageStats.deploymentsToday++;
            usageStats.lastDeployment = new Date();
            localStorage.setItem('demoUsageStats', JSON.stringify(usageStats));
            updateUsageDisplay();
        }
        
        function updateUsageDisplay() {
            document.getElementById('totalDeployments').textContent = usageStats.totalDeployments.toLocaleString();
            document.getElementById('sessionsToday').textContent = usageStats.deploymentsToday;
            
            // Update connection status
            const connectionStatus = document.getElementById('connectionStatus');
            if (API_BASE.includes('netlify')) {
                connectionStatus.innerHTML = 'üîí <strong>Secure Global Stats</strong>';
                connectionStatus.style.color = '#48bb78';
            } else {
                connectionStatus.innerHTML = 'üì± <strong>Local Mode</strong>';
                connectionStatus.style.color = '#f6e05e';
            }
            
            if (usageStats.lastDeployment) {
                const lastTime = usageStats.lastDeployment;
                const now = new Date();
                const diffMinutes = Math.floor((now - lastTime) / 60000);
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Just now';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes}m ago`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)}h ago`;
                } else {
                    timeText = lastTime.toLocaleDateString();
                }
                
                document.getElementById('lastDeployment').textContent = timeText;
            } else {
                document.getElementById('lastDeployment').textContent = 'Never';
            }
            
            document.getElementById('deployCount').textContent = sessionDeployments + ' Session';
        }
        
        function getActiveSteps() {
            return allSteps.filter(step => {
                if (step.requires.length === 0) return true;
                return step.requires.some(req => features[req]);
            });
        }
        
        function updateStats() {
            const activeSteps = getActiveSteps();
            let vmCount = 0;
            
            if (features.loadbalancer) vmCount += 1;
            if (features.k3s) vmCount += 3;
            if (features.harvester) vmCount += 3;
            
            document.getElementById('vmCount').textContent = vmCount + ' VMs';
            document.getElementById('actionCount').textContent = activeSteps.length + ' Actions';
        }
        
        function setupFeatureToggles() {
            ['loadbalancer', 'k3s', 'harvester'].forEach(feature => {
                const toggle = document.getElementById(`feature-${feature}`);
                const checkbox = toggle.querySelector('input');
                
                toggle.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    features[feature] = checkbox.checked;
                    toggle.classList.toggle('active', checkbox.checked);
                    
                    if (!isRunning) {
                        updateStats();
                        renderSteps();
                        updateProgress();
                    }
                });
            });
        }
        
        function updateTimer() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed + 's';
            }
        }
        
        function addTerminalLine(text, className = 'text-gray') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            terminal.appendChild(line);
            
            // Auto-scroll to bottom, but smoothly
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function updateProgress() {
            const activeSteps = getActiveSteps();
            const total = activeSteps.length;
            const completed = currentStep;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} steps`;
        }
        
        function renderSteps() {
            const activeSteps = getActiveSteps();
            const stepsList = document.getElementById('stepsList');
            
            stepsList.innerHTML = activeSteps.map((step, index) => {
                let className = '';
                let icon = '‚è≥';
                
                if (index < currentStep) {
                    className = 'completed';
                    icon = '‚úÖ';
                } else if (index === currentStep && isRunning) {
                    className = 'running';
                    icon = 'üîÑ';
                }
                
                return `
                    <div class="step ${className}">
                        <div class="step-title">${icon} ${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function runStep(stepIndex) {
            const activeSteps = getActiveSteps();
            const step = activeSteps[stepIndex];
            
            addTerminalLine(`üéØ Step ${stepIndex + 1}/${activeSteps.length}: ${step.title}`, 'text-yellow');
            addTerminalLine('', 'text-gray');
            
            for (const line of step.output) {
                await new Promise(resolve => setTimeout(resolve, step.id === 'harvester-deploy' ? 200 : 300));
                
                const className = line.includes('‚úÖ') ? 'text-green' :
                                line.includes('‚ö†Ô∏è') || line.includes('WARNING') ? 'text-yellow' :
                                line.includes('üîç') || line.includes('üìä') || line.includes('üéØ') ? 'text-blue' :
                                line.includes('üöÄ') || line.includes('curl') ? 'text-cyan' :
                                'text-gray';
                                
                addTerminalLine(line, className);
            }
            
            addTerminalLine('', 'text-gray');
        }
        
        async function deploy() {
            if (isRunning) return;
            
            console.log('Starting deployment...');
            
            // Increment global deployment count securely
            sessionDeployments++;
            await incrementStats();
            
            isRunning = true;
            currentStep = 0;
            startTime = Date.now();
            
            const activeSteps = getActiveSteps();
            
            // Update UI
            document.getElementById('deployBtn').textContent = '‚è≥ Deploying...';
            document.getElementById('deployBtn').disabled = true;
            document.getElementById('status').textContent = 'Running...';
            
            // Clear terminal
            document.getElementById('terminal').innerHTML = '';
            
            // Start timer
            timer = setInterval(updateTimer, 1000);
            
            addTerminalLine('üöÄ Starting infrastructure deployment...', 'text-cyan');
            addTerminalLine(`üîí Global deployment #${usageStats.totalDeployments} via secure API`, 'text-blue');
            addTerminalLine('üåç Stats synced globally with zero config exposure!', 'text-cyan');
            addTerminalLine('Components will discover each other automatically!', 'text-cyan');
            addTerminalLine('', 'text-gray');
            
            try {
                for (let i = 0; i < activeSteps.length; i++) {
                    currentStep = i;
                    renderSteps();
                    updateProgress();
                    
                    await runStep(i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                currentStep = activeSteps.length;
                renderSteps();
                updateProgress();
                
                addTerminalLine('üéâ Infrastructure deployment completed successfully!', 'text-green');
                addTerminalLine('All components are operational and auto-configured.', 'text-green');
                addTerminalLine('Runtime discovery worked perfectly - zero manual coordination!', 'text-green');
                addTerminalLine('üîí Global stats updated securely via Netlify function.', 'text-green');
                
                document.getElementById('status').textContent = 'Complete';
                
            } catch (error) {
                console.error('Deployment error:', error);
                addTerminalLine('‚ùå Deployment failed: ' + error.message, 'text-yellow');
                document.getElementById('status').textContent = 'Failed';
            } finally {
                isRunning = false;
                clearInterval(timer);
                document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
                document.getElementById('deployBtn').disabled = false;
            }
        }
        
        function reset() {
            console.log('Resetting demo...');
            
            if (timer) clearInterval(timer);
            
            isRunning = false;
            currentStep = 0;
            startTime = 0;
            
            document.getElementById('timer').textContent = '0s';
            document.getElementById('status').textContent = 'Ready';
            document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
            document.getElementById('deployBtn').disabled = false;
            
            document.getElementById('terminal').innerHTML = 
                '<div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>';
                
            renderSteps();
            updateProgress();
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Secure infrastructure demo initialized');
            
            // Load global stats securely via Netlify function
            await fetchStats();
            
            setupFeatureToggles();
            document.getElementById('deployBtn').addEventListener('click', deploy);
            document.getElementById('resetBtn').addEventListener('click', reset);
            
            updateStats();
            renderSteps();
            updateProgress();
            
            // Periodic stats refresh for real-time updates
            setInterval(async () => {
                if (!isRunning) {
                    await fetchStats();
                }
            }, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Configuring Infrastructure Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .feature-flags {
            margin-bottom: 20px;
        }
        
        .feature-flags h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .feature-toggle:hover {
            border-color: #cbd5e0;
        }
        
        .feature-toggle.active {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .feature-info .name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .feature-info .desc {
            font-size: 12px;
            color: #718096;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats {
            margin-left: auto;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .usage-stats {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 13px;
            color: #4a5568;
        }
        
        .usage-stats .highlight {
            font-weight: 600;
            color: #2d3748;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 500px;
        }
        
        .steps-panel {
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .terminal-panel {
            background: #1a202c;
            padding: 25px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            max-height: 500px; /* Fixed height to match steps panel */
        }
        
        .terminal-header {
            margin-bottom: 15px;
            color: #a0aec0;
            flex-shrink: 0; /* Don't shrink the header */
        }
        
        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            /* Custom scrollbar styling */
        }
        
        .terminal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .terminal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step.running {
            border-color: #667eea;
            background: #edf2f7;
            animation: pulse 2s infinite;
        }
        
        .step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 14px;
            color: #666;
        }
        
        .terminal-line {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        
        .text-green { color: #68d391; }
        .text-blue { color: #63b3ed; }
        .text-yellow { color: #f6e05e; }
        .text-cyan { color: #76e4f7; }
        .text-gray { color: #a0aec0; }
        
        .progress {
            padding: 20px;
            background: #f7fafc;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #48bb78 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Self-Configuring Infrastructure Demo</h1>
            <p>Experience runtime discovery and automatic dependency resolution!</p>
        </div>
        
        <div class="controls">
            <div class="feature-flags">
                <h3>üéõÔ∏è Feature Flags (Choose Your Adventure)</h3>
                <div class="feature-grid">
                    <div id="feature-loadbalancer" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚öñÔ∏è Load Balancer</div>
                            <div class="desc">HAProxy with dynamic backends</div>
                        </div>
                    </div>
                    <div id="feature-k3s" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚ò∏Ô∏è K3s Cluster</div>
                            <div class="desc">HA Kubernetes cluster</div>
                        </div>
                    </div>
                    <div id="feature-harvester" class="feature-toggle">
                        <input type="checkbox">
                        <div class="feature-info">
                            <div class="name">üåæ Harvester HCI</div>
                            <div class="desc">iPXE network boot (45+ min)</div>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #718096; margin: 0;">
                    üí° Toggle features to see different deployment scenarios. Infrastructure adapts automatically!
                </p>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="control-buttons">
                    <button id="deployBtn" class="btn btn-primary">‚ñ∂Ô∏è Deploy Infrastructure</button>
                    <button id="resetBtn" class="btn btn-secondary">üîÑ Reset</button>
                </div>
                
                <div class="stats">
                    <span>üñ•Ô∏è <span id="vmCount">4 VMs</span></span>
                    <span>üíª <span id="actionCount">6 Actions</span></span>
                    <span>üöÄ <span id="deployCount">0 Deployments</span></span>
                    <span>‚ö° <span id="timer">0s</span></span>
                    <span id="status">Ready</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="steps-panel">
                <h3>Deployment Steps</h3>
                <div id="stepsList">
                    <!-- Steps will be populated here -->
                </div>
            </div>
            
            <div class="terminal-panel">
                <div class="terminal-header">
                    üñ•Ô∏è pulumi-deployment-terminal
                </div>
                <div class="terminal-content" id="terminal">
                    <div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>
                </div>
            </div>
        </div>
        
        <div class="progress">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Progress</span>
                <span id="progressText">0 of 6 steps</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="usage-stats">
            <span id="connectionStatus">üîÑ Connecting to global stats...</span> ‚Ä¢
            <span class="highlight" id="totalDeployments">0</span> total deployments 
            ‚Ä¢ <span class="highlight" id="sessionsToday">0</span> sessions today 
            ‚Ä¢ Last deployment: <span class="highlight" id="lastDeployment">Never</span>
        </div>
    </div>

    <script>
        // Demo state
        let isRunning = false;
        let currentStep = 0;
        let startTime = 0;
        let timer = null;
        let sessionDeployments = 0;
        
        // Global stats tracking via secure Netlify function
        let usageStats = {
            totalDeployments: 0,
            deploymentsToday: 0,
            lastDeployment: null
        };
        
        // Feature flags
        let features = {
            loadbalancer: true,
            k3s: true,
            harvester: false
        };
        
        // Auto-detect Netlify function endpoint
        const isNetlify = window.location.hostname.includes('netlify.app');
        const API_BASE = isNetlify 
            ? `${window.location.origin}/.netlify/functions`
            : 'https://your-site.netlify.app/.netlify/functions';
        
        const allSteps = [
            {
                id: 'env-setup',
                title: "üõ†Ô∏è Environment Setup",
                desc: "Setting up Pulumi and Proxmox connection",
                output: [
                    "Setting environment variables...",
                    "PROXMOX_VE_ENDPOINT=https://192.168.90.102:8006/",
                    "SSH_PUBLIC_KEY loaded from ~/.ssh/id_ed25519.pub",
                    "Initializing Pulumi stack...",
                    "‚úÖ Environment ready for deployment!"
                ],
                requires: []
            },
            {
                id: 'config-validation',
                title: "üìã Configuration Validation", 
                desc: "Validating templates and building dependency map",
                output: [
                    "Loading Pulumi.dev.yaml configuration...",
                    "Validating VM templates...",
                    "Checking feature flags...",
                    "  ‚úÖ loadbalancer: enabled",
                    "  ‚úÖ k3s: enabled", 
                    "  ‚ö™ harvester: disabled",
                    "Building global dependency map...",
                    "‚úÖ Configuration valid, proceeding!"
                ],
                requires: []
            },
            {
                id: 'vm-creation',
                title: "üñ•Ô∏è VM Creation & Role Grouping",
                desc: "Creating VMs and organizing by infrastructure role",
                output: [
                    "Creating VMs from templates...",
                    "Creating VM: loadbalancer-0 (192.168.90.190)",
                    "  Template: ubuntu-22.04-template",
                    "  Role: loadbalancer",
                    "Creating VM: k3s-server-0 (192.168.90.187)",
                    "Creating VM: k3s-server-1 (192.168.90.188)",
                    "Creating VM: k3s-server-2 (192.168.90.189)",
                    "  Template: sle-micro-template", 
                    "  Role: k3s-server",
                    "üîÑ Organizing VMs by role...",
                    "‚úÖ All VMs created and grouped!"
                ],
                requires: []
            },
            {
                id: 'dependency-resolution',
                title: "üîó Global Dependency Resolution",
                desc: "Building runtime discovery map for service coordination",
                output: [
                    "üîç Building global dependency map...",
                    "Scanning role groups for discoverable resources...",
                    "üìä Global Dependencies Available:",
                    "  loadbalancer-ips: [\"192.168.90.190\"]",
                    "  k3s-server-ips: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üéØ Action Execution Plan:",
                    "  1. install-haproxy (depends on: k3s-server-ips)",
                    "  2. install-k3s-server (depends on: loadbalancer)",
                    "‚úÖ Dependencies resolved - ready for execution!"
                ],
                requires: []
            },
            {
                id: 'loadbalancer-setup',
                title: "‚öñÔ∏è HAProxy Load Balancer",
                desc: "Installing HAProxy with dynamic backend discovery",
                output: [
                    "üéØ Executing action: install-haproxy",
                    "üîç Runtime Discovery: Finding k3s-server IPs...",
                    "  Discovered: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üì¶ Installing HAProxy on 192.168.90.190...",
                    "sudo apt update && sudo apt install -y haproxy",
                    "üîß Generating dynamic HAProxy configuration:",
                    "backend k3s-servers",
                    "    server k3s-server-1 192.168.90.187:6443 check",
                    "    server k3s-server-2 192.168.90.188:6443 check", 
                    "    server k3s-server-3 192.168.90.189:6443 check",
                    "sudo systemctl enable --now haproxy",
                    "‚úÖ HAProxy running and ready for K3s traffic!"
                ],
                requires: ['loadbalancer']
            },
            {
                id: 'k3s-cluster',
                title: "‚ò∏Ô∏è K3s High-Availability Cluster",
                desc: "Deploying K3s servers with automatic cluster formation",
                output: [
                    "üéØ Executing action: install-k3s-server",
                    "üîç Runtime Discovery: Finding loadbalancer IP...",
                    "  Discovered LB: 192.168.90.190",
                    "üöÄ Installing K3s on server 1: 192.168.90.187",
                    "curl -sfL https://get.k3s.io | sudo sh -s - server \\",
                    "  --cluster-init \\",
                    "  --tls-san=192.168.90.190",
                    "‚è≥ Waiting for cluster initialization...",
                    "üöÄ Installing K3s on server 2: 192.168.90.188",
                    "üöÄ Installing K3s on server 3: 192.168.90.189",
                    "  Joining cluster through load balancer: 192.168.90.190",
                    "‚úÖ 3-node HA K3s cluster formed automatically!"
                ],
                requires: ['k3s']
            },
            {
                id: 'kubeconfig-extraction',
                title: "üìã Kubeconfig & Verification",
                desc: "Extracting kubeconfig and verifying cluster health",
                output: [
                    "üéØ Executing action: get-kubeconfig",
                    "üîç Runtime Discovery: Finding first k3s server...",
                    "  Discovered: 192.168.90.187",
                    "üìã Extracting kubeconfig from k3s-server-0...",
                    "scp root@192.168.90.187:/etc/rancher/k3s/k3s.yaml ./kubeconfig",
                    "üîç Verifying cluster through load balancer...",
                    "kubectl --kubeconfig=kubeconfig get nodes",
                    "NAME           STATUS   ROLES                  AGE",
                    "k3s-server-0   Ready    control-plane,master   2m",
                    "k3s-server-1   Ready    control-plane,master   1m", 
                    "k3s-server-2   Ready    control-plane,master   1m",
                    "‚úÖ All nodes healthy, cluster ready for workloads!"
                ],
                requires: ['k3s']
            },
            {
                id: 'harvester-deploy',
                title: "üåæ Harvester HCI Platform",
                desc: "Deploying Harvester with iPXE network boot (45+ min)",
                output: [
                    "üéØ Executing action: install-harvester-hci",
                    "‚ö†Ô∏è  WARNING: This is a 45+ minute operation!",
                    "üîç Runtime Discovery: Finding available nodes...",
                    "  Discovered nodes: 3 available for Harvester",
                    "üì° Setting up iPXE network boot infrastructure...",
                    "Configuring DHCP server with iPXE boot options...",
                    "Preparing Harvester ISO for network deployment...",
                    "üöÄ Initiating network boot sequence:",
                    "  Node 1 (192.168.90.200): iPXE boot started",
                    "  Node 2 (192.168.90.201): iPXE boot started",
                    "  Node 3 (192.168.90.202): iPXE boot started",
                    "‚è≥ Installing Harvester OS (this will take 45+ minutes)...",
                    "üìä Progress: Installing base system...",
                    "üìä Progress: Configuring storage pools...",
                    "üìä Progress: Setting up Harvester management cluster...",
                    "‚úÖ Harvester HCI platform deployed successfully!",
                    "üåê Management UI: https://192.168.90.200:8443",
                    "‚ò∏Ô∏è Embedded K8s cluster ready for VM workloads"
                ],
                requires: ['harvester']
            }
        ];
        
        // Secure API functions
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global stats loaded securely via Netlify function');
                return true;
            } catch (error) {
                console.log('üì± Secure API unavailable, using localStorage fallback');
                loadLocalStats();
                return false;
            }
        }
        
        async function incrementStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global deployment count updated securely!');
                return true;
            } catch (error) {
                console.log('üì± Secure API failed, using local increment');
                incrementLocalStats();
                return false;
            }
        }
        
        function loadLocalStats() {
            const stored = localStorage.getItem('demoUsageStats');
            if (stored) {
                usageStats = JSON.parse(stored);
                if (usageStats.lastDeployment) {
                    usageStats.lastDeployment = new Date(usageStats.lastDeployment);
                }
            } else {
                usageStats = {
                    totalDeployments: 0,
                    deploymentsToday: 0,
                    lastDeployment: null
                };
            }
            updateUsageDisplay();
        }
        
        function incrementLocalStats() {
            usageStats.totalDeployments++;
            usageStats.deploymentsToday++;
            usageStats.lastDeployment = new Date();
            localStorage.setItem('demoUsageStats', JSON.stringify(usageStats));
            updateUsageDisplay();
        }
        
        function updateUsageDisplay() {
            document.getElementById('totalDeployments').textContent = usageStats.totalDeployments.toLocaleString();
            document.getElementById('sessionsToday').textContent = usageStats.deploymentsToday;
            
            // Update connection status
            const connectionStatus = document.getElementById('connectionStatus');
            if (API_BASE.includes('netlify')) {
                connectionStatus.innerHTML = 'üîí <strong>Secure Global Stats</strong>';
                connectionStatus.style.color = '#48bb78';
            } else {
                connectionStatus.innerHTML = 'üì± <strong>Local Mode</strong>';
                connectionStatus.style.color = '#f6e05e';
            }
            
            if (usageStats.lastDeployment) {
                const lastTime = usageStats.lastDeployment;
                const now = new Date();
                const diffMinutes = Math.floor((now - lastTime) / 60000);
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Just now';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes}m ago`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)}h ago`;
                } else {
                    timeText = lastTime.toLocaleDateString();
                }
                
                document.getElementById('lastDeployment').textContent = timeText;
            } else {
                document.getElementById('lastDeployment').textContent = 'Never';
            }
            
            document.getElementById('deployCount').textContent = sessionDeployments + ' Session';
        }
        
        function getActiveSteps() {
            return allSteps.filter(step => {
                if (step.requires.length === 0) return true;
                return step.requires.some(req => features[req]);
            });
        }
        
        function updateStats() {
            const activeSteps = getActiveSteps();
            let vmCount = 0;
            
            if (features.loadbalancer) vmCount += 1;
            if (features.k3s) vmCount += 3;
            if (features.harvester) vmCount += 3;
            
            document.getElementById('vmCount').textContent = vmCount + ' VMs';
            document.getElementById('actionCount').textContent = activeSteps.length + ' Actions';
        }
        
        function setupFeatureToggles() {
            ['loadbalancer', 'k3s', 'harvester'].forEach(feature => {
                const toggle = document.getElementById(`feature-${feature}`);
                const checkbox = toggle.querySelector('input');
                
                toggle.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    features[feature] = checkbox.checked;
                    toggle.classList.toggle('active', checkbox.checked);
                    
                    if (!isRunning) {
                        updateStats();
                        renderSteps();
                        updateProgress();
                    }
                });
            });
        }
        
        function updateTimer() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed + 's';
            }
        }
        
        function addTerminalLine(text, className = 'text-gray') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            terminal.appendChild(line);
            
            // Auto-scroll to bottom, but smoothly
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function updateProgress() {
            const activeSteps = getActiveSteps();
            const total = activeSteps.length;
            const completed = currentStep;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} steps`;
        }
        
        function renderSteps() {
            const activeSteps = getActiveSteps();
            const stepsList = document.getElementById('stepsList');
            
            stepsList.innerHTML = activeSteps.map((step, index) => {
                let className = '';
                let icon = '‚è≥';
                
                if (index < currentStep) {
                    className = 'completed';
                    icon = '‚úÖ';
                } else if (index === currentStep && isRunning) {
                    className = 'running';
                    icon = 'üîÑ';
                }
                
                return `
                    <div class="step ${className}">
                        <div class="step-title">${icon} ${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function runStep(stepIndex) {
            const activeSteps = getActiveSteps();
            const step = activeSteps[stepIndex];
            
            addTerminalLine(`üéØ Step ${stepIndex + 1}/${activeSteps.length}: ${step.title}`, 'text-yellow');
            addTerminalLine('', 'text-gray');
            
            for (const line of step.output) {
                await new Promise(resolve => setTimeout(resolve, step.id === 'harvester-deploy' ? 200 : 300));
                
                const className = line.includes('‚úÖ') ? 'text-green' :
                                line.includes('‚ö†Ô∏è') || line.includes('WARNING') ? 'text-yellow' :
                                line.includes('üîç') || line.includes('üìä') || line.includes('üéØ') ? 'text-blue' :
                                line.includes('üöÄ') || line.includes('curl') ? 'text-cyan' :
                                'text-gray';
                                
                addTerminalLine(line, className);
            }
            
            addTerminalLine('', 'text-gray');
        }
        
        async function deploy() {
            if (isRunning) return;
            
            console.log('Starting deployment...');
            
            // Increment global deployment count securely
            sessionDeployments++;
            await incrementStats();
            
            isRunning = true;
            currentStep = 0;
            startTime = Date.now();
            
            const activeSteps = getActiveSteps();
            
            // Update UI
            document.getElementById('deployBtn').textContent = '‚è≥ Deploying...';
            document.getElementById('deployBtn').disabled = true;
            document.getElementById('status').textContent = 'Running...';
            
            // Clear terminal
            document.getElementById('terminal').innerHTML = '';
            
            // Start timer
            timer = setInterval(updateTimer, 1000);
            
            addTerminalLine('üöÄ Starting infrastructure deployment...', 'text-cyan');
            addTerminalLine(`üîí Global deployment #${usageStats.totalDeployments} via secure API`, 'text-blue');
            addTerminalLine('üåç Stats synced globally with zero config exposure!', 'text-cyan');
            addTerminalLine('Components will discover each other automatically!', 'text-cyan');
            addTerminalLine('', 'text-gray');
            
            try {
                for (let i = 0; i < activeSteps.length; i++) {
                    currentStep = i;
                    renderSteps();
                    updateProgress();
                    
                    await runStep(i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                currentStep = activeSteps.length;
                renderSteps();
                updateProgress();
                
                addTerminalLine('üéâ Infrastructure deployment completed successfully!', 'text-green');
                addTerminalLine('All components are operational and auto-configured.', 'text-green');
                addTerminalLine('Runtime discovery worked perfectly - zero manual coordination!', 'text-green');
                addTerminalLine('üîí Global stats updated securely via Netlify function.', 'text-green');
                
                document.getElementById('status').textContent = 'Complete';
                
            } catch (error) {
                console.error('Deployment error:', error);
                addTerminalLine('‚ùå Deployment failed: ' + error.message, 'text-yellow');
                document.getElementById('status').textContent = 'Failed';
            } finally {
                isRunning = false;
                clearInterval(timer);
                document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
                document.getElementById('deployBtn').disabled = false;
            }
        }
        
        function reset() {
            console.log('Resetting demo...');
            
            if (timer) clearInterval(timer);
            
            isRunning = false;
            currentStep = 0;
            startTime = 0;
            
            document.getElementById('timer').textContent = '0s';
            document.getElementById('status').textContent = 'Ready';
            document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
            document.getElementById('deployBtn').disabled = false;
            
            document.getElementById('terminal').innerHTML = 
                '<div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>';
                
            renderSteps();
            updateProgress();
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Secure infrastructure demo initialized');
            
            // Load global stats securely via Netlify function
            await fetchStats();
            
            setupFeatureToggles();
            document.getElementById('deployBtn').addEventListener('click', deploy);
            document.getElementById('resetBtn').addEventListener('click', reset);
            
            updateStats();
            renderSteps();
            updateProgress();
            
            // Periodic stats refresh for real-time updates
            setInterval(async () => {
                if (!isRunning) {
                    await fetchStats();
                }
            }, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Configuring Infrastructure Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .feature-flags {
            margin-bottom: 20px;
        }
        
        .feature-flags h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .feature-toggle:hover {
            border-color: #cbd5e0;
        }
        
        .feature-toggle.active {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .feature-info .name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .feature-info .desc {
            font-size: 12px;
            color: #718096;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats {
            margin-left: auto;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .usage-stats {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 13px;
            color: #4a5568;
        }
        
        .usage-stats .highlight {
            font-weight: 600;
            color: #2d3748;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 500px;
        }
        
        .steps-panel {
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .terminal-panel {
            background: #1a202c;
            padding: 25px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            max-height: 500px; /* Fixed height to match steps panel */
        }
        
        .terminal-header {
            margin-bottom: 15px;
            color: #a0aec0;
            flex-shrink: 0; /* Don't shrink the header */
        }
        
        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            /* Custom scrollbar styling */
        }
        
        .terminal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .terminal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step.running {
            border-color: #667eea;
            background: #edf2f7;
            animation: pulse 2s infinite;
        }
        
        .step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 14px;
            color: #666;
        }
        
        .terminal-line {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        
        .text-green { color: #68d391; }
        .text-blue { color: #63b3ed; }
        .text-yellow { color: #f6e05e; }
        .text-cyan { color: #76e4f7; }
        .text-gray { color: #a0aec0; }
        
        .progress {
            padding: 20px;
            background: #f7fafc;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #48bb78 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Self-Configuring Infrastructure Demo</h1>
            <p>Experience runtime discovery and automatic dependency resolution!</p>
        </div>
        
        <div class="controls">
            <div class="feature-flags">
                <h3>üéõÔ∏è Feature Flags (Choose Your Adventure)</h3>
                <div class="feature-grid">
                    <div id="feature-loadbalancer" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚öñÔ∏è Load Balancer</div>
                            <div class="desc">HAProxy with dynamic backends</div>
                        </div>
                    </div>
                    <div id="feature-k3s" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚ò∏Ô∏è K3s Cluster</div>
                            <div class="desc">HA Kubernetes cluster</div>
                        </div>
                    </div>
                    <div id="feature-harvester" class="feature-toggle">
                        <input type="checkbox">
                        <div class="feature-info">
                            <div class="name">üåæ Harvester HCI</div>
                            <div class="desc">iPXE network boot (45+ min)</div>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #718096; margin: 0;">
                    üí° Toggle features to see different deployment scenarios. Infrastructure adapts automatically!
                </p>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="control-buttons">
                    <button id="deployBtn" class="btn btn-primary">‚ñ∂Ô∏è Deploy Infrastructure</button>
                    <button id="resetBtn" class="btn btn-secondary">üîÑ Reset</button>
                </div>
                
                <div class="stats">
                    <span>üñ•Ô∏è <span id="vmCount">4 VMs</span></span>
                    <span>üíª <span id="actionCount">6 Actions</span></span>
                    <span>üöÄ <span id="deployCount">0 Deployments</span></span>
                    <span>‚ö° <span id="timer">0s</span></span>
                    <span id="status">Ready</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="steps-panel">
                <h3>Deployment Steps</h3>
                <div id="stepsList">
                    <!-- Steps will be populated here -->
                </div>
            </div>
            
            <div class="terminal-panel">
                <div class="terminal-header">
                    üñ•Ô∏è pulumi-deployment-terminal
                </div>
                <div class="terminal-content" id="terminal">
                    <div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>
                </div>
            </div>
        </div>
        
        <div class="progress">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Progress</span>
                <span id="progressText">0 of 6 steps</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="usage-stats">
            <span id="connectionStatus">üîÑ Connecting to global stats...</span> ‚Ä¢
            <span class="highlight" id="totalDeployments">0</span> total deployments 
            ‚Ä¢ <span class="highlight" id="sessionsToday">0</span> sessions today 
            ‚Ä¢ Last deployment: <span class="highlight" id="lastDeployment">Never</span>
        </div>
    </div>

    <script>
        // Demo state
        let isRunning = false;
        let currentStep = 0;
        let startTime = 0;
        let timer = null;
        let sessionDeployments = 0;
        
        // Global stats tracking via secure Netlify function
        let usageStats = {
            totalDeployments: 0,
            deploymentsToday: 0,
            lastDeployment: null
        };
        
        // Feature flags
        let features = {
            loadbalancer: true,
            k3s: true,
            harvester: false
        };
        
        // Auto-detect Netlify function endpoint
        const isNetlify = window.location.hostname.includes('netlify.app');
        const API_BASE = isNetlify 
            ? `${window.location.origin}/.netlify/functions`
            : 'https://your-site.netlify.app/.netlify/functions';
        
        const allSteps = [
            {
                id: 'env-setup',
                title: "üõ†Ô∏è Environment Setup",
                desc: "Setting up Pulumi and Proxmox connection",
                output: [
                    "Setting environment variables...",
                    "PROXMOX_VE_ENDPOINT=https://192.168.90.102:8006/",
                    "SSH_PUBLIC_KEY loaded from ~/.ssh/id_ed25519.pub",
                    "Initializing Pulumi stack...",
                    "‚úÖ Environment ready for deployment!"
                ],
                requires: []
            },
            {
                id: 'config-validation',
                title: "üìã Configuration Validation", 
                desc: "Validating templates and building dependency map",
                output: [
                    "Loading Pulumi.dev.yaml configuration...",
                    "Validating VM templates...",
                    "Checking feature flags...",
                    "  ‚úÖ loadbalancer: enabled",
                    "  ‚úÖ k3s: enabled", 
                    "  ‚ö™ harvester: disabled",
                    "Building global dependency map...",
                    "‚úÖ Configuration valid, proceeding!"
                ],
                requires: []
            },
            {
                id: 'vm-creation',
                title: "üñ•Ô∏è VM Creation & Role Grouping",
                desc: "Creating VMs and organizing by infrastructure role",
                output: [
                    "Creating VMs from templates...",
                    "Creating VM: loadbalancer-0 (192.168.90.190)",
                    "  Template: ubuntu-22.04-template",
                    "  Role: loadbalancer",
                    "Creating VM: k3s-server-0 (192.168.90.187)",
                    "Creating VM: k3s-server-1 (192.168.90.188)",
                    "Creating VM: k3s-server-2 (192.168.90.189)",
                    "  Template: sle-micro-template", 
                    "  Role: k3s-server",
                    "üîÑ Organizing VMs by role...",
                    "‚úÖ All VMs created and grouped!"
                ],
                requires: []
            },
            {
                id: 'dependency-resolution',
                title: "üîó Global Dependency Resolution",
                desc: "Building runtime discovery map for service coordination",
                output: [
                    "üîç Building global dependency map...",
                    "Scanning role groups for discoverable resources...",
                    "üìä Global Dependencies Available:",
                    "  loadbalancer-ips: [\"192.168.90.190\"]",
                    "  k3s-server-ips: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üéØ Action Execution Plan:",
                    "  1. install-haproxy (depends on: k3s-server-ips)",
                    "  2. install-k3s-server (depends on: loadbalancer)",
                    "‚úÖ Dependencies resolved - ready for execution!"
                ],
                requires: []
            },
            {
                id: 'loadbalancer-setup',
                title: "‚öñÔ∏è HAProxy Load Balancer",
                desc: "Installing HAProxy with dynamic backend discovery",
                output: [
                    "üéØ Executing action: install-haproxy",
                    "üîç Runtime Discovery: Finding k3s-server IPs...",
                    "  Discovered: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üì¶ Installing HAProxy on 192.168.90.190...",
                    "sudo apt update && sudo apt install -y haproxy",
                    "üîß Generating dynamic HAProxy configuration:",
                    "backend k3s-servers",
                    "    server k3s-server-1 192.168.90.187:6443 check",
                    "    server k3s-server-2 192.168.90.188:6443 check", 
                    "    server k3s-server-3 192.168.90.189:6443 check",
                    "sudo systemctl enable --now haproxy",
                    "‚úÖ HAProxy running and ready for K3s traffic!"
                ],
                requires: ['loadbalancer']
            },
            {
                id: 'k3s-cluster',
                title: "‚ò∏Ô∏è K3s High-Availability Cluster",
                desc: "Deploying K3s servers with automatic cluster formation",
                output: [
                    "üéØ Executing action: install-k3s-server",
                    "üîç Runtime Discovery: Finding loadbalancer IP...",
                    "  Discovered LB: 192.168.90.190",
                    "üöÄ Installing K3s on server 1: 192.168.90.187",
                    "curl -sfL https://get.k3s.io | sudo sh -s - server \\",
                    "  --cluster-init \\",
                    "  --tls-san=192.168.90.190",
                    "‚è≥ Waiting for cluster initialization...",
                    "üöÄ Installing K3s on server 2: 192.168.90.188",
                    "üöÄ Installing K3s on server 3: 192.168.90.189",
                    "  Joining cluster through load balancer: 192.168.90.190",
                    "‚úÖ 3-node HA K3s cluster formed automatically!"
                ],
                requires: ['k3s']
            },
            {
                id: 'kubeconfig-extraction',
                title: "üìã Kubeconfig & Verification",
                desc: "Extracting kubeconfig and verifying cluster health",
                output: [
                    "üéØ Executing action: get-kubeconfig",
                    "üîç Runtime Discovery: Finding first k3s server...",
                    "  Discovered: 192.168.90.187",
                    "üìã Extracting kubeconfig from k3s-server-0...",
                    "scp root@192.168.90.187:/etc/rancher/k3s/k3s.yaml ./kubeconfig",
                    "üîç Verifying cluster through load balancer...",
                    "kubectl --kubeconfig=kubeconfig get nodes",
                    "NAME           STATUS   ROLES                  AGE",
                    "k3s-server-0   Ready    control-plane,master   2m",
                    "k3s-server-1   Ready    control-plane,master   1m", 
                    "k3s-server-2   Ready    control-plane,master   1m",
                    "‚úÖ All nodes healthy, cluster ready for workloads!"
                ],
                requires: ['k3s']
            },
            {
                id: 'harvester-deploy',
                title: "üåæ Harvester HCI Platform",
                desc: "Deploying Harvester with iPXE network boot (45+ min)",
                output: [
                    "üéØ Executing action: install-harvester-hci",
                    "‚ö†Ô∏è  WARNING: This is a 45+ minute operation!",
                    "üîç Runtime Discovery: Finding available nodes...",
                    "  Discovered nodes: 3 available for Harvester",
                    "üì° Setting up iPXE network boot infrastructure...",
                    "Configuring DHCP server with iPXE boot options...",
                    "Preparing Harvester ISO for network deployment...",
                    "üöÄ Initiating network boot sequence:",
                    "  Node 1 (192.168.90.200): iPXE boot started",
                    "  Node 2 (192.168.90.201): iPXE boot started",
                    "  Node 3 (192.168.90.202): iPXE boot started",
                    "‚è≥ Installing Harvester OS (this will take 45+ minutes)...",
                    "üìä Progress: Installing base system...",
                    "üìä Progress: Configuring storage pools...",
                    "üìä Progress: Setting up Harvester management cluster...",
                    "‚úÖ Harvester HCI platform deployed successfully!",
                    "üåê Management UI: https://192.168.90.200:8443",
                    "‚ò∏Ô∏è Embedded K8s cluster ready for VM workloads"
                ],
                requires: ['harvester']
            }
        ];
        
        // Secure API functions
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global stats loaded securely via Netlify function');
                return true;
            } catch (error) {
                console.log('üì± Secure API unavailable, using localStorage fallback');
                loadLocalStats();
                return false;
            }
        }
        
        async function incrementStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global deployment count updated securely!');
                return true;
            } catch (error) {
                console.log('üì± Secure API failed, using local increment');
                incrementLocalStats();
                return false;
            }
        }
        
        function loadLocalStats() {
            const stored = localStorage.getItem('demoUsageStats');
            if (stored) {
                usageStats = JSON.parse(stored);
                if (usageStats.lastDeployment) {
                    usageStats.lastDeployment = new Date(usageStats.lastDeployment);
                }
            } else {
                usageStats = {
                    totalDeployments: 0,
                    deploymentsToday: 0,
                    lastDeployment: null
                };
            }
            updateUsageDisplay();
        }
        
        function incrementLocalStats() {
            usageStats.totalDeployments++;
            usageStats.deploymentsToday++;
            usageStats.lastDeployment = new Date();
            localStorage.setItem('demoUsageStats', JSON.stringify(usageStats));
            updateUsageDisplay();
        }
        
        function updateUsageDisplay() {
            document.getElementById('totalDeployments').textContent = usageStats.totalDeployments.toLocaleString();
            document.getElementById('sessionsToday').textContent = usageStats.deploymentsToday;
            
            // Update connection status
            const connectionStatus = document.getElementById('connectionStatus');
            if (API_BASE.includes('netlify')) {
                connectionStatus.innerHTML = 'üîí <strong>Secure Global Stats</strong>';
                connectionStatus.style.color = '#48bb78';
            } else {
                connectionStatus.innerHTML = 'üì± <strong>Local Mode</strong>';
                connectionStatus.style.color = '#f6e05e';
            }
            
            if (usageStats.lastDeployment) {
                const lastTime = usageStats.lastDeployment;
                const now = new Date();
                const diffMinutes = Math.floor((now - lastTime) / 60000);
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Just now';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes}m ago`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)}h ago`;
                } else {
                    timeText = lastTime.toLocaleDateString();
                }
                
                document.getElementById('lastDeployment').textContent = timeText;
            } else {
                document.getElementById('lastDeployment').textContent = 'Never';
            }
            
            document.getElementById('deployCount').textContent = sessionDeployments + ' Session';
        }
        
        function getActiveSteps() {
            return allSteps.filter(step => {
                if (step.requires.length === 0) return true;
                return step.requires.some(req => features[req]);
            });
        }
        
        function updateStats() {
            const activeSteps = getActiveSteps();
            let vmCount = 0;
            
            if (features.loadbalancer) vmCount += 1;
            if (features.k3s) vmCount += 3;
            if (features.harvester) vmCount += 3;
            
            document.getElementById('vmCount').textContent = vmCount + ' VMs';
            document.getElementById('actionCount').textContent = activeSteps.length + ' Actions';
        }
        
        function setupFeatureToggles() {
            ['loadbalancer', 'k3s', 'harvester'].forEach(feature => {
                const toggle = document.getElementById(`feature-${feature}`);
                const checkbox = toggle.querySelector('input');
                
                toggle.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    features[feature] = checkbox.checked;
                    toggle.classList.toggle('active', checkbox.checked);
                    
                    if (!isRunning) {
                        updateStats();
                        renderSteps();
                        updateProgress();
                    }
                });
            });
        }
        
        function updateTimer() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed + 's';
            }
        }
        
        function addTerminalLine(text, className = 'text-gray') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            terminal.appendChild(line);
            
            // Auto-scroll to bottom, but smoothly
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function updateProgress() {
            const activeSteps = getActiveSteps();
            const total = activeSteps.length;
            const completed = currentStep;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} steps`;
        }
        
        function renderSteps() {
            const activeSteps = getActiveSteps();
            const stepsList = document.getElementById('stepsList');
            
            stepsList.innerHTML = activeSteps.map((step, index) => {
                let className = '';
                let icon = '‚è≥';
                
                if (index < currentStep) {
                    className = 'completed';
                    icon = '‚úÖ';
                } else if (index === currentStep && isRunning) {
                    className = 'running';
                    icon = 'üîÑ';
                }
                
                return `
                    <div class="step ${className}">
                        <div class="step-title">${icon} ${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function runStep(stepIndex) {
            const activeSteps = getActiveSteps();
            const step = activeSteps[stepIndex];
            
            addTerminalLine(`üéØ Step ${stepIndex + 1}/${activeSteps.length}: ${step.title}`, 'text-yellow');
            addTerminalLine('', 'text-gray');
            
            for (const line of step.output) {
                await new Promise(resolve => setTimeout(resolve, step.id === 'harvester-deploy' ? 200 : 300));
                
                const className = line.includes('‚úÖ') ? 'text-green' :
                                line.includes('‚ö†Ô∏è') || line.includes('WARNING') ? 'text-yellow' :
                                line.includes('üîç') || line.includes('üìä') || line.includes('üéØ') ? 'text-blue' :
                                line.includes('üöÄ') || line.includes('curl') ? 'text-cyan' :
                                'text-gray';
                                
                addTerminalLine(line, className);
            }
            
            addTerminalLine('', 'text-gray');
        }
        
        async function deploy() {
            if (isRunning) return;
            
            console.log('Starting deployment...');
            
            // Increment global deployment count securely
            sessionDeployments++;
            await incrementStats();
            
            isRunning = true;
            currentStep = 0;
            startTime = Date.now();
            
            const activeSteps = getActiveSteps();
            
            // Update UI
            document.getElementById('deployBtn').textContent = '‚è≥ Deploying...';
            document.getElementById('deployBtn').disabled = true;
            document.getElementById('status').textContent = 'Running...';
            
            // Clear terminal
            document.getElementById('terminal').innerHTML = '';
            
            // Start timer
            timer = setInterval(updateTimer, 1000);
            
            addTerminalLine('üöÄ Starting infrastructure deployment...', 'text-cyan');
            addTerminalLine(`üîí Global deployment #${usageStats.totalDeployments} via secure API`, 'text-blue');
            addTerminalLine('üåç Stats synced globally with zero config exposure!', 'text-cyan');
            addTerminalLine('Components will discover each other automatically!', 'text-cyan');
            addTerminalLine('', 'text-gray');
            
            try {
                for (let i = 0; i < activeSteps.length; i++) {
                    currentStep = i;
                    renderSteps();
                    updateProgress();
                    
                    await runStep(i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                currentStep = activeSteps.length;
                renderSteps();
                updateProgress();
                
                addTerminalLine('üéâ Infrastructure deployment completed successfully!', 'text-green');
                addTerminalLine('All components are operational and auto-configured.', 'text-green');
                addTerminalLine('Runtime discovery worked perfectly - zero manual coordination!', 'text-green');
                addTerminalLine('üîí Global stats updated securely via Netlify function.', 'text-green');
                
                document.getElementById('status').textContent = 'Complete';
                
            } catch (error) {
                console.error('Deployment error:', error);
                addTerminalLine('‚ùå Deployment failed: ' + error.message, 'text-yellow');
                document.getElementById('status').textContent = 'Failed';
            } finally {
                isRunning = false;
                clearInterval(timer);
                document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
                document.getElementById('deployBtn').disabled = false;
            }
        }
        
        function reset() {
            console.log('Resetting demo...');
            
            if (timer) clearInterval(timer);
            
            isRunning = false;
            currentStep = 0;
            startTime = 0;
            
            document.getElementById('timer').textContent = '0s';
            document.getElementById('status').textContent = 'Ready';
            document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
            document.getElementById('deployBtn').disabled = false;
            
            document.getElementById('terminal').innerHTML = 
                '<div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>';
                
            renderSteps();
            updateProgress();
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Secure infrastructure demo initialized');
            
            // Load global stats securely via Netlify function
            await fetchStats();
            
            setupFeatureToggles();
            document.getElementById('deployBtn').addEventListener('click', deploy);
            document.getElementById('resetBtn').addEventListener('click', reset);
            
            updateStats();
            renderSteps();
            updateProgress();
            
            // Periodic stats refresh for real-time updates
            setInterval(async () => {
                if (!isRunning) {
                    await fetchStats();
                }
            }, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Configuring Infrastructure Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .feature-flags {
            margin-bottom: 20px;
        }
        
        .feature-flags h3 {
            margin: 0 0 15px 0;
            color: #4a5568;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .feature-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .feature-toggle:hover {
            border-color: #cbd5e0;
        }
        
        .feature-toggle.active {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        .feature-info .name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .feature-info .desc {
            font-size: 12px;
            color: #718096;
        }
        
        .control-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stats {
            margin-left: auto;
            display: flex;
            gap: 20px;
            font-size: 14px;
            color: #666;
        }
        
        .usage-stats {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 13px;
            color: #4a5568;
        }
        
        .usage-stats .highlight {
            font-weight: 600;
            color: #2d3748;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 500px;
        }
        
        .steps-panel {
            padding: 25px;
            border-right: 1px solid #eee;
        }
        
        .terminal-panel {
            background: #1a202c;
            padding: 25px;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            max-height: 500px; /* Fixed height to match steps panel */
        }
        
        .terminal-header {
            margin-bottom: 15px;
            color: #a0aec0;
            flex-shrink: 0; /* Don't shrink the header */
        }
        
        .terminal-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            /* Custom scrollbar styling */
        }
        
        .terminal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .terminal-content::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }
        
        .terminal-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .step {
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .step.running {
            border-color: #667eea;
            background: #edf2f7;
            animation: pulse 2s infinite;
        }
        
        .step.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .step-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .step-desc {
            font-size: 14px;
            color: #666;
        }
        
        .terminal-line {
            margin-bottom: 3px;
            line-height: 1.4;
        }
        
        .text-green { color: #68d391; }
        .text-blue { color: #63b3ed; }
        .text-yellow { color: #f6e05e; }
        .text-cyan { color: #76e4f7; }
        .text-gray { color: #a0aec0; }
        
        .progress {
            padding: 20px;
            background: #f7fafc;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #48bb78 100%);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Self-Configuring Infrastructure Demo</h1>
            <p>Experience runtime discovery and automatic dependency resolution!</p>
        </div>
        
        <div class="controls">
            <div class="feature-flags">
                <h3>üéõÔ∏è Feature Flags (Choose Your Adventure)</h3>
                <div class="feature-grid">
                    <div id="feature-loadbalancer" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚öñÔ∏è Load Balancer</div>
                            <div class="desc">HAProxy with dynamic backends</div>
                        </div>
                    </div>
                    <div id="feature-k3s" class="feature-toggle active">
                        <input type="checkbox" checked>
                        <div class="feature-info">
                            <div class="name">‚ò∏Ô∏è K3s Cluster</div>
                            <div class="desc">HA Kubernetes cluster</div>
                        </div>
                    </div>
                    <div id="feature-harvester" class="feature-toggle">
                        <input type="checkbox">
                        <div class="feature-info">
                            <div class="name">üåæ Harvester HCI</div>
                            <div class="desc">iPXE network boot (45+ min)</div>
                        </div>
                    </div>
                </div>
                <p style="font-size: 12px; color: #718096; margin: 0;">
                    üí° Toggle features to see different deployment scenarios. Infrastructure adapts automatically!
                </p>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="control-buttons">
                    <button id="deployBtn" class="btn btn-primary">‚ñ∂Ô∏è Deploy Infrastructure</button>
                    <button id="resetBtn" class="btn btn-secondary">üîÑ Reset</button>
                </div>
                
                <div class="stats">
                    <span>üñ•Ô∏è <span id="vmCount">4 VMs</span></span>
                    <span>üíª <span id="actionCount">6 Actions</span></span>
                    <span>üöÄ <span id="deployCount">0 Deployments</span></span>
                    <span>‚ö° <span id="timer">0s</span></span>
                    <span id="status">Ready</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="steps-panel">
                <h3>Deployment Steps</h3>
                <div id="stepsList">
                    <!-- Steps will be populated here -->
                </div>
            </div>
            
            <div class="terminal-panel">
                <div class="terminal-header">
                    üñ•Ô∏è pulumi-deployment-terminal
                </div>
                <div class="terminal-content" id="terminal">
                    <div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>
                </div>
            </div>
        </div>
        
        <div class="progress">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Progress</span>
                <span id="progressText">0 of 6 steps</span>
            </div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
            </div>
        </div>
        
        <div class="usage-stats">
            <span id="connectionStatus">üîÑ Connecting to global stats...</span> ‚Ä¢
            <span class="highlight" id="totalDeployments">0</span> total deployments 
            ‚Ä¢ <span class="highlight" id="sessionsToday">0</span> sessions today 
            ‚Ä¢ Last deployment: <span class="highlight" id="lastDeployment">Never</span>
        </div>
    </div>

    <script>
        // Demo state
        let isRunning = false;
        let currentStep = 0;
        let startTime = 0;
        let timer = null;
        let sessionDeployments = 0;
        
        // Global stats tracking via secure Netlify function
        let usageStats = {
            totalDeployments: 0,
            deploymentsToday: 0,
            lastDeployment: null
        };
        
        // Feature flags
        let features = {
            loadbalancer: true,
            k3s: true,
            harvester: false
        };
        
        // Auto-detect Netlify function endpoint
        const isNetlify = window.location.hostname.includes('netlify.app');
        const API_BASE = isNetlify 
            ? `${window.location.origin}/.netlify/functions`
            : 'https://your-site.netlify.app/.netlify/functions';
        
        const allSteps = [
            {
                id: 'env-setup',
                title: "üõ†Ô∏è Environment Setup",
                desc: "Setting up Pulumi and Proxmox connection",
                output: [
                    "Setting environment variables...",
                    "PROXMOX_VE_ENDPOINT=https://192.168.90.102:8006/",
                    "SSH_PUBLIC_KEY loaded from ~/.ssh/id_ed25519.pub",
                    "Initializing Pulumi stack...",
                    "‚úÖ Environment ready for deployment!"
                ],
                requires: []
            },
            {
                id: 'config-validation',
                title: "üìã Configuration Validation", 
                desc: "Validating templates and building dependency map",
                output: [
                    "Loading Pulumi.dev.yaml configuration...",
                    "Validating VM templates...",
                    "Checking feature flags...",
                    "  ‚úÖ loadbalancer: enabled",
                    "  ‚úÖ k3s: enabled", 
                    "  ‚ö™ harvester: disabled",
                    "Building global dependency map...",
                    "‚úÖ Configuration valid, proceeding!"
                ],
                requires: []
            },
            {
                id: 'vm-creation',
                title: "üñ•Ô∏è VM Creation & Role Grouping",
                desc: "Creating VMs and organizing by infrastructure role",
                output: [
                    "Creating VMs from templates...",
                    "Creating VM: loadbalancer-0 (192.168.90.190)",
                    "  Template: ubuntu-22.04-template",
                    "  Role: loadbalancer",
                    "Creating VM: k3s-server-0 (192.168.90.187)",
                    "Creating VM: k3s-server-1 (192.168.90.188)",
                    "Creating VM: k3s-server-2 (192.168.90.189)",
                    "  Template: sle-micro-template", 
                    "  Role: k3s-server",
                    "üîÑ Organizing VMs by role...",
                    "‚úÖ All VMs created and grouped!"
                ],
                requires: []
            },
            {
                id: 'dependency-resolution',
                title: "üîó Global Dependency Resolution",
                desc: "Building runtime discovery map for service coordination",
                output: [
                    "üîç Building global dependency map...",
                    "Scanning role groups for discoverable resources...",
                    "üìä Global Dependencies Available:",
                    "  loadbalancer-ips: [\"192.168.90.190\"]",
                    "  k3s-server-ips: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üéØ Action Execution Plan:",
                    "  1. install-haproxy (depends on: k3s-server-ips)",
                    "  2. install-k3s-server (depends on: loadbalancer)",
                    "‚úÖ Dependencies resolved - ready for execution!"
                ],
                requires: []
            },
            {
                id: 'loadbalancer-setup',
                title: "‚öñÔ∏è HAProxy Load Balancer",
                desc: "Installing HAProxy with dynamic backend discovery",
                output: [
                    "üéØ Executing action: install-haproxy",
                    "üîç Runtime Discovery: Finding k3s-server IPs...",
                    "  Discovered: [\"192.168.90.187\", \"192.168.90.188\", \"192.168.90.189\"]",
                    "üì¶ Installing HAProxy on 192.168.90.190...",
                    "sudo apt update && sudo apt install -y haproxy",
                    "üîß Generating dynamic HAProxy configuration:",
                    "backend k3s-servers",
                    "    server k3s-server-1 192.168.90.187:6443 check",
                    "    server k3s-server-2 192.168.90.188:6443 check", 
                    "    server k3s-server-3 192.168.90.189:6443 check",
                    "sudo systemctl enable --now haproxy",
                    "‚úÖ HAProxy running and ready for K3s traffic!"
                ],
                requires: ['loadbalancer']
            },
            {
                id: 'k3s-cluster',
                title: "‚ò∏Ô∏è K3s High-Availability Cluster",
                desc: "Deploying K3s servers with automatic cluster formation",
                output: [
                    "üéØ Executing action: install-k3s-server",
                    "üîç Runtime Discovery: Finding loadbalancer IP...",
                    "  Discovered LB: 192.168.90.190",
                    "üöÄ Installing K3s on server 1: 192.168.90.187",
                    "curl -sfL https://get.k3s.io | sudo sh -s - server \\",
                    "  --cluster-init \\",
                    "  --tls-san=192.168.90.190",
                    "‚è≥ Waiting for cluster initialization...",
                    "üöÄ Installing K3s on server 2: 192.168.90.188",
                    "üöÄ Installing K3s on server 3: 192.168.90.189",
                    "  Joining cluster through load balancer: 192.168.90.190",
                    "‚úÖ 3-node HA K3s cluster formed automatically!"
                ],
                requires: ['k3s']
            },
            {
                id: 'kubeconfig-extraction',
                title: "üìã Kubeconfig & Verification",
                desc: "Extracting kubeconfig and verifying cluster health",
                output: [
                    "üéØ Executing action: get-kubeconfig",
                    "üîç Runtime Discovery: Finding first k3s server...",
                    "  Discovered: 192.168.90.187",
                    "üìã Extracting kubeconfig from k3s-server-0...",
                    "scp root@192.168.90.187:/etc/rancher/k3s/k3s.yaml ./kubeconfig",
                    "üîç Verifying cluster through load balancer...",
                    "kubectl --kubeconfig=kubeconfig get nodes",
                    "NAME           STATUS   ROLES                  AGE",
                    "k3s-server-0   Ready    control-plane,master   2m",
                    "k3s-server-1   Ready    control-plane,master   1m", 
                    "k3s-server-2   Ready    control-plane,master   1m",
                    "‚úÖ All nodes healthy, cluster ready for workloads!"
                ],
                requires: ['k3s']
            },
            {
                id: 'harvester-deploy',
                title: "üåæ Harvester HCI Platform",
                desc: "Deploying Harvester with iPXE network boot (45+ min)",
                output: [
                    "üéØ Executing action: install-harvester-hci",
                    "‚ö†Ô∏è  WARNING: This is a 45+ minute operation!",
                    "üîç Runtime Discovery: Finding available nodes...",
                    "  Discovered nodes: 3 available for Harvester",
                    "üì° Setting up iPXE network boot infrastructure...",
                    "Configuring DHCP server with iPXE boot options...",
                    "Preparing Harvester ISO for network deployment...",
                    "üöÄ Initiating network boot sequence:",
                    "  Node 1 (192.168.90.200): iPXE boot started",
                    "  Node 2 (192.168.90.201): iPXE boot started",
                    "  Node 3 (192.168.90.202): iPXE boot started",
                    "‚è≥ Installing Harvester OS (this will take 45+ minutes)...",
                    "üìä Progress: Installing base system...",
                    "üìä Progress: Configuring storage pools...",
                    "üìä Progress: Setting up Harvester management cluster...",
                    "‚úÖ Harvester HCI platform deployed successfully!",
                    "üåê Management UI: https://192.168.90.200:8443",
                    "‚ò∏Ô∏è Embedded K8s cluster ready for VM workloads"
                ],
                requires: ['harvester']
            }
        ];
        
        // Secure API functions
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global stats loaded securely via Netlify function');
                return true;
            } catch (error) {
                console.log('üì± Secure API unavailable, using localStorage fallback');
                loadLocalStats();
                return false;
            }
        }
        
        async function incrementStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                usageStats = {
                    totalDeployments: data.totalDeployments || 0,
                    deploymentsToday: data.deploymentsToday || 0,
                    lastDeployment: data.lastDeployment ? new Date(data.lastDeployment._seconds * 1000) : null
                };
                
                updateUsageDisplay();
                console.log('üì° Global deployment count updated securely!');
                return true;
            } catch (error) {
                console.log('üì± Secure API failed, using local increment');
                incrementLocalStats();
                return false;
            }
        }
        
        function loadLocalStats() {
            const stored = localStorage.getItem('demoUsageStats');
            if (stored) {
                usageStats = JSON.parse(stored);
                if (usageStats.lastDeployment) {
                    usageStats.lastDeployment = new Date(usageStats.lastDeployment);
                }
            } else {
                usageStats = {
                    totalDeployments: 0,
                    deploymentsToday: 0,
                    lastDeployment: null
                };
            }
            updateUsageDisplay();
        }
        
        function incrementLocalStats() {
            usageStats.totalDeployments++;
            usageStats.deploymentsToday++;
            usageStats.lastDeployment = new Date();
            localStorage.setItem('demoUsageStats', JSON.stringify(usageStats));
            updateUsageDisplay();
        }
        
        function updateUsageDisplay() {
            document.getElementById('totalDeployments').textContent = usageStats.totalDeployments.toLocaleString();
            document.getElementById('sessionsToday').textContent = usageStats.deploymentsToday;
            
            // Update connection status
            const connectionStatus = document.getElementById('connectionStatus');
            if (API_BASE.includes('netlify')) {
                connectionStatus.innerHTML = 'üîí <strong>Secure Global Stats</strong>';
                connectionStatus.style.color = '#48bb78';
            } else {
                connectionStatus.innerHTML = 'üì± <strong>Local Mode</strong>';
                connectionStatus.style.color = '#f6e05e';
            }
            
            if (usageStats.lastDeployment) {
                const lastTime = usageStats.lastDeployment;
                const now = new Date();
                const diffMinutes = Math.floor((now - lastTime) / 60000);
                
                let timeText;
                if (diffMinutes < 1) {
                    timeText = 'Just now';
                } else if (diffMinutes < 60) {
                    timeText = `${diffMinutes}m ago`;
                } else if (diffMinutes < 1440) {
                    timeText = `${Math.floor(diffMinutes / 60)}h ago`;
                } else {
                    timeText = lastTime.toLocaleDateString();
                }
                
                document.getElementById('lastDeployment').textContent = timeText;
            } else {
                document.getElementById('lastDeployment').textContent = 'Never';
            }
            
            document.getElementById('deployCount').textContent = sessionDeployments + ' Session';
        }
        
        function getActiveSteps() {
            return allSteps.filter(step => {
                if (step.requires.length === 0) return true;
                return step.requires.some(req => features[req]);
            });
        }
        
        function updateStats() {
            const activeSteps = getActiveSteps();
            let vmCount = 0;
            
            if (features.loadbalancer) vmCount += 1;
            if (features.k3s) vmCount += 3;
            if (features.harvester) vmCount += 3;
            
            document.getElementById('vmCount').textContent = vmCount + ' VMs';
            document.getElementById('actionCount').textContent = activeSteps.length + ' Actions';
        }
        
        function setupFeatureToggles() {
            ['loadbalancer', 'k3s', 'harvester'].forEach(feature => {
                const toggle = document.getElementById(`feature-${feature}`);
                const checkbox = toggle.querySelector('input');
                
                toggle.addEventListener('click', function(e) {
                    if (e.target.type !== 'checkbox') {
                        checkbox.checked = !checkbox.checked;
                    }
                    
                    features[feature] = checkbox.checked;
                    toggle.classList.toggle('active', checkbox.checked);
                    
                    if (!isRunning) {
                        updateStats();
                        renderSteps();
                        updateProgress();
                    }
                });
            });
        }
        
        function updateTimer() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = elapsed + 's';
            }
        }
        
        function addTerminalLine(text, className = 'text-gray') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `terminal-line ${className}`;
            line.textContent = text;
            terminal.appendChild(line);
            
            // Auto-scroll to bottom, but smoothly
            terminal.scrollTop = terminal.scrollHeight;
        }
        
        function updateProgress() {
            const activeSteps = getActiveSteps();
            const total = activeSteps.length;
            const completed = currentStep;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${completed} of ${total} steps`;
        }
        
        function renderSteps() {
            const activeSteps = getActiveSteps();
            const stepsList = document.getElementById('stepsList');
            
            stepsList.innerHTML = activeSteps.map((step, index) => {
                let className = '';
                let icon = '‚è≥';
                
                if (index < currentStep) {
                    className = 'completed';
                    icon = '‚úÖ';
                } else if (index === currentStep && isRunning) {
                    className = 'running';
                    icon = 'üîÑ';
                }
                
                return `
                    <div class="step ${className}">
                        <div class="step-title">${icon} ${step.title}</div>
                        <div class="step-desc">${step.desc}</div>
                    </div>
                `;
            }).join('');
        }
        
        async function runStep(stepIndex) {
            const activeSteps = getActiveSteps();
            const step = activeSteps[stepIndex];
            
            addTerminalLine(`üéØ Step ${stepIndex + 1}/${activeSteps.length}: ${step.title}`, 'text-yellow');
            addTerminalLine('', 'text-gray');
            
            for (const line of step.output) {
                await new Promise(resolve => setTimeout(resolve, step.id === 'harvester-deploy' ? 200 : 300));
                
                const className = line.includes('‚úÖ') ? 'text-green' :
                                line.includes('‚ö†Ô∏è') || line.includes('WARNING') ? 'text-yellow' :
                                line.includes('üîç') || line.includes('üìä') || line.includes('üéØ') ? 'text-blue' :
                                line.includes('üöÄ') || line.includes('curl') ? 'text-cyan' :
                                'text-gray';
                                
                addTerminalLine(line, className);
            }
            
            addTerminalLine('', 'text-gray');
        }
        
        async function deploy() {
            if (isRunning) return;
            
            console.log('Starting deployment...');
            
            // Increment global deployment count securely
            sessionDeployments++;
            await incrementStats();
            
            isRunning = true;
            currentStep = 0;
            startTime = Date.now();
            
            const activeSteps = getActiveSteps();
            
            // Update UI
            document.getElementById('deployBtn').textContent = '‚è≥ Deploying...';
            document.getElementById('deployBtn').disabled = true;
            document.getElementById('status').textContent = 'Running...';
            
            // Clear terminal
            document.getElementById('terminal').innerHTML = '';
            
            // Start timer
            timer = setInterval(updateTimer, 1000);
            
            addTerminalLine('üöÄ Starting infrastructure deployment...', 'text-cyan');
            addTerminalLine(`üîí Global deployment #${usageStats.totalDeployments} via secure API`, 'text-blue');
            addTerminalLine('üåç Stats synced globally with zero config exposure!', 'text-cyan');
            addTerminalLine('Components will discover each other automatically!', 'text-cyan');
            addTerminalLine('', 'text-gray');
            
            try {
                for (let i = 0; i < activeSteps.length; i++) {
                    currentStep = i;
                    renderSteps();
                    updateProgress();
                    
                    await runStep(i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                currentStep = activeSteps.length;
                renderSteps();
                updateProgress();
                
                addTerminalLine('üéâ Infrastructure deployment completed successfully!', 'text-green');
                addTerminalLine('All components are operational and auto-configured.', 'text-green');
                addTerminalLine('Runtime discovery worked perfectly - zero manual coordination!', 'text-green');
                addTerminalLine('üîí Global stats updated securely via Netlify function.', 'text-green');
                
                document.getElementById('status').textContent = 'Complete';
                
            } catch (error) {
                console.error('Deployment error:', error);
                addTerminalLine('‚ùå Deployment failed: ' + error.message, 'text-yellow');
                document.getElementById('status').textContent = 'Failed';
            } finally {
                isRunning = false;
                clearInterval(timer);
                document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
                document.getElementById('deployBtn').disabled = false;
            }
        }
        
        function reset() {
            console.log('Resetting demo...');
            
            if (timer) clearInterval(timer);
            
            isRunning = false;
            currentStep = 0;
            startTime = 0;
            
            document.getElementById('timer').textContent = '0s';
            document.getElementById('status').textContent = 'Ready';
            document.getElementById('deployBtn').textContent = '‚ñ∂Ô∏è Deploy Infrastructure';
            document.getElementById('deployBtn').disabled = false;
            
            document.getElementById('terminal').innerHTML = 
                '<div class="terminal-line text-gray">üí° Click "Deploy Infrastructure" to begin...</div>';
                
            renderSteps();
            updateProgress();
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üîí Secure infrastructure demo initialized');
            
            // Load global stats securely via Netlify function
            await fetchStats();
            
            setupFeatureToggles();
            document.getElementById('deployBtn').addEventListener('click', deploy);
            document.getElementById('resetBtn').addEventListener('click', reset);
            
            updateStats();
            renderSteps();
            updateProgress();
            
            // Periodic stats refresh for real-time updates
            setInterval(async () => {
                if (!isRunning) {
                    await fetchStats();
                }
            }, 30000); // Refresh every 30 seconds
        });
    </script>
</body>
</html>
