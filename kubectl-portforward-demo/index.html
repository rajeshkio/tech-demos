<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive kubectl port-forward Demo</title>
    <meta name="description" content="An interactive simulation that demystifies the network flow of kubectl port-forward from your browser to a Kubernetes pod.">
    
    <style>
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #2c3e50;
            --success-color: #50E3C2;
            --error-color: #E35050;
            --warning-color: #F8E71C;
            --bg-color: #f4f7f9;
            --panel-bg: #FFFFFF;
            --terminal-bg: #1e2b37;
            --text-dark: #333;
            --text-light: #ecf0f1;
            --border-color: #e2e8f0;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-dark);
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            background: var(--bg-color);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .page-header {
            text-align: center;
            padding: 2.5rem;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .page-header h1 {
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .page-header p {
            font-size: 1.1rem;
            color: #7f8c8d;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 2rem;
            padding: 2rem;
        }

        .simulation-column, .controls-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .panel-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .network-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
        }

        .network-node {
            text-align: center;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }
        
        .node-icon {
            font-size: 2.5rem;
            line-height: 1;
        }

        .node-label {
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .node-sublabel {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        .network-node.active .node-icon {
            animation: bounce 0.6s ease;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .connection {
            flex-grow: 1;
            height: 4px;
            background-color: var(--border-color);
            position: relative;
        }
        
        .connection svg {
            position: absolute;
            top: -8px;
            left: 0;
            width: 100%;
            height: 20px;
            overflow: visible;
        }

        .data-flow-path {
            stroke-dasharray: 8 8;
            stroke-width: 4;
            stroke-linecap: round;
            opacity: 0;
            animation: flow 1s linear infinite;
        }
        
        .connection.active .data-flow-path {
            opacity: 1;
        }
        
        .forward-flow { stroke: var(--primary-color); }
        .backward-flow { stroke: var(--success-color); animation-direction: reverse; }

        @keyframes flow {
            to { stroke-dashoffset: -32; }
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn.danger { background: var(--error-color); }
        .btn.success { background: var(--success-color); }

        .status-list .status-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .status-list .status-item:last-child {
            border-bottom: none;
        }

        .status-value {
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .status-value.connected { color: var(--success-color); }
        .status-value.disconnected { color: var(--error-color); }

        .terminal {
            background: var(--terminal-bg);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text-light);
            font-family: var(--font-mono);
        }

        .terminal-header {
            display: flex;
            align-items: center;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #34495e;
        }
        
        .terminal-dots { display: flex; gap: 6px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.red { background: #ff5f56; }
        .dot.yellow { background: #ffbd2e; }
        .dot.green { background: #27c93f; }

        .terminal-content {
            height: 250px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 0.9rem;
        }
        
        .terminal-line .prompt { color: var(--success-color); }
        .terminal-line .command { color: #87CEFA; }
        .terminal-line .output.success { color: var(--success-color); }
        .terminal-line .output.error { color: var(--error-color); }
        .terminal-line .output.warning { color: var(--warning-color); }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="page-header">
            <h1>kubectl port-forward Deep Dive</h1>
            <p>An interactive simulation of the complete network flow.</p>
        </header>

        <main class="main-content">
            <section class="simulation-column">
                <div class="panel">
                    <h2 class="panel-header">üåê Network Flow</h2>
                    <div class="network-diagram">
                        <div class="network-node" id="node-browser">
                            <div class="node-icon">üåê</div>
                            <div class="node-label">Browser</div>
                            <div class="node-sublabel">localhost:8080</div>
                        </div>
                        <div class="connection" id="conn-1">
                            <svg><path class="data-flow-path forward-flow" d="M0 10 H1000"></path><path class="data-flow-path backward-flow" d="M0 10 H1000"></path></svg>
                        </div>
                        <div class="network-node" id="node-kubectl">
                            <div class="node-icon">üíª</div>
                            <div class="node-label">kubectl</div>
                            <div class="node-sublabel">Proxy</div>
                        </div>
                        <div class="connection" id="conn-2">
                             <svg><path class="data-flow-path forward-flow" d="M0 10 H1000"></path><path class="data-flow-path backward-flow" d="M0 10 H1000"></path></svg>
                        </div>
                        <div class="network-node" id="node-apiserver">
                            <div class="node-icon">üîë</div>
                            <div class="node-label">API Server</div>
                            <div class="node-sublabel">SPDY/WebSocket</div>
                        </div>
                        <div class="connection" id="conn-3">
                             <svg><path class="data-flow-path forward-flow" d="M0 10 H1000"></path><path class="data-flow-path backward-flow" d="M0 10 H1000"></path></svg>
                        </div>
                        <div class="network-node" id="node-kubelet">
                             <div class="node-icon">üõ†Ô∏è</div>
                            <div class="node-label">Kubelet</div>
                             <div class="node-sublabel">Node Agent</div>
                        </div>
                        <div class="connection" id="conn-4">
                             <svg><path class="data-flow-path forward-flow" d="M0 10 H1000"></path><path class="data-flow-path backward-flow" d="M0 10 H1000"></path></svg>
                        </div>
                        <div class="network-node" id="node-pod">
                             <div class="node-icon">üì¶</div>
                            <div class="node-label">Pod</div>
                             <div class="node-sublabel">nginx:80</div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <h2 class="panel-header">üíª Terminal</h2>
                    <div class="terminal">
                        <div class="terminal-header">
                            <div class="terminal-dots">
                                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                            </div>
                        </div>
                        <div class="terminal-content" id="terminal-content"></div>
                    </div>
                </div>
            </section>
            
            <section class="controls-column">
                <div class="panel">
                    <h2 class="panel-header">üéÆ Controls</h2>
                    <div class="controls">
                        <button class="btn" id="btn-start">Start Port Forward</button>
                        <button class="btn" id="btn-request" disabled>Send HTTP Request</button>
                        <button class="btn danger" id="btn-kill" disabled>Kill Process</button>
                        <button class="btn" id="btn-reset">Reset Demo</button>
                    </div>
                </div>
                <div class="panel">
                    <h2 class="panel-header">üìä Status</h2>
                    <div class="status-list">
                        <div class="status-item">
                            <span>Tunnel Status:</span>
                            <span class="status-value disconnected" id="status-tunnel">Disconnected</span>
                        </div>
                         <div class="status-item">
                            <span>Target Pod:</span>
                            <span class="status-value" id="status-pod">nginx-pod</span>
                        </div>
                        <div class="status-item">
                            <span>Local Port:</span>
                            <span class="status-value" id="status-local-port">8080</span>
                        </div>
                         <div class="status-item">
                            <span>Pod Port:</span>
                            <span class="status-value" id="status-pod-port">80</span>
                        </div>
                        <div class="status-item">
                            <span>Bytes Transferred:</span>
                            <span class="status-value" id="status-bytes">0 B</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            const appState = {
                tunnelActive: false,
                bytesTransferred: 0,
                podName: 'nginx-pod-7b5dcf9f9c-12345',
                localPort: 8080,
                podPort: 80,
                get formattedBytes() {
                    if (this.bytesTransferred < 1024) return `${this.bytesTransferred} B`;
                    return `${(this.bytesTransferred / 1024).toFixed(2)} KB`;
                }
            };

            // --- DOM ELEMENTS ---
            const elements = {
                buttons: {
                    start: document.getElementById('btn-start'),
                    request: document.getElementById('btn-request'),
                    kill: document.getElementById('btn-kill'),
                    reset: document.getElementById('btn-reset'),
                },
                status: {
                    tunnel: document.getElementById('status-tunnel'),
                    pod: document.getElementById('status-pod'),
                    localPort: document.getElementById('status-local-port'),
                    podPort: document.getElementById('status-pod-port'),
                    bytes: document.getElementById('status-bytes'),
                },
                terminalContent: document.getElementById('terminal-content'),
                nodes: ['browser', 'kubectl', 'apiserver', 'kubelet', 'pod'].map(id => document.getElementById(`node-${id}`)),
                connections: [1, 2, 3, 4].map(id => document.getElementById(`conn-${id}`)),
            };

            // --- RENDER & LOGIC FUNCTIONS ---
            const render = () => {
                // Buttons
                elements.buttons.start.disabled = appState.tunnelActive;
                elements.buttons.request.disabled = !appState.tunnelActive;
                elements.buttons.kill.disabled = !appState.tunnelActive;

                // Status Panel
                elements.status.tunnel.textContent = appState.tunnelActive ? 'Connected' : 'Disconnected';
                elements.status.tunnel.className = `status-value ${appState.tunnelActive ? 'connected' : 'disconnected'}`;
                elements.status.pod.textContent = appState.podName;
                elements.status.localPort.textContent = appState.localPort;
                elements.status.podPort.textContent = appState.podPort;
                elements.status.bytes.textContent = appState.formattedBytes;
            };

            const logToTerminal = (text, type = 'output') => {
                const line = document.createElement('div');
                line.className = 'terminal-line';
                line.innerHTML = `<span class="${type}">${text}</span>`;
                elements.terminalContent.appendChild(line);
                elements.terminalContent.scrollTop = elements.terminalContent.scrollHeight;
            };

            const typeCommand = (command, delay = 50) => {
                return new Promise(resolve => {
                    let i = 0;
                    const prompt = `<span class="prompt">$ </span>`;
                    const line = document.createElement('div');
                    line.className = 'terminal-line';
                    line.innerHTML = `${prompt}<span class="command"></span>`;
                    elements.terminalContent.appendChild(line);
                    const commandElement = line.querySelector('.command');

                    const interval = setInterval(() => {
                        commandElement.textContent += command[i];
                        i++;
                        if (i === command.length) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, delay);
                });
            };

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            const animateFlow = async (direction = 'forward') => {
                const flowClass = direction === 'forward' ? 'forward-flow' : 'backward-flow';
                const sequence = direction === 'forward' 
                    ? [0, 1, 2, 3] 
                    : [3, 2, 1, 0];
                
                for (const i of sequence) {
                    elements.connections[i].querySelector(`.${flowClass}`).parentElement.parentElement.classList.add('active');
                    elements.nodes[i + (direction === 'forward' ? 0 : 1)].classList.add('active');
                    await sleep(400);
                    elements.nodes[i + (direction === 'forward' ? 0 : 1)].classList.remove('active');
                }
                 elements.nodes[direction === 'forward' ? 4 : 0].classList.add('active');

                 await sleep(800);
                 elements.nodes.forEach(n => n.classList.remove('active'));
                 elements.connections.forEach(c => c.classList.remove('active'));
            };

            // --- EVENT HANDLERS ---
            const handleStart = async () => {
                logToTerminal('');
                await typeCommand(`kubectl port-forward pod/${appState.podName} ${appState.localPort}:${appState.podPort}`);
                await sleep(500);
                logToTerminal('I0721 23:35:10.123456 ... portforward.go:400] Forwarding from 127.0.0.1:8080 -> 80');
                logToTerminal('I0721 23:35:10.123567 ... portforward.go:400] Forwarding from [::1]:8080 -> 80');
                await sleep(200);
                logToTerminal('I0721 23:35:10.345678 ... portforward.go:233] Handling connection for 8080', 'output success');
                appState.tunnelActive = true;
                render();
            };

            const handleRequest = async () => {
                logToTerminal('');
                await typeCommand(`curl http://localhost:${appState.localPort}`);
                logToTerminal('Sending request through tunnel...');
                await animateFlow('forward');
                
                logToTerminal('Receiving response from pod...');
                await animateFlow('backward');

                const transferred = Math.floor(512 + Math.random() * 1024);
                appState.bytesTransferred += transferred;
                logToTerminal(`HTTP/1.1 200 OK`, 'output success');
                logToTerminal(`Content-Length: ${transferred}`);
                logToTerminal('Welcome to nginx!', 'output');
                render();
            };

            const handleKill = () => {
                logToTerminal('');
                logToTerminal('^C', 'output warning');
                logToTerminal('I0721 23:36:00.987654 ... portforward.go:275] remove connection...', 'output warning');
                appState.tunnelActive = false;
                render();
            };

            const handleReset = () => {
                appState.tunnelActive = false;
                appState.bytesTransferred = 0;
                elements.terminalContent.innerHTML = '';
                logToTerminal('Demo reset. Ready to start.');
                render();
            };

            // --- INITIALIZATION ---
            elements.buttons.start.addEventListener('click', handleStart);
            elements.buttons.request.addEventListener('click', handleRequest);
            elements.buttons.kill.addEventListener('click', handleKill);
            elements.buttons.reset.addEventListener('click', handleReset);
            
            handleReset(); // Initial setup
        });
    </script>
</body>
</html>
