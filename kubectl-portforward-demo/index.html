<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive kubectl port-forward Demo</title>
    <meta name="description" content="An interactive simulation that demystifies the network flow of kubectl port-forward from your browser to a Kubernetes pod.">
    
    <style>
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #2c3e50;
            --success-color: #50E3C2;
            --error-color: #E35050;
            --warning-color: #F8E71C;
            --bg-color: #f4f7f9;
            --panel-bg: #FFFFFF;
            --terminal-bg: #1e2b37;
            --text-dark: #333;
            --text-light: #ecf0f1;
            --border-color: #e2e8f0;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-dark);
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            background: var(--bg-color);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .page-header {
            text-align: center;
            padding: 2.5rem;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .page-header h1 {
            font-size: 2.5rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .page-header p {
            font-size: 1.1rem;
            color: #7f8c8d;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            padding: 15px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            font-size: 14px;
            color: #4a5568;
            border-bottom: 1px solid var(--border-color);
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .stat-label {
            font-size: 12px;
            margin-top: 2px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.5fr 1fr;
            gap: 2rem;
            padding: 2rem;
        }

        .simulation-column, .controls-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .panel-header {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .network-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
        }

        .network-node {
            text-align: center;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }
        
        .node-icon {
            font-size: 2.5rem;
            line-height: 1;
        }

        .node-label {
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .node-sublabel {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        
        .network-node.active .node-icon {
            animation: bounce 0.6s ease;
        }
        
        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .connection {
            flex-grow: 1;
            height: 4px;
            background-color: var(--border-color);
            position: relative;
        }
        
        .connection svg {
            position: absolute;
            top: -8px;
            left: 0;
            width: 100%;
            height: 20px;
            overflow: visible;
        }

        .data-flow-path {
            stroke-dasharray: 8 8;
            stroke-width: 4;
            stroke-linecap: round;
            opacity: 0;
            animation: flow 1s linear infinite;
        }
        
        .connection.active .data-flow-path {
            opacity: 1;
        }
        
        .forward-flow { stroke: var(--primary-color); }
        .backward-flow { stroke: var(--success-color); animation-direction: reverse; }

        @keyframes flow {
            to { stroke-dashoffset: -32; }
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .btn.danger { background: var(--error-color); }
        .btn.success { background: var(--success-color); }

        .status-list .status-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .status-list .status-item:last-child {
            border-bottom: none;
        }

        .status-value {
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .status-value.connected { color: var(--success-color); }
        .status-value.disconnected { color: var(--error-color); }

        .terminal {
            background: var(--terminal-bg);
            border-radius: 8px;
            padding: 1rem;
            color: var(--text-light);
            font-family: var(--font-mono);
        }

        .terminal-header {
            display: flex;
            align-items: center;
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #34495e;
        }
        
        .terminal-dots { display: flex; gap: 6px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.red { background: #ff5f56; }
        .dot.yellow { background: #ffbd2e; }
        .dot.green { background: #27c93f; }

        .terminal-content {
            height: 250px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 0.9rem;
        }
        
        .terminal-line .prompt { color: var(--success-color); }
        .terminal-line .command { color: #87CEFA; }
        .terminal-line .output.success { color: var(--success-color); }
        .terminal-line .output.error { color: var(--error-color); }
        .terminal-line .output.warning { color: var(--warning-color); }

        .usage-stats {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 13px;
            color: #4a5568;
        }
        
        .usage-stats .highlight {
            font-weight: 600;
            color: #2d3748;
        }

        .footer {
            padding: 20px 30px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .footer-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .footer-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            color: #4a5568;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .footer-link:hover {
            background: #edf2f7;
            color: #2d3748;
            transform: translateY(-1px);
        }
        
        .footer-link.github:hover {
            background: #24292e;
            color: white;
        }
        
        .footer-link.linkedin:hover {
            background: #0077b5;
            color: white;
        }
        
        .footer-link.back:hover {
            background: #667eea;
            color: white;
        }
        
        .footer-link.blog:hover {
            background: #f56565;
            color: white;
        }
        
        .footer-credits {
            font-size: 13px;
            color: #718096;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .footer {
                flex-direction: column;
                text-align: center;
            }
            .footer-links {
                justify-content: center;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="page-header">
            <h1>üöÄ kubectl port-forward Deep Dive</h1>
            <p>An interactive simulation of the complete network flow from your browser to a Kubernetes pod</p>
        </header>

        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="totalTunnels">0</div>
                <div class="stat-label">Tunnels Created</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalRequests">0</div>
                <div class="stat-label">HTTP Requests</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="totalBytes">0</div>
                <div class="stat-label">Bytes Transferred</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="successRate">100%</div>
                <div class="stat-label">Success Rate</div>
            </div>
        </div>

        <main class="main-content">
            <section class="simulation-column">
                <div class="panel">
                    <h2 class="panel-header">üåê Network Flow</h2>
                    <div class="network-diagram">
                        <div class="network-node" id="node-browser">
                            <div class="node-icon">üåê</div>
                            <div class="node-label">Browser</div>
                            <div class="node-sublabel">localhost:8080</div>
                        </div>
                        <div class="connection" id="conn-1">
                            <svg><path class="data-flow-path forward-flow" d="M0 10 H1000"></path><path class="data-flow-path backward-flow" d="M0 10 H1000"></path></svg>
                        </div>
                        <div class="network-node" id="node-kubectl">
                            <div class="node-icon">üíª</div>
                            <div class="node-label">kubectl</div>
                            <div class="node-sublabel">Proxy</div>
                        </div>
                        <div class="connection" id="conn-2">
                             <svg><path class="data-flow-path forward-flow" d="M0 10 H1000"></path><path class="data-flow-path backward-flow" d="M0 10 H1000"></path></svg>
                        </div>
                        <div class="network-node" id="node-apiserver">
                            <div class="node-icon">üîë</div>
                            <div class="node-label">API Server</div>
                            <div class="node-sublabel">SPDY/WebSocket</div>
                        </div>
                        <div class="connection" id="conn-3">
                             <svg><path class="data-flow-path forward-flow" d="M0 10 H1000"></path><path class="data-flow-path backward-flow" d="M0 10 H1000"></path></svg>
                        </div>
                        <div class="network-node" id="node-kubelet">
                             <div class="node-icon">üõ†Ô∏è</div>
                            <div class="node-label">Kubelet</div>
                             <div class="node-sublabel">Node Agent</div>
                        </div>
                        <div class="connection" id="conn-4">
                             <svg><path class="data-flow-path forward-flow" d="M0 10 H1000"></path><path class="data-flow-path backward-flow" d="M0 10 H1000"></path></svg>
                        </div>
                        <div class="network-node" id="node-pod">
                             <div class="node-icon">üì¶</div>
                            <div class="node-label">Pod</div>
                             <div class="node-sublabel">nginx:80</div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <h2 class="panel-header">üíª Terminal</h2>
                    <div class="terminal">
                        <div class="terminal-header">
                            <div class="terminal-dots">
                                <div class="dot red"></div><div class="dot yellow"></div><div class="dot green"></div>
                            </div>
                        </div>
                        <div class="terminal-content" id="terminal-content"></div>
                    </div>
                </div>
            </section>
            
            <section class="controls-column">
                <div class="panel">
                    <h2 class="panel-header">üéÆ Controls</h2>
                    <div class="controls">
                        <button class="btn" id="btn-start">Start Port Forward</button>
                        <button class="btn" id="btn-request" disabled>Send HTTP Request</button>
                        <button class="btn danger" id="btn-kill" disabled>Kill Process</button>
                        <button class="btn" id="btn-reset">Reset Demo</button>
                    </div>
                </div>
                <div class="panel">
                    <h2 class="panel-header">üìä Status</h2>
                    <div class="status-list">
                        <div class="status-item">
                            <span>Tunnel Status:</span>
                            <span class="status-value disconnected" id="status-tunnel">Disconnected</span>
                        </div>
                         <div class="status-item">
                            <span>Target Pod:</span>
                            <span class="status-value" id="status-pod">nginx-pod</span>
                        </div>
                        <div class="status-item">
                            <span>Local Port:</span>
                            <span class="status-value" id="status-local-port">8080</span>
                        </div>
                         <div class="status-item">
                            <span>Pod Port:</span>
                            <span class="status-value" id="status-pod-port">80</span>
                        </div>
                        <div class="status-item">
                            <span>Session Bytes:</span>
                            <span class="status-value" id="status-bytes">0 B</span>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <div class="usage-stats">
            <span id="connectionStatus">üîÑ Connecting to global stats...</span> ‚Ä¢
            <span class="highlight" id="totalDemos">0</span> total port-forward demos 
            ‚Ä¢ <span class="highlight" id="demosToday">0</span> sessions today 
            ‚Ä¢ Last demo: <span class="highlight" id="lastDemo">Never</span>
        </div>
        
        <div class="footer">
            <div class="footer-links">
                <a href="https://demos.learningdevops.com/" class="footer-link back">
                    ‚Üê Back to Demos
                </a>
                <a href="https://www.linkedin.com/in/techwith-rajesh/" class="footer-link linkedin" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                    LinkedIn
                </a>
                <a href="https://medium.com/@rk90229/from-local-to-pod-how-kubectl-port-forward-bridges-the-gap-0b27af2a7aea" class="footer-link blog" target="_blank">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                    </svg>
                    Blog Article
                </a>
            </div>
            <div class="footer-credits">
                Built with kubectl ‚Ä¢ Kubernetes ‚Ä¢ WebSockets ‚Ä¢ Netlify Functions
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            const appState = {
                tunnelActive: false,
                sessionBytes: 0,
                sessionTunnels: 0,
                sessionRequests: 0,
                sessionErrors: 0,
                podName: 'nginx-pod-7b5dcf9f9c-12345',
                localPort: 8080,
                podPort: 80,
                get formattedBytes() {
                    if (this.sessionBytes < 1024) return `${this.sessionBytes} B`;
                    return `${(this.sessionBytes / 1024).toFixed(2)} KB`;
                }
            };

            // Global stats tracking
            let usageStats = {
                totalDemos: 0,
                demosToday: 0,
                lastDemo: null
            };

            // Auto-detect Netlify function endpoint
            const isNetlify = window.location.hostname.includes('netlify.app');
            const API_BASE = isNetlify 
                ? `${window.location.origin}/.netlify/functions`
                : 'https://aesthetic-croissant-a06c3f.netlify.app/.netlify/functions';

            // --- DOM ELEMENTS ---
            const elements = {
                buttons: {
                    start: document.getElementById('btn-start'),
                    request: document.getElementById('btn-request'),
                    kill: document.getElementById('btn-kill'),
                    reset: document.getElementById('btn-reset'),
                },
                status: {
                    tunnel: document.getElementById('status-tunnel'),
                    pod: document.getElementById('status-pod'),
                    localPort: document.getElementById('status-local-port'),
                    podPort: document.getElementById('status-pod-port'),
                    bytes: document.getElementById('status-bytes'),
                },
                stats: {
                    totalTunnels: document.getElementById('totalTunnels'),
                    totalRequests: document.getElementById('totalRequests'),
                    totalBytes: document.getElementById('totalBytes'),
                    successRate: document.getElementById('successRate'),
                },
                usage: {
                    connectionStatus: document.getElementById('connectionStatus'),
                    totalDemos: document.getElementById('totalDemos'),
                    demosToday: document.getElementById('demosToday'),
                    lastDemo: document.getElementById('lastDemo'),
                },
                terminalContent: document.getElementById('terminal-content'),
                nodes: ['browser', 'kubectl', 'apiserver', 'kubelet', 'pod'].map(id => document.getElementById(`node-${id}`)),
                connections: [1, 2, 3, 4].map(id => document.getElementById(`conn-${id}`)),
            };

            // --- STATS FUNCTIONS ---
            async function fetchStats() {
                try {
                    const response = await fetch(`${API_BASE}/portforward-stats`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    
                    usageStats = {
                        totalDemos: data.totalDemos || 0,
                        demosToday: data.demosToday || 0,
                        lastDemo: null
                    };
                    
                    // Handle Firebase timestamp conversion
                    if (data.lastDemo) {
                        if (data.lastDemo._seconds) {
                            usageStats.lastDemo = new Date(data.lastDemo._seconds * 1000);
                        } else if (data.lastDemo.seconds) {
                            usageStats.lastDemo = new Date(data.lastDemo.seconds * 1000);
                        } else if (typeof data.lastDemo === 'string') {
                            usageStats.lastDemo = new Date(data.lastDemo);
                        }
                    }
                    
                    updateUsageDisplay();
                    console.log('üì° Port-forward stats loaded securely via Netlify function');
                    return true;
                } catch (error) {
                    console.log('üì± Secure API unavailable, using localStorage fallback:', error);
                    loadLocalStats();
                    return false;
                }
            }
            
            async function incrementStats() {
                try {
                    const response = await fetch(`${API_BASE}/portforward-stats`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    
                    usageStats = {
                        totalDemos: data.totalDemos || 0,
                        demosToday: data.demosToday || 0,
                        lastDemo: null
                    };
                    
                    // Handle Firebase timestamp conversion
                    if (data.lastDemo) {
                        if (data.lastDemo._seconds) {
                            usageStats.lastDemo = new Date(data.lastDemo._seconds * 1000);
                        } else if (data.lastDemo.seconds) {
                            usageStats.lastDemo = new Date(data.lastDemo.seconds * 1000);
                        }
                    }
                    
                    updateUsageDisplay();
                    console.log('üì° Global port-forward demo count updated securely!');
                    return true;
                } catch (error) {
                    console.log('üì± Secure API failed, using local increment:', error);
                    incrementLocalStats();
                    return false;
                }
            }
            
            function loadLocalStats() {
                const stored = localStorage.getItem('portForwardUsageStats');
                if (stored) {
                    usageStats = JSON.parse(stored);
                    if (usageStats.lastDemo) {
                        usageStats.lastDemo = new Date(usageStats.lastDemo);
                    }
                } else {
                    usageStats = {
                        totalDemos: 0,
                        demosToday: 0,
                        lastDemo: null
                    };
                }
                updateUsageDisplay();
            }
            
            function incrementLocalStats() {
                usageStats.totalDemos++;
                usageStats.demosToday++;
                usageStats.lastDemo = new Date();
                localStorage.setItem('portForwardUsageStats', JSON.stringify(usageStats));
                updateUsageDisplay();
            }
            
            function updateUsageDisplay() {
                elements.usage.totalDemos.textContent = usageStats.totalDemos.toLocaleString();
                elements.usage.demosToday.textContent = usageStats.demosToday;
                
                // Update connection status
                if (API_BASE.includes('netlify')) {
                    elements.usage.connectionStatus.innerHTML = 'üîí <strong>Secure Global Stats</strong>';
                    elements.usage.connectionStatus.style.color = '#48bb78';
                } else {
                    elements.usage.connectionStatus.innerHTML = 'üì± <strong>Local Mode</strong>';
                    elements.usage.connectionStatus.style.color = '#f6e05e';
                }
                
                if (usageStats.lastDemo && usageStats.lastDemo instanceof Date && !isNaN(usageStats.lastDemo)) {
                    const lastTime = usageStats.lastDemo;
                    const now = new Date();
                    const diffMinutes = Math.floor((now - lastTime) / 60000);
                    
                    let timeText;
                    if (diffMinutes < 1) {
                        timeText = 'Just now';
                    } else if (diffMinutes < 60) {
                        timeText = `${diffMinutes}m ago`;
                    } else if (diffMinutes < 1440) {
                        timeText = `${Math.floor(diffMinutes / 60)}h ago`;
                    } else {
                        timeText = lastTime.toLocaleDateString();
                    }
                    
                    elements.usage.lastDemo.textContent = timeText;
                } else {
                    elements.usage.lastDemo.textContent = 'Never';
                }
            }

            // --- RENDER & LOGIC FUNCTIONS ---
            const render = () => {
                // Buttons
                elements.buttons.start.disabled = appState.tunnelActive;
                elements.buttons.request.disabled = !appState.tunnelActive;
                elements.buttons.kill.disabled = !appState.tunnelActive;

                // Status Panel
                elements.status.tunnel.textContent = appState.tunnelActive ? 'Connected' : 'Disconnected';
                elements.status.tunnel.className = `status-value ${appState.tunnelActive ? 'connected' : 'disconnected'}`;
                elements.status.pod.textContent = appState.podName;
                elements.status.localPort.textContent = appState.localPort;
                elements.status.podPort.textContent = appState.podPort;
                elements.status.bytes.textContent = appState.formattedBytes;

                // Stats bar
                elements.stats.totalTunnels.textContent = appState.sessionTunnels;
                elements.stats.totalRequests.textContent = appState.sessionRequests;
                elements.stats.totalBytes.textContent = appState.formattedBytes;
                
                const successRate = appState.sessionRequests > 0 
                    ? Math.round(((appState.sessionRequests - appState.sessionErrors) / appState.sessionRequests) * 100)
                    : 100;
                elements.stats.successRate.textContent = successRate + '%';
            };

            const logToTerminal = (text, type = 'output') => {
                const line = document.createElement('div');
                line.className = 'terminal-line';
                line.innerHTML = `<span class="${type}">${text}</span>`;
                elements.terminalContent.appendChild(line);
                elements.terminalContent.scrollTop = elements.terminalContent.scrollHeight;
            };

            const typeCommand = (command, delay = 50) => {
                return new Promise(resolve => {
                    let i = 0;
                    const prompt = `<span class="prompt">$ </span>`;
                    const line = document.createElement('div');
                    line.className = 'terminal-line';
                    line.innerHTML = `${prompt}<span class="command"></span>`;
                    elements.terminalContent.appendChild(line);
                    const commandElement = line.querySelector('.command');

                    const interval = setInterval(() => {
                        commandElement.textContent += command[i];
                        i++;
                        if (i === command.length) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, delay);
                });
            };

            const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            
            const animateFlow = async (direction = 'forward') => {
                const flowClass = direction === 'forward' ? 'forward-flow' : 'backward-flow';
                const sequence = direction === 'forward' 
                    ? [0, 1, 2, 3] 
                    : [3, 2, 1, 0];
                
                for (const i of sequence) {
                    elements.connections[i].querySelector(`.${flowClass}`).parentElement.parentElement.classList.add('active');
                    elements.nodes[i + (direction === 'forward' ? 0 : 1)].classList.add('active');
                    await sleep(400);
                    elements.nodes[i + (direction === 'forward' ? 0 : 1)].classList.remove('active');
                }
                 elements.nodes[direction === 'forward' ? 4 : 0].classList.add('active');

                 await sleep(800);
                 elements.nodes.forEach(n => n.classList.remove('active'));
                 elements.connections.forEach(c => c.classList.remove('active'));
            };

            // --- EVENT HANDLERS ---
            const handleStart = async () => {
                logToTerminal('');
                await typeCommand(`kubectl port-forward pod/${appState.podName} ${appState.localPort}:${appState.podPort}`);
                await sleep(500);
                logToTerminal('I0721 23:35:10.123456 ... portforward.go:400] Forwarding from 127.0.0.1:8080 -> 80');
                logToTerminal('I0721 23:35:10.123567 ... portforward.go:400] Forwarding from [::1]:8080 -> 80');
                await sleep(200);
                logToTerminal('I0721 23:35:10.345678 ... portforward.go:233] Handling connection for 8080', 'output success');
                
                appState.tunnelActive = true;
                appState.sessionTunnels++;
                
                // Increment global demo count
                await incrementStats();
                
                render();
            };

            const handleRequest = async () => {
                logToTerminal('');
                await typeCommand(`curl http://localhost:${appState.localPort}`);
                logToTerminal('Sending request through tunnel...');
                await animateFlow('forward');
                
                logToTerminal('Receiving response from pod...');
                await animateFlow('backward');

                const transferred = Math.floor(512 + Math.random() * 1024);
                appState.sessionBytes += transferred;
                appState.sessionRequests++;
                
                logToTerminal(`HTTP/1.1 200 OK`, 'output success');
                logToTerminal(`Content-Length: ${transferred}`);
                logToTerminal('Welcome to nginx!', 'output');
                logToTerminal(`üîí Global demo #${usageStats.totalDemos} via secure API`, 'output success');
                render();
            };

            const handleKill = () => {
                logToTerminal('');
                logToTerminal('^C', 'output warning');
                logToTerminal('I0721 23:36:00.987654 ... portforward.go:275] remove connection...', 'output warning');
                appState.tunnelActive = false;
                render();
            };

            const handleReset = () => {
                appState.tunnelActive = false;
                appState.sessionBytes = 0;
                appState.sessionTunnels = 0;
                appState.sessionRequests = 0;
                appState.sessionErrors = 0;
                elements.terminalContent.innerHTML = '';
                logToTerminal('üí° Click "Start Port Forward" to begin the simulation...');
                logToTerminal('üéØ This demo shows exactly how kubectl creates secure tunnels');
                logToTerminal('üîí All stats are tracked globally via secure Netlify functions');
                logToTerminal('');
                render();
            };

            // --- INITIALIZATION ---
            elements.buttons.start.addEventListener('click', handleStart);
            elements.buttons.request.addEventListener('click', handleRequest);
            elements.buttons.kill.addEventListener('click', handleKill);
            elements.buttons.reset.addEventListener('click', handleReset);
            
            // Initialize the app
            fetchStats().then(() => {
                handleReset(); // Initial setup
                
                // Periodic stats refresh
                setInterval(async () => {
                    if (!appState.tunnelActive) {
                        await fetchStats();
                    }
                }, 30000);
            });
        });
    </script>
</body>
</html>
