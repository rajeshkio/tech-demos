<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoreDNS Autopath Interactive Demo</title>
    <meta name="description" content="An interactive simulation demonstrating the performance benefits of the CoreDNS Autopath plugin in Kubernetes.">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #2d3748;
            --success-color: #38a169;
            --error-color: #c53030;
            --warning-color: #d69e2e;
            --bg-color: #f8fafc;
            --panel-bg: white;
            --terminal-bg: #1a202c;
            --text-dark: #2d3748;
            --text-light: #e2e8f0;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', 'Courier New', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-sans);
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            padding: 2rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: auto;
            background: var(--bg-color);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .page-header {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #4a5568 100%);
            color: white;
            padding: 2.5rem;
            text-align: center;
        }
        
        .page-header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .page-header p { font-size: 1.1rem; opacity: 0.9; }

        .controls-bar {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--panel-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .toggle-group { display: flex; background: #e2e8f0; border-radius: 8px; padding: 4px; }
        .toggle-option { padding: 10px 20px; border: none; background: transparent; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; color: #4a5568; }
        .toggle-option.active { background: white; color: var(--text-dark); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .domain-input { display: flex; gap: 0.75rem; align-items: center; }
        .domain-input input { padding: 10px 15px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 1rem; width: 250px; transition: border-color 0.2s; }
        .domain-input input:focus { outline: none; border-color: var(--primary-color); }

        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }

        .main-content { display: grid; grid-template-columns: 1fr 1fr; }

        .diagram-panel { padding: 1.5rem; border-right: 1px solid var(--border-color); position: relative; min-height: 500px; }
        .diagram-container { position: relative; height: 100%; }

        .component { position: absolute; text-align: center; font-weight: 600; font-size: 0.9rem; padding: 1rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .component .icon { font-size: 2.5rem; }
        .pod { background: #e6fffa; border: 2px solid #38b2ac; color: #285e61; top: 15%; left: 15%; }
        .coredns { background: #fef5e7; border: 2px solid var(--warning-color); color: #744210; top: 15%; right: 15%; }
        .external-dns { background: #e6ffed; border: 2px solid var(--success-color); color: #22543d; bottom: 15%; right: 15%; }

        .terminal-panel { background: var(--terminal-bg); padding: 1.5rem; color: var(--text-light); font-family: var(--font-mono); display: flex; flex-direction: column; }
        .terminal-header { margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #4a5568; color: var(--text-muted); }
        .terminal-content { flex-grow: 1; overflow-y: auto; font-size: 0.9rem; line-height: 1.6; }

        .terminal-line .prompt { color: var(--success-color); }
        .terminal-line .command { color: #87CEFA; }
        .terminal-line .output.success { color: var(--success-color); }
        .terminal-line .output.error { color: var(--error-color); }
        .terminal-line .output.info { color: #63b3ed; }

        .arrow-path { stroke-width: 3; fill: none; stroke-dasharray: 6 6; animation: dash 1.5s linear infinite; transition: opacity 0.3s; }
        @keyframes dash { to { stroke-dashoffset: -24; } }
        
        .arrow-text { font-weight: 600; font-size: 0.9rem; transition: opacity 0.3s; }
        .success { fill: var(--success-color); stroke: var(--success-color); }
        .error { fill: var(--error-color); stroke: var(--error-color); }
        .smart { fill: var(--primary-color); stroke: var(--primary-color); }

        @media (max-width: 900px) {
            .main-content { grid-template-columns: 1fr; }
            .diagram-panel { min-height: 400px; border-right: none; border-bottom: 1px solid var(--border-color); }
            .controls-bar { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <h1>üîç CoreDNS Autopath Interactive Demo</h1>
            <p>Experience the difference between default DNS resolution and autopath optimization.</p>
        </header>

        <section class="controls-bar">
            <div class="toggle-group">
                <button id="btn-default" class="toggle-option">üêå Default</button>
                <button id="btn-autopath" class="toggle-option">üöÄ Autopath</button>
            </div>
            <div class="domain-input">
                <input type="text" id="domain-input" placeholder="e.g., google.com" value="google.com">
                <button id="btn-resolve" class="btn btn-primary">Resolve DNS</button>
            </div>
        </section>

        <main class="main-content">
            <section class="diagram-panel">
                <div class="diagram-container" id="diagram-container">
                    <svg style="position:absolute; width:0; height:0;">
                        <defs>
                            <marker id="arrowhead-success" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" class="success"/></marker>
                            <marker id="arrowhead-error" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" class="error"/></marker>
                            <marker id="arrowhead-smart" markerWidth="10" markerHeight="7" refX="8" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" class="smart"/></marker>
                        </defs>
                    </svg>
                    <div class="component pod"><div class="icon">üì¶</div><div>Pod Client</div></div>
                    <div class="component coredns"><div class="icon">‚öôÔ∏è</div><div>CoreDNS</div></div>
                    <div class="component external-dns"><div class="icon">üåê</div><div>External DNS</div></div>
                </div>
            </section>
            <section class="terminal-panel">
                <header class="terminal-header">DNS Resolution Log</header>
                <div class="terminal-content" id="terminal-content"></div>
            </section>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. STATE MANAGEMENT ---
        const appState = {
            isAutopath: false,
            isResolving: false,
            domain: 'google.com',
            log: [],
        };

        // --- 2. DOM ELEMENTS ---
        const elements = {
            btnDefault: document.getElementById('btn-default'),
            btnAutopath: document.getElementById('btn-autopath'),
            btnResolve: document.getElementById('btn-resolve'),
            domainInput: document.getElementById('domain-input'),
            terminalContent: document.getElementById('terminal-content'),
            diagramContainer: document.getElementById('diagram-container'),
            pod: document.querySelector('.pod'),
            coredns: document.querySelector('.coredns'),
            externalDns: document.querySelector('.external-dns'),
        };

        // --- 3. RENDER LOGIC (Single source of truth for UI updates) ---
        const render = () => {
            elements.btnDefault.classList.toggle('active', !appState.isAutopath);
            elements.btnAutopath.classList.toggle('active', appState.isAutopath);
            elements.btnResolve.disabled = appState.isResolving;
            elements.btnResolve.textContent = appState.isResolving ? 'Resolving...' : 'Resolve DNS';

            elements.terminalContent.innerHTML = '';
            appState.log.forEach(line => {
                const el = document.createElement('div');
                el.className = `terminal-line`;
                el.innerHTML = `<span class="${line.type}">${line.text}</span>`;
                elements.terminalContent.appendChild(el);
            });
            elements.terminalContent.scrollTop = elements.terminalContent.scrollHeight;
        };

        // --- 4. SIMULATION & ANIMATION LOGIC ---
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        const drawArrow = (fromEl, toEl, type, text) => {
            const containerRect = elements.diagramContainer.getBoundingClientRect();
            const fromRect = fromEl.getBoundingClientRect();
            const toRect = toEl.getBoundingClientRect();

            // Calculate positions ensuring arrow doesn't overlap the element itself
            const angle = Math.atan2(toRect.top - fromRect.top, toRect.left - fromRect.left);
            const startX = fromRect.left + fromRect.width / 2 - containerRect.left + Math.cos(angle) * 50;
            const startY = fromRect.top + fromRect.height / 2 - containerRect.top + Math.sin(angle) * 50;
            const endX = toRect.left + toRect.width / 2 - containerRect.left - Math.cos(angle) * 60;
            const endY = toRect.top + toRect.height / 2 - containerRect.top - Math.sin(angle) * 60;
            
            const arrowId = `arrow-${Date.now()}`;
            const arrowHTML = `
                <svg id="${arrowId}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0;">
                    <path d="M ${startX} ${startY} L ${endX} ${endY}" class="arrow-path ${type}" marker-end="url(#arrowhead-${type})"></path>
                    <text x="${(startX + endX) / 2}" y="${(startY + endY) / 2 - 10}" class="arrow-text ${type}">${text}</text>
                </svg>
            `;
            elements.diagramContainer.insertAdjacentHTML('beforeend', arrowHTML);
            
            const arrowEl = document.getElementById(arrowId);
            setTimeout(() => arrowEl.style.opacity = 1, 50); // Fade in
            return arrowEl;
        };
        
        const typeCommand = async (text) => {
            const line = document.createElement('div');
            line.className = 'terminal-line';
            line.innerHTML = `<span class="prompt">$ </span><span class="command"></span>`;
            elements.terminalContent.appendChild(line);
            const commandEl = line.querySelector('.command');
            for (let i = 0; i < text.length; i++) {
                commandEl.textContent += text[i];
                await sleep(25);
            }
        };

        const simulateQuery = async (query, { type, latency }) => {
            await typeCommand(`dig ${query}`);
            const arrow = drawArrow(elements.pod, elements.coredns, type, 'Query');
            await sleep(latency);
            appState.log.push({ text: type === 'success' ? `‚úÖ SUCCESS (${latency}ms)` : `‚ùå NXDOMAIN (${latency}ms)`, type: `output ${type}` });
            render();
            arrow.style.opacity = 0;
            setTimeout(() => arrow.remove(), 300);
        };
        
        const runSimulation = async () => {
            appState.isResolving = true;
            appState.log = [{ text: `Resolving '${appState.domain}' with ${appState.isAutopath ? 'Autopath' : 'Default'}...`, type: 'output info' }];
            render();

            const isExternal = appState.domain.includes('.');
            const searchDomains = [`${appState.domain}.default.svc.cluster.local`, `${appState.domain}.svc.cluster.local`, appState.domain];

            if (appState.isAutopath && isExternal) {
                await typeCommand(`dig ${searchDomains[0]}`);
                const arrow1 = drawArrow(elements.pod, elements.coredns, 'smart', 'Smart Query');
                await sleep(500);
                appState.log.push({ text: `üß† Autopath CNAME response received!`, type: 'output info' });
                render();
                const arrow2 = drawArrow(elements.coredns, elements.externalDns, 'success', 'External Lookup');
                await sleep(800);
                appState.log.push({ text: `‚úÖ SUCCESS (800ms)`, type: 'output success' });
                render();
                [arrow1, arrow2].forEach(a => a.style.opacity = 0);
                setTimeout(() => [arrow1, arrow2].forEach(a => a.remove()), 300);

            } else { // Default mode or internal domain
                for (let i = 0; i < searchDomains.length; i++) {
                    const isLast = i === searchDomains.length - 1;
                    const shouldSucceed = isLast || (!isExternal && i === 0);
                    await simulateQuery(searchDomains[i], { type: shouldSucceed ? 'success' : 'error', latency: 800 });
                    if (shouldSucceed) break;
                }
            }

            appState.isResolving = false;
            render();
        };

        // --- 5. EVENT HANDLERS & INITIALIZATION ---
        elements.btnDefault.addEventListener('click', () => { appState.isAutopath = false; render(); });
        elements.btnAutopath.addEventListener('click', () => { appState.isAutopath = true; render(); });
        elements.btnResolve.addEventListener('click', () => {
            appState.domain = elements.domainInput.value.trim() || 'google.com';
            runSimulation();
        });
        
        appState.log.push({ text: 'Demo initialized. Click "Resolve DNS" to start.', type: 'output info' });
        render();
    });
    </script>
</body>
</html>
